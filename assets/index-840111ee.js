import{j as o,a as Y,u as je,F as Et}from"./@emotion-63839449.js";import{r as w}from"./react-4fd50329.js";import{B as Xe}from"./index-881eef42.js";import{a3 as kt,l as e,ed as Zt,a8 as ot,ee as jt,ef as ea,I as ge,dq as ta,a5 as Ge,dP as aa,bG as oa,Y as na,a as Pt,cP as $e,c6 as fe,bH as ra,bI as ia,b5 as sa,S as bt,cf as ca,eg as te,eh as nt,ch as la,ci as da,cj as ua,ck as pa,cl as ma,dk as ga,E as xt,s as me,by as ha,K as pe,ei as _t,b0 as fa,av as ya,at as va,bv as Ta,cd as At,b1 as Ca}from"./index-c2ded735.js";import"./lodash-88fe09e6.js";import{h as f}from"./moment-a468e1f9.js";import"./file-saver-40cf32a9.js";import{E as _a,c as Dt,L as Aa,S as Sa}from"./exportContract-a49a1d75.js";import"./react-redux-896b353b.js";import{u as Ia}from"./useTableCheckbox-753d19b2.js";import{u as wa}from"./useService-37d60dc0.js";import"./@firebase-43527ee1.js";import{c as Fa,f as Nt,i as Ea,a as ka,u as Pa,g as Ot,h as ba,j as xa,b as Da}from"./contract-2ad66738.js";import{u as ye,F as H}from"./index-687ba9e6.js";import{P as a}from"./prop-types-1172f4d5.js";import{P as it,o as St,T as st,a as ve,n as Je,l as R,D as xe,p as Ue,q as Be,k as Na,d as Oa,N as It}from"./index-b17d22e5.js";import{B as Ve,D as Ra,g as He,w as Ze,n as Rt,b as J,R as ct,S as La,P as Ua,T as wt}from"./antd-f9eae174.js";import{I as he,S as ae}from"./index-43183512.js";import{I as Ba}from"./index-0335a746.js";import{c as Me}from"./convertDateToString-bb9b15fa.js";import{e as Lt}from"./exportExcel-837be6ed.js";import{R as Ft}from"./regex-deefadac.js";import{u as Ut}from"./react-router-a4308f7b.js";import"./hoist-non-react-statics-23d96a9a.js";import"./react-is-e8e5dbb3.js";import"./@babel-b64fd0f9.js";import"./stylis-79144faa.js";import"./classnames-4ba1ba1a.js";import"./redux-10bbab4c.js";import"./react-router-dom-2a8f5f6d.js";import"./history-a1882333.js";import"./resolve-pathname-e210f2ac.js";import"./tiny-invariant-dd7d57d2.js";import"./react-dom-40621ea0.js";import"./scheduler-765c72db.js";import"./@redux-saga-8bafe09b.js";import"./redux-logger-e1c9ca90.js";import"./dompurify-8e338605.js";import"./query-string-f5cca1e7.js";import"./decode-uri-component-4138e85d.js";import"./split-on-first-4f1167c8.js";import"./filter-obj-2ed190f4.js";import"./oidc-client-7da0eaf7.js";import"./firebase-878887a2.js";import"./rc-pagination-c1e6a0ac.js";import"./rc-picker-2e3d5fe5.js";import"./rc-util-0bc219f3.js";import"./rc-trigger-570b13ec.js";import"./rc-motion-ae889c42.js";import"./rc-align-e5d7b12e.js";import"./dom-align-ecb06dd6.js";import"./resize-observer-polyfill-0f9f8adb.js";import"./rc-resize-observer-b9ad4e29.js";import"./@ant-design-cba9d434.js";import"./@ctrl-fb5a5473.js";import"./rc-tabs-dfd19a56.js";import"./rc-dropdown-5378dd0a.js";import"./rc-menu-b15ebfe9.js";import"./rc-overflow-6be96612.js";import"./rc-select-564caf01.js";import"./rc-virtual-list-8a7b82a6.js";import"./rc-collapse-11b7d3c4.js";import"./shallowequal-4542d6f7.js";import"./rc-drawer-317f0b4d.js";import"./@rc-component-5a112e55.js";import"./rc-field-form-ef5549aa.js";import"./async-validator-dee29e8b.js";import"./scroll-into-view-if-needed-6b992d05.js";import"./compute-scroll-into-view-183f845a.js";import"./rc-image-e0357917.js";import"./rc-dialog-b1d1f07b.js";import"./rc-input-number-8bc068f7.js";import"./rc-rate-c64cf0d5.js";import"./rc-steps-2d1924c7.js";import"./rc-switch-b4e96de7.js";import"./rc-table-191ecc42.js";import"./rc-checkbox-018e8052.js";import"./rc-tree-67773537.js";import"./rc-tree-select-cb7eccc3.js";import"./copy-to-clipboard-64585c8c.js";import"./toggle-selection-93f4ad84.js";import"./rc-textarea-d01adcbb.js";import"./rc-input-02c2c2ba.js";import"./rc-upload-3ab0f08a.js";import"./rc-notification-d13dc43b.js";import"./rc-progress-4f1a7096.js";import"./rc-tooltip-08fa4217.js";import"./use-sync-external-store-5d1b6592.js";import"./idb-cdd1a92f.js";import"./path-to-regexp-ef8d5544.js";import"./account-86ffff50.js";import"./libphonenumber-js-0d5a9c92.js";import"./react-infinite-scroll-component-e33646cb.js";import"./downloadFileFromUrl-79614833.js";import"./uuid-4a60fe23.js";import"./xlsx-0fb7ed70.js";const We="ACTIVE",Qe="INACTIVE",rt="DELETE",lt=({onSelectAction:C,isDisabledActive:l,isDisabledInactive:m})=>o(Xe,{children:Y(He,{selectable:!1,onClick:C,children:[o(He.Item,{disabled:l,children:e.activate},We),o(He.Item,{disabled:m,children:e.deactivate},Qe),o(He.Item,{children:e.delete},rt)]})});lt.propTypes={onSelectAction:a.func,isDisabledActive:a.bool,isDisabledInactive:a.bool};lt.defaultProps={onSelectAction:()=>{},isDisabledActive:!1,isDisabledInactive:!1};const dt=({idBuilding:C,service:l,filterObj:m,tableSelection:r,refreshContracts:d,selectAllRowComponent:n,showFormAddContract:_,showFormImportContract:u,showFormExportContract:A,servicePermissionExport:S,servicePermissionWrite:c,showFormInactiveContract:s})=>{const v=w.useMemo(()=>{const{registerDate:i,apartment:M,contractTemplateId:$,registrationPlate:Q,status:h,dayStartedUsing:N,dayStoppedUsing:k,registrationPlateRaw:P}=m,[re,le]=i!=null&&i.length?[f(i[0]).startOf("day").toDate(),f(i[1]).endOf("day").toDate()]:[void 0,void 0],Te=N?f(N).toDate():void 0,Ce=k?f(k).toDate():void 0,_e=l==null?void 0:l.id,Ae=l==null?void 0:l.serviceType;return{serviceId:_e,serviceType:Ae,unitName:M,unitGroupId:C,contractTemplateId:$!==""?$:void 0,createFrom:re,createTo:le,deActiveAt:Ce,from:Te,registrationPlate:Q,status:h!==""?h:void 0,registrationPlateRaw:P}},[l,m]),[t,g]=w.useState({isFetching:!1,code:void 0,codeLanguage:void 0}),[p,L]=w.useState({isFetching:!1,code:void 0,codeLanguage:void 0}),[y]=na(),I=kt();ye(t.code,t.codeLanguage,{message:e.success,description:e.activate_vehicle_success},()=>{d()}),ye(p.code,p.codeLanguage,{message:e.success,description:e.delete_data_success},()=>{d()});const b=()=>{A()},x=()=>{u()},G=()=>{const{isSelectAllItem:i,selectedRowKeysCache:M,byId:$}=r,Q=M.map(h=>$==null?void 0:$[h]).filter(h=>(h==null?void 0:h.typeRow)==="CONTRACT");St({isAll:i,onCancel:()=>{g({code:void 0,codeLanguage:void 0})},onOk:async()=>{g({code:void 0,codeLanguage:void 0});try{const h=await Fa({filter:v,idContracts:i?[]:Q.map(N=>N.id),idBuilding:C,isAll:i});if(g({code:h.code}),h.code===200)return Promise.resolve()}catch(h){g({code:h.code,codeLanguage:h.codeLanguage})}return Promise.reject()},questionText:e.do_you_want_to_activate_vehicle,totalItem:Q.length})},O=()=>{const{isSelectAllItem:i,selectedRowKeysCache:M,byId:$}=r,Q=M.map(h=>$==null?void 0:$[h]).filter(h=>(h==null?void 0:h.typeRow)==="CONTRACT");St({isAll:i,onCancel:()=>{L({code:void 0,codeLanguage:void 0})},onOk:async()=>{L({code:void 0,codeLanguage:void 0});try{const h=await Nt({filter:v,idContracts:i?[]:Q.map(N=>N.id),idBuilding:C,idService:l.id,isAll:i});if(L({code:h.code}),h.code===200)return Promise.resolve()}catch(h){L({code:h.code,codeLanguage:h.codeLanguage})}return Promise.reject()},questionText:e.do_you_want_to_delete_vehicle,totalItem:Q.length})},D=({key:i})=>{i===We?G():i===Qe?s():i===rt&&O()},z=()=>{_()},j=()=>n({totalItemSelected:r.selectedRowKeysCache.map(i=>{var M;return(M=r.byId)==null?void 0:M[i]}).filter(i=>(i==null?void 0:i.typeRow)==="APARTMENT").length,textSelectRow:e.you_selected_rows,textSelectAllRow:e.select_all_rows}),Z=!r.isSelectAllItem&&r.selectedRowKeysCache.length===0,X=[c?o(Ra,{disabled:Z,dropdownRender:()=>o(lt,{onSelectAction:({key:i})=>{i===We?I({action:Zt,label:ot}):i===Qe?I({action:jt,label:ot}):i===rt&&I({action:ea,label:ot}),D({key:i})},isDisabledActive:m.status===We,isDisabledInactive:m.status===Qe}),children:Y(Ve,{style:{marginRight:y.marginSm},loading:t.isFetching||p.isFetching,disabled:t.isFetching||p.isFetching,type:"primary",children:[o("span",{children:e.action}),o(ge,{name:"icon-arrow-down-outlined"})]})},"action"):null,S?o(Ve,{style:{marginRight:y.marginSm},type:"primary",ghost:!0,onClick:()=>{I({action:ta,label:Ge}),b()},icon:o(ge,{name:"icon-download-outlined"}),children:e.export},"export"):null,c?o(Ve,{style:{marginRight:y.marginSm},type:"primary",icon:o(ge,{name:"icon-upload-outlined"}),onClick:()=>{I({action:aa,label:Ge}),x()},children:e.import},"import"):null,c?o(Ve,{type:"primary",icon:o(ge,{name:"icon-plus-circle-outlined"}),onClick:()=>{I({action:oa,label:Ge}),z()},children:e.add},"add"):null].filter(Boolean);return o(it.ActionBox,{actions:X,total:j()})};dt.propTypes={idBuilding:a.oneOfType([a.number,a.string]),filterObj:a.objectOf(a.any),service:a.objectOf(a.any),tableSelection:a.objectOf(a.any),refreshContracts:a.func,selectAllRowComponent:a.func,showFormAddContract:a.func,showFormImportContract:a.func,showFormExportContract:a.func,servicePermissionExport:a.bool,servicePermissionWrite:a.bool,showFormInactiveContract:a.func};dt.defaultProps={idBuilding:0,filterObj:void 0,service:void 0,tableSelection:void 0,refreshContracts:()=>{},selectAllRowComponent:()=>{},showFormAddContract:()=>{},showFormImportContract:()=>{},showFormExportContract:()=>{},servicePermissionExport:!1,servicePermissionWrite:!1,showFormInactiveContract:()=>{}};const ut=({loading:C,idBuilding:l,service:m,totalPayment:r,totalItem:d,tablePage:n,tablePageSize:_,selectedRowKeys:u,dataSource:A,reloadContracts:S,handleTablePageChange:c,onSelectRow:s,onSelectAllRowOfPage:v,showFormUpdateContract:t,showFormDetailContractTemplate:g,servicePermissionWrite:p,onExpand:L,expandedKeys:y,showFormContractLogs:I})=>{const b=kt(),{layoutScrollRef:x}=w.useContext(Pt),G=je(),[O,D]=w.useState({code:void 0,codeLanguage:void 0});ye(O.code,O.codeLanguage,{message:e.success,description:e.delete_data_success});const z=(N,k)=>{c(N,k)},j=N=>{g({contractTemplate:N})},Z=N=>{I({...N})},X=(N,k,P)=>{N.cardId?Rt.error({message:e.error1,description:sa.CONTRACT_CARD_ID_EXISTED}):t({contract:N,apartment:{id:k,name:P}})},i=N=>{ve.confirm({cancelText:e.cancel,okText:e.confirm,title:e.confirm,content:`${e.do_you_want_to_delete_this_vehicle}?`,onOk:async()=>{D({code:void 0,codeLanguage:void 0});try{const k=await Nt({idBuilding:l,idContracts:[N.id],idService:m.id,isAll:!1});if(D({code:k.code}),bt.includes(k.code))return await S(),Promise.resolve()}catch(k){D({code:k.code,codeLanguage:k.codeLanguage})}return Promise.reject()},afterClose:()=>{D({code:void 0,codeLanguage:void 0})}})},M=w.useMemo(()=>{var N;return[{title:`${e.unit} / ${e.registration_plate}`,key:"apartment",width:150,children:[{title:e.total,key:"apartment",dataIndex:"apartment",fixed:"left",width:150}]},{title:e.tariff,key:"contractTemplate",width:250,children:[{title:"",key:"contractTemplate",dataIndex:"contractTemplate",width:250,ellipsis:!0,render:(k,P)=>k?o(Ve,{type:"link",style:{padding:0},onClick:()=>{var re;return j((re=P==null?void 0:P.contract)==null?void 0:re.contractTemplate)},children:k}):""}]},{title:e.status1,key:"status",width:150,children:[{title:"",key:"status",dataIndex:"status",width:150,render:(k,P)=>k&&(P.status===$e?o(Ze,{color:"success",children:e.active}):o(Ze,{color:"error",children:e.inactive}))||""}]},{title:e.paid_until_at,key:"paidUntilAt",width:150,children:[{title:"",key:"paidUntilAt",dataIndex:"paidUntilAt",width:150}]},{title:e.register_date,key:"registerDate",width:150,children:[{title:"",key:"registerDate",dataIndex:"registerDate",width:150}]},{title:e.day_of_using,key:"dayOfUsing",width:200,children:[{title:"",key:"dayOfUsing",dataIndex:"dayOfUsing",width:200}]},{title:e.registration_plate_raw,key:"registrationPlateRaw",width:150,children:[{title:"",key:"registrationPlateRaw",dataIndex:"registrationPlateRaw",width:150}]},...((N=m==null?void 0:m.requiredInfo)==null?void 0:N.map(k=>k.key!=="registration_plate"?{title:e[k.key],key:k.key,width:150,children:[{title:"",key:k.key,dataIndex:k.key,width:150}]}:null))??[],{title:e.amount,key:"amount",width:100,align:"right",fixed:"right",children:[{title:fe(r.totalNumberUse),key:"amount",dataIndex:"amount",width:100,align:"right",fixed:"right"}]},{title:e.total_payment,key:"totalPayment",align:"right",fixed:"right",width:150,children:[{title:fe(Math.round(r.totalPayment)),key:"totalPayment",dataIndex:"totalPayment",align:"right",fixed:"right",width:150}]},p?{title:e.actions,key:"actions",dataIndex:"actions",align:"center",fixed:"right",width:120,render:(k,P)=>P.contract?Y(Et,{children:[o(ge,{title:e.history,style:{fontSize:G.iconSize,marginRight:G.margin.xs},name:"icon-history-filled",onClick:()=>Z(P)}),o(ge,{title:e.update,style:{marginRight:G.margin.xs,fontSize:G.iconSize},name:"icon-edit-outlined",onClick:()=>{b({action:ra,label:Ge}),X(P==null?void 0:P.contract,P==null?void 0:P.apartmentId,P==null?void 0:P.apartmentName)}}),o(ge,{title:e.delete,style:{fontSize:G.iconSize},name:"icon-minus-circle-outlined",onClick:()=>{b({action:ia,label:Ge}),i(P==null?void 0:P.contract,P==null?void 0:P.apartmentId)}})]}):null}:null].filter(Boolean)},[m,r]),$={pageSize:_,defaultCurrent:1,current:n,total:d,showQuickJumper:!0,showSizeChanger:!0,onChange:z},Q={x:M.reduce((N,k)=>N+ +k.width,0)},h={selectedRowKeys:u,onSelect:s,onSelectAll:v,fixed:!0};return o(st,{loading:C,columns:M,dataSource:A,pagination:$,scroll:Q,sticky:{offsetScroll:G.offsetScrollX,getContainer:()=>x.current},rowSelection:h,bordered:!0,onExpand:L,expandedRowKeys:y,expandable:{defaultExpandAllRows:!0}})};ut.propTypes={loading:a.bool,idBuilding:a.oneOfType([a.number,a.string]),service:a.objectOf(a.any),totalPayment:a.objectOf(a.any),totalItem:a.number,tablePage:a.number,tablePageSize:a.number,selectedRowKeys:a.arrayOf(a.any),dataSource:a.arrayOf(a.any),reloadContracts:a.func,handleTablePageChange:a.func,onSelectRow:a.func,onSelectAllRowOfPage:a.func,showFormUpdateContract:a.func,showFormDetailContractTemplate:a.func,servicePermissionWrite:a.bool,onExpand:a.func,expandedKeys:a.arrayOf(a.any),showFormContractLogs:a.func};ut.defaultProps={loading:!1,idBuilding:0,service:void 0,totalPayment:void 0,totalItem:0,tablePage:0,tablePageSize:0,selectedRowKeys:[],dataSource:[],reloadContracts:()=>{},handleTablePageChange:()=>{},onSelectRow:()=>{},onSelectAllRowOfPage:()=>{},showFormUpdateContract:()=>{},showFormDetailContractTemplate:()=>{},servicePermissionWrite:!1,onExpand:[],expandedKeys:()=>{},showFormContractLogs:()=>{}};const pt=({handleFilterChange:C,contractTemplates:l,formFilter:m})=>{const r=n=>{C({...n})},d=w.useMemo(()=>[{label:e.unit,key:"apartment",component:o(he,{placeholder:e.unit}),visible:!0},{label:e.tariff,key:"contractTemplateId",component:Y(ae,{fluid:"true",placeholder:e.tariff,getPopupContainer:n=>n.parentNode,showSearch:!0,optionFilterProp:"children",filterOption:(n,_)=>Je(_.children).indexOf(Je(n))>=0,children:[o(ae.Option,{value:"",children:e.all_tariff},"tariff_0"),l==null?void 0:l.map(({id:n,name:_,value:u})=>o(ae.Option,{value:u,children:_},n))]}),visible:!0},{label:e.registration_plate,key:"registrationPlate",component:o(he,{placeholder:e.registration_plate}),visible:!0},{label:e.registration_plate_raw,key:"registrationPlateRaw",component:o(he,{placeholder:e.registration_plate_raw}),visible:!0},{label:e.register_date,key:"registerDate",component:o(xe.RangePicker,{fluid:"true",format:[R,R],placeholder:[R,R],getPopupContainer:n=>n.parentNode}),visible:!0},{label:e.day_started_using,key:"dayStartedUsing",component:o(xe,{fluid:"true",format:R,placeholder:R,getPopupContainer:n=>n.parentNode}),visible:!0},{label:e.day_stopped_using,key:"dayStoppedUsing",component:o(xe,{fluid:"true",format:R,placeholder:R,getPopupContainer:n=>n.parentNode}),visible:!0},{label:e.status1,key:"status",component:Y(ae,{fluid:"true",getPopupContainer:n=>n.parentNode,children:[o(ae.Option,{value:"",children:e.all_status}),o(ae.Option,{value:$e,children:e.active}),o(ae.Option,{value:ca,children:e.inactive})]}),visible:!0},{label:e.card_number,key:"card",component:o(he,{placeholder:e.card_number}),visible:!0}],[l]);return o(it.FilterBox,{formData:m,defaultFilter:{...te},onSearch:r,layout:"vertical",filters:d})};pt.propTypes={handleFilterChange:a.func,contractTemplates:a.arrayOf(a.any),formFilter:a.objectOf(a.any)};pt.defaultProps={handleFilterChange:()=>{},contractTemplates:[],formFilter:void 0};const mt=C=>{var s;const{idBuilding:l,onHide:m,refreshContracts:r,service:d,contractTemplates:n}=C,_=[{name:"#",rules:{type:"number",required:!0}},{name:"Căn hộ",rules:{type:"string",required:!0,max:255}},{name:"Biểu phí",rules:n!=null&&n.length?{required:!0,type:"enum",enum:n.map(({name:v})=>v)}:{type:"string",required:!0,max:255}},{name:"Ngày đăng ký",rules:{type:"string",validator(v,t,g,p,L){if(t==null||t==="")return new Error(e.status.data_require);const y=new RegExp(Ft);return t&&!y.test(t)?new Error(`${e.status.date_invalid} (${e.label.valid}: ${R})`):t&&p["Ngày bắt đầu sử dụng"]&&f(t,R).isAfter(f(p["Ngày bắt đầu sử dụng"],R))?new Error(e.register_date_must_lower_or_equal_than_day_started_using):!0}}},{name:"Ngày bắt đầu sử dụng",rules:{type:"string",validator(v,t,g,p,L){if(t==null||t==="")return new Error(e.status.data_require);const y=new RegExp(Ft);return t&&!y.test(t)?new Error(`${e.status.date_invalid} (${e.label.valid}: ${R})`):t&&p["Ngày đăng ký"]&&f(t,R).isBefore(f(p["Ngày đăng ký"],R))?new Error(e.register_date_must_lower_or_equal_than_day_started_using):!0}}},{name:"Trạng thái sử dụng",rules:{required:!0,type:"enum",enum:["Đang hoạt động","Ngừng hoạt động"]}},{name:"Số lượng",rules:{type:"number",required:!0,max:50}},...(s=d==null?void 0:d.requiredInfo)==null?void 0:s.map(v=>({name:v.name,rules:{type:"string",max:255}}))],[u,A]=w.useState({isFetching:!1,code:void 0,codeLanguage:void 0,success:0,failed:0,errors:[],data:void 0});ye(u.code,u.codeLanguage,{message:e.success,description:e.import_data_success});const S=async v=>{var t,g,p,L;A({isFetching:!0,code:void 0,codeLanguage:void 0,success:0,failed:0,errors:[],data:void 0});try{const y=await Ea({idBuilding:l,file:v,dataAttach:{createdFor:f().format("YYYYMM"),identifier:nt,serviceId:d==null?void 0:d.id}}),I=((g=(t=y==null?void 0:y.data)==null?void 0:t.errors)==null?void 0:g.map(b=>({index:b==null?void 0:b.index,code:(b==null?void 0:b.code)??500,message:b.message})))??[];A({isFetching:!1,code:y.code,codeLanguage:y.codeLanguage,success:((p=y==null?void 0:y.data)==null?void 0:p.success)??0,failed:I.length,errors:I,data:((L=y==null?void 0:y.data)==null?void 0:L.data)??void 0}),bt.includes(y.code)&&I.length===0&&await r()}catch(y){A({isFetching:!1,code:y.code,codeLanguage:y.codeLanguage,success:0,failed:0,errors:[],data:void 0})}};function c(){var I,b;const v=["#","Căn hộ","Biểu phí","Ngày đăng ký","Ngày bắt đầu sử dụng","Trạng thái sử dụng","Số lượng",...(I=d==null?void 0:d.requiredInfo)==null?void 0:I.map(x=>x.name)],t=n.length>0?n[0].name:"",g=(b=d==null?void 0:d.requiredInfo)==null?void 0:b.map(x=>x.type==="DATE"?Me(new Date):x.type==="TEXT"?x.name:x.type==="NUMBER"?0:""),p=[1,101,t,Me(new Date),Me(new Date),e.active,1,...g],L=[2,102,t,Me(new Date),Me(new Date),e.inactive,1,...g];Lt([v,p,L],"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8","mau-thong-tin-dich-vu-gui-xe",".xlsx")}return o(Ba,{headers:_,onClose:m,onOk:S,visible:!0,code:u.code,codeLanguage:u.codeLanguage,loading:u.isFetching,numberSuccess:u.success,numberFail:u.failed,problemResponseServerDataSource:u.errors,errorFile:u.data,onDownloadTemplateFile:c})};mt.propTypes={idBuilding:a.oneOfType([a.number,a.string]),onHide:a.func,refreshContracts:a.func,service:a.objectOf(a.any),contractTemplates:a.arrayOf(a.any)};mt.defaultProps={idBuilding:0,onHide:()=>{},refreshContracts:()=>{},service:void 0,contractTemplates:[]};const gt=({contractTemplate:C,hideModal:l})=>{const m=je(),{formula:r,surcharges:d,promotions:n}=C,_=[],u=[],A=[];if(r){const{formulaType:S,formula:c}=r;if(S===la)_.push({formula:c.name||e.formula,price:fe(c.price)});else if(S===da)for(let s=0;s<c.length;s+=1)_.push({formula:`${c[s].from}${c[s].to?` - ${c[s].to}`:""}`,price:fe(c[s].price)});else if(S===ua)for(let s=0;s<c.length;s+=1)_.push({formula:c[s].name,price:fe(c[s].price)})}if(d!=null&&d.length)for(let S=0;S<d.length;S+=1)u.push({formula:d[S].name,price:`${d[S].price} ${d[S].type===pa?"(%)":""}`});return n!=null&&n.length&&A.push({formula:n[0].name,price:`${n[0].price} (%)`}),o(ve,{title:e.detail_tariff,footer:!1,onCancel:l,open:!0,children:Y(ct,{gutter:[m.margin.sm,m.margin.sm],children:[Y(J,{span:"12",children:[o(Ue,{children:e.tariff}),o(Be,{children:C.name||"-"})]}),Y(J,{span:"12",children:[o(Ue,{children:e.english_name}),o(Be,{children:C.enName||"-"})]}),Y(J,{span:"12",children:[o(Ue,{children:e.deferred_interest}),o(Be,{children:C.deferredInterest||"-"})]}),Y(J,{span:"12",children:[o(Ue,{children:e.pay_time}),o(Be,{children:C.payTime||"-"})]}),r&&Y(J,{span:"24",children:[o(Ue,{children:e.formula}),Y(Be,{children:[r.name," - ",ma[r.formulaType].label]}),o(st,{bordered:!0,size:"small",pagination:!1,columns:[{title:e.formula,key:"formula",dataIndex:"formula"},{title:e.price,key:"price",dataIndex:"price"}],dataSource:_})]})||null]})})};gt.propTypes={hideModal:a.func,contractTemplate:a.objectOf(a.any)};gt.defaultProps={hideModal:()=>{},contractTemplate:{}};const et=({contractTemplates:C,requiredInfo:l,idBuilding:m,apartments:r})=>{const d=je(),[n,_]=w.useState({isFetching:!1}),[u,A]=w.useState(r),S=async(c,s)=>{s||A([]),_({isFetching:!0});const v=await ga({idBuilding:m,page:1,limit:50,filter:{name:c||void 0}});A((v==null?void 0:v.data)??[]),_({isFetching:!1})};return w.useEffect(()=>{S(void 0,!0)},[]),Y(ct,{gutter:[d.margin.sm,0],children:[o(J,{span:"12",children:o(H.Item,{rules:[{required:!0}],name:"contractTemplate",label:e.tariff,children:o(ae,{fluid:!0,placeholder:e.tariff,getPopupContainer:c=>c.parentNode,showSearch:!0,optionFilterProp:"children",filterOption:(c,s)=>Je(s.children).indexOf(Je(c))>=0,children:C==null?void 0:C.map(({id:c,name:s})=>o(ae.Option,{value:c,children:s},c))})})}),o(J,{span:"12",children:o(H.Item,{rules:[{required:!0}],name:"totalNumberUse",label:e.amount,children:o(Na,{min:"0",disabled:!0})})}),o(J,{span:"24",children:o(H.Item,{rules:[{required:!0}],name:"apartment",label:e.unit,children:o(ae,{showSearch:!0,filterOption:!1,onSearch:Oa(S),loading:n.isFetching,fluid:!0,placeholder:e.unit,notFoundContent:n.isFetching?o(La,{size:"small"}):null,children:u==null?void 0:u.map(({id:c,name:s})=>o(ae.Option,{value:c,children:s},c))})})}),o(J,{span:"12",children:o(H.Item,{dependencies:["dayStartedUsing"],rules:[{required:!0},({getFieldValue:c})=>({validator(s,v){return v&&c("dayStartedUsing")&&f(v).isAfter(c("dayStartedUsing"))?Promise.reject(e.register_date_must_lower_or_equal_than_day_started_using):Promise.resolve()}})],name:"registerDate",label:e.register_date,children:o(xe,{fluid:!0,format:R,placeholder:R})})}),o(J,{span:"12",children:o(H.Item,{dependencies:["registerDate"],rules:[{required:!0},({getFieldValue:c})=>({validator(s,v){return v&&c("registerDate")&&f(v).isBefore(c("registerDate"))?Promise.reject(e.register_date_must_lower_or_equal_than_day_started_using):Promise.resolve()}})],name:"dayStartedUsing",label:e.day_started_using,children:o(xe,{fluid:!0,format:R,placeholder:R})})}),o(H.Item,{noStyle:!0,shouldUpdate:(c,s)=>c.contractTemplate!==s.contractTemplate,children:({getFieldValue:c})=>{const s=c("contractTemplate");return C.find(t=>t.id===s&&t.parkingType==="BICYCLE")?l==null?void 0:l.map((t,g)=>o(J,{span:"12",children:o(H.Item,{name:t.key,label:e[t.key],children:o(he,{placeholder:e[t.key]})})},g)):l==null?void 0:l.map((t,g)=>t.key==="registration_plate"?o(J,{span:"12",children:o(H.Item,{rules:[{required:!0}],name:t.key,label:e[t.key],children:o(he,{placeholder:e[t.key]})})},g):o(J,{span:"12",children:o(H.Item,{name:t.key,label:e[t.key],children:o(he,{placeholder:e[t.key]})})},g))}})]})};et.propTypes={contractTemplates:a.arrayOf(a.any),requiredInfo:a.arrayOf(a.any),idBuilding:a.oneOfType([a.number,a.string]),apartments:a.arrayOf(a.any)};et.defaultProps={contractTemplates:[],requiredInfo:[],idBuilding:0,apartments:[]};const ht=({idBuilding:C,contractTemplates:l,requiredInfo:m,refreshContracts:r,onHide:d})=>{const[n]=H.useForm(),[_,u]=w.useState({isFetching:!1,code:void 0,codeLanguage:void 0});ye(_.code,_.codeLanguage,{message:e.success,description:e.add_data_success},()=>{r(),d()});const A=async()=>{if(n.setFieldsValue({...xt(n.getFieldsValue(),{})}),await n.validateFields()){u({isFetching:!0,code:void 0,codeLanguage:void 0});const s=f(n.getFieldValue("registerDate")).startOf("day").toDate(),v=f(n.getFieldValue("dayStartedUsing")).startOf("day").toDate(),t=f(s).format("YYYYMM"),g={contractTemplateId:n.getFieldValue("contractTemplate"),createdAt:s,createdFor:Number(t),numberPersonQuota:1,requiredInfo:m==null?void 0:m.map(p=>({...p,value:n.getFieldValue(p.key)})),startDate:v,totalNumberUse:Number(n.getFieldValue("totalNumberUse")),unitId:n.getFieldValue("apartment"),contractTemplate:n.getFieldValue("contractTemplate")};try{const p=await ka({idBuilding:C,contracts:[g]});u({isFetching:!1,code:p.code})}catch(p){throw u({isFetching:!1,code:p.code,codeLanguage:p.codeLanguage}),p}}},S=()=>{d()};return o(ve,{confirmLoading:_.isFetching,okButtonProps:{disabled:_.isFetching},okText:e.confirm,cancelText:e.cancel,onOk:A,onCancel:S,open:!0,title:e.add_vehicle,children:o(H,{initialValues:{contractTemplate:void 0,totalNumberUse:1,apartment:void 0},layout:"vertical",name:"formAdd",form:n,children:o(et,{apartments:[],idBuilding:C,contractTemplates:l,requiredInfo:m})})})};ht.propTypes={idBuilding:a.oneOfType([a.number,a.string]),contractTemplates:a.arrayOf(a.any),requiredInfo:a.arrayOf(a.any),refreshContracts:a.func,onHide:a.func};ht.defaultProps={idBuilding:0,contractTemplates:[],requiredInfo:[],refreshContracts:()=>{},onHide:()=>{}};const ft=({idBuilding:C,apartment:l,contract:m,contractTemplates:r,requiredInfo:d,refreshContracts:n,onHide:_})=>{var v;const[u]=H.useForm(),[A,S]=w.useState({isFetching:!1,code:void 0,codeLanguage:void 0});ye(A.code,A.codeLanguage,{message:e.success,description:e.update_data_success},()=>{n(),_()});const c=async()=>{if(u.setFieldsValue({...xt(u.getFieldsValue(),{})}),await u.validateFields()){S({isFetching:!0,code:void 0,codeLanguage:void 0});const g=f(u.getFieldValue("registerDate")).startOf("day").toDate(),p=f(u.getFieldValue("dayStartedUsing")).startOf("day").toDate(),L=f(g).format("YYYYMM"),y={contractTemplateId:u.getFieldValue("contractTemplate"),createdAt:g,createdFor:Number(L),numberPersonQuota:1,requiredInfo:d.map(I=>({...I,value:u.getFieldValue(I.key)})),startDate:p,totalNumberUse:Number(u.getFieldValue("totalNumberUse")),unitId:u.getFieldValue("apartment"),contractTemplate:u.getFieldValue("contractTemplate")};try{const I=await Pa({idBuilding:C,idContract:m.id,contract:y});S({isFetching:!1,code:I.code})}catch(I){throw S({isFetching:!1,code:I.code,codeLanguage:I.codeLanguage}),I}}},s=()=>{_()};return o(ve,{confirmLoading:A.isFetching,okButtonProps:{disabled:A.isFetching},okText:e.confirm,cancelText:e.cancel,onOk:c,onCancel:s,open:!0,title:e.update_vehicle,children:o(H,{initialValues:{contractTemplate:m.contractTemplateId,registerDate:f(m.createdAt),numberPersonQuota:m.totalNumberUse,registration_plate:m.registrationPlate,...(v=m==null?void 0:m.requiredInfo)==null?void 0:v.reduce((t,g)=>(t[g.key]=g.value,t),{}),dayStartedUsing:f(m.startDate),totalNumberUse:m.totalNumberUse,apartment:l==null?void 0:l.id},layout:"vertical",name:"formUpdate",form:u,children:o(et,{apartments:[{id:l==null?void 0:l.id,name:l==null?void 0:l.name}],idBuilding:C,contractTemplates:r,requiredInfo:d})})})};ft.propTypes={idBuilding:a.oneOfType([a.number,a.string]),apartment:a.objectOf(a.any),contract:a.objectOf(a.any),contractTemplates:a.arrayOf(a.any),requiredInfo:a.arrayOf(a.any),refreshContracts:a.func,onHide:a.func};ft.defaultProps={idBuilding:0,apartment:void 0,contract:void 0,contractTemplates:[],requiredInfo:[],refreshContracts:()=>{},onHide:()=>{}};const Ma=({hideModalExportData:C,filter:l,serviceActive:m,totalItem:r})=>{const{requiredInfo:d=[],id:n,serviceType:_,name:u}=m,{idBuilding:A}=Ut(),[S,c]=w.useState(0);return w.useEffect(()=>{(async()=>{const{registerDate:s,dayStartedUsing:v,dayStoppedUsing:t,apartment:g,contractTemplateId:p,registrationPlate:L,status:y}=l,[I,b]=s!=null&&s.length?[f(s[0]).startOf("day").toDate(),f(s[1]).endOf("day").toDate()]:[void 0,void 0],x=v?f(v).toDate():void 0,G=t?f(t).toDate():void 0,O=d,D=[];let z=1,j=0;const Z=Math.ceil(r/me);for(_a({idBuilding:A,filter:{...l,onlyLogging:!0,serviceName:u}});z<=Z;){c(Math.ceil(z/Z*100));const X=await Ot({idBuilding:A,filter:{serviceId:n,serviceType:_,unitName:g,unitGroupId:A,contractTemplateId:p!==""?p:void 0,createFrom:I,createTo:b,deActiveAt:G,from:x,registrationPlate:L,status:y!==""?y:void 0},page:z,limit:me}),i=X==null?void 0:X.data;if((i==null?void 0:i.length)>0){for(let M=0;M<(i==null?void 0:i.length);M+=1){const $=i==null?void 0:i[M];for(let Q=0;Q<$.contracts.length;Q+=1){const h=$.contracts[Q],{contractTemplate:N,totalNumberUse:k,status:P,paidUntilAt:re,createdAt:le,startDate:Te,deActiveAt:Ce,registrationPlate:_e}=h,{formula:Ae}=N,qe=Dt({formula:Ae.formula,formulaType:Ae.formulaType,norm:1,ratio:1,totalNumberUse:k});h.totalPayment=Math.round(qe);const ee=[j+=1,($==null?void 0:$.name)??"",(N==null?void 0:N.name)??"",le?f(le).format(R):"",Te?f(Te).format(R):"",Ce?f(Ce).format(R):"",P===$e?e.active:e.inactive,k||0,Math.round(qe||0),re||""];O.forEach(Se=>{var Ie,Ye,Ke,De,Ne,ze,we;const U=((Ie=h==null?void 0:h.requiredInfo)==null?void 0:Ie.find(oe=>oe.key===Se.key))??null;if(!U){Se.key==="card"?ee.push(((Ye=h==null?void 0:h.card)==null?void 0:Ye.code)??""):Se.key==="card_owner"?ee.push(((De=(Ke=h==null?void 0:h.card)==null?void 0:Ke.owner)==null?void 0:De.fullName)??""):Se.key==="registration_plate"?ee.push(_e??""):ee.push("");return}(U==null?void 0:U.key)==="card"?ee.push(((Ne=h==null?void 0:h.card)==null?void 0:Ne.code)??(U==null?void 0:U.value)??""):(U==null?void 0:U.key)==="card_owner"?ee.push(((we=(ze=h==null?void 0:h.card)==null?void 0:ze.owner)==null?void 0:we.fullName)??(U==null?void 0:U.value)??""):(U==null?void 0:U.key)==="registration_plate"?ee.push(_e??(U==null?void 0:U.value)??""):ee.push((U==null?void 0:U.value)??"")}),D.push(ee)}}z+=1}else z=0}D.unshift(["#","Căn hộ","Biểu phí","Ngày đăng ký","Ngày bắt đầu sử dụng","Ngày ngưng sử dụng","Trạng thái sử dụng","Số lượng","Thành tiền","Đã thanh toán đến",...O.map(X=>X.name)]),setTimeout(()=>{Lt(D,"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8","thong-tin-dich-vu-gui-xe",".xlsx"),Rt.success({description:e.success,message:e.export_data_success}),C()},3e3)})()},[]),[S]},yt=({hideModalExportData:C,filter:l,serviceActive:m,totalItem:r})=>{const[d]=Ma({hideModalExportData:C,filter:l,serviceActive:m,totalItem:r});return o(ve,{open:!0,closable:!1,footer:!1,children:o(Ua,{strokeColor:{from:"#108ee9",to:"#87d068"},percent:d,status:"active",css:n=>({marginTop:n.margin.xs})})})};yt.propTypes={hideModalExportData:a.func,filter:a.objectOf(a.any),serviceActive:a.objectOf(a.any),totalItem:a.number};yt.defaultProps={hideModalExportData:()=>{},filter:void 0,serviceActive:void 0,totalItem:0};const vt=({idBuilding:C,hideFormInactiveContract:l,tableSelection:m,filterObj:r,service:d,refreshContracts:n})=>{var L;const[_]=H.useForm(),u=je(),[A,S]=w.useState({isFetching:!1,code:void 0,codeLanguage:void 0}),{isSelectAllItem:c,selectedRowKeysCache:s,byId:v}=m,t=(L=s.map(y=>v==null?void 0:v[y]))==null?void 0:L.filter(y=>y.typeRow==="CONTRACT");ye(A.code,A.codeLanguage,{message:e.success,description:e.deactivate_vehicle_success});const g=w.useMemo(()=>{const{registerDate:y,apartment:I,contractTemplateId:b,registrationPlate:x,status:G,dayStartedUsing:O,dayEndedUsing:D,registrationPlateRaw:z,customerIdentifier:j}=r,[Z,X]=y!=null&&y.length?[f(y[0]).startOf("day").toDate(),f(y[1]).endOf("day").toDate()]:[void 0,void 0],i=d==null?void 0:d.id,M=d==null?void 0:d.serviceType;return{serviceId:i,serviceType:M,unitName:I,unitGroupId:C,contractTemplateId:b!==""?b:void 0,createFrom:Z,createTo:X,startDateFrom:O!=null&&O.startDate?f(O==null?void 0:O.startDate).startOf("day").toDate():void 0,startDateTo:O!=null&&O.endDate?f(O==null?void 0:O.endDate).endOf("day").toDate():void 0,deActiveAtFrom:D!=null&&D.startDate?f(D==null?void 0:D.startDate).startOf("day").toDate():void 0,deActiveAtTo:D!=null&&D.endDate?f(D==null?void 0:D.endDate).endOf("day").toDate():void 0,registrationPlate:x,status:G!==""?G:void 0,registrationPlateRaw:z,customerIdentifier:j}},[d,r]),p=async()=>{var I;if(await _.validateFields()){S({isFetching:!0,code:void 0,codeLanguage:void 0});const b=_.getFieldValue("deActiveAt");try{const x=await ba({filter:g,idContracts:c?[]:t.map(G=>G.id),idBuilding:C,isAll:c,deActiveAt:b?(I=f(b))==null?void 0:I.toDate():void 0});x.code===200&&n(),S({isFetching:!1,code:x.code,codeLanguage:x==null?void 0:x.codeLanguage}),l()}catch(x){S({isFetching:!1,code:x.code,codeLanguage:x.codeLanguage})}}};return Y(ve,{title:`${e.confirm} ?`,open:!0,okText:e.accept,cancelText:e.cancel,onCancel:l,onOk:p,okButtonProps:{disabled:A==null?void 0:A.isFetching,loading:A==null?void 0:A.isFetching},children:[Y("b",{children:[e.do_you_want_to_deactivate_vehicle.replace("{item}",c?e.all.toLowerCase():t==null?void 0:t.length)," ","?"]}),o(H,{form:_,name:"formInactive",layout:"vertical",style:{marginTop:u.margin.md},children:o(H.Item,{rules:[{required:!0}],name:"deActiveAt",label:e.label.date_of_inactivity,children:o(xe,{fluid:"true",format:R,placeholder:R})})})]})};vt.propTypes={idBuilding:a.oneOfType([a.number,a.string]),filterObj:a.objectOf(a.any),tableSelection:a.objectOf(a.any),service:a.objectOf(a.any),refreshContracts:a.func,hideFormInactiveContract:a.func};vt.defaultProps={idBuilding:0,filterObj:void 0,tableSelection:void 0,service:void 0,hideFormInactiveContract:()=>{},refreshContracts:()=>{}};const Va="active",Ga="inactive",$a="create",qa="update",Ya="delete",Ka=[{value:Va,name:e.active},{value:Ga,name:e.inactive},{value:$a,name:e.add},{value:qa,name:e.update},{value:Ya,name:e.delete}],za=ha(Ka,"value"),Tt=({hideFormContractLogs:C,idBuilding:l,formContractLogs:m})=>{var v;const[r,d]=w.useState([]),n=(v=m==null?void 0:m.data)==null?void 0:v.id,[_,u]=w.useState({code:void 0,codeLanguage:void 0,isFetching:!1}),A=r==null?void 0:r.map(t=>{var g,p,L,y,I,b,x,G,O,D,z,j,Z,X;return{...t,employeeName:(g=t==null?void 0:t.employee)==null?void 0:g.fullName,action:t!=null&&t.action?(p=za[t==null?void 0:t.action])==null?void 0:p.name:"",actionTime:t!=null&&t.createdAt?(L=f(t==null?void 0:t.createdAt))==null?void 0:L.format(It):"",createdAt:(y=t==null?void 0:t.currentData)!=null&&y.createdAt?(b=f((I=t==null?void 0:t.currentData)==null?void 0:I.createdAt))==null?void 0:b.format(It):"",unit:((G=(x=t==null?void 0:t.currentData)==null?void 0:x.unit)==null?void 0:G.name)??"",registerDate:(O=t==null?void 0:t.currentData)!=null&&O.createdAt?(z=f((D=t==null?void 0:t.currentData)==null?void 0:D.createdAt))==null?void 0:z.format(R):"",dayUse:(j=t==null?void 0:t.currentData)!=null&&j.startDate?(X=f((Z=t==null?void 0:t.currentData)==null?void 0:Z.startDate))==null?void 0:X.format(R):"",squishVin:t==null?void 0:t.squishVin,card:t==null?void 0:t.card,cardOwner:t==null?void 0:t.cardOwner,color:t==null?void 0:t.color,note:t==null?void 0:t.note,customerId:t==null?void 0:t.customerId}});w.useEffect(()=>{(async()=>{u({code:void 0,codeLanguage:void 0,isFetching:!0});const t=await xa({idBuilding:l,idContract:n});d((t==null?void 0:t.data)??[]),u({code:t.code,codeLanguage:t.codeLanguage,isFetching:!1})})()},[]);const S=()=>{C(),d([])},c={scrollToFirstRowOnChange:!0},s=[{title:e.the_operator,key:"employeeName",dataIndex:"employeeName",width:200,align:"left",fixed:"left"},{title:e.operation,key:"action",dataIndex:"action",width:130,align:"left"},{title:e.time,key:"actionTime",dataIndex:"actionTime",width:130,align:"left"},{title:e.unit,key:"unit",dataIndex:"unit",width:130,align:"left"},{title:e.tariff,key:"contractTemplateName",dataIndex:"contractTemplateName",width:150,align:"left",render:(t,g)=>(t==null?void 0:t.length)>15?o(wt,{title:t,placement:"topLeft",children:o("div",{style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:t})}):o("div",{style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:t})},{title:e.status1,key:"status",dataIndex:"status",width:150,align:"left",render:(t,g)=>{var p;return((p=g==null?void 0:g.currentData)==null?void 0:p.status)===$e?o(Ze,{color:"success",children:e.active}):o(Ze,{color:"error",children:e.inactive})||""}},{title:e.register_date,key:"registerDate",dataIndex:"registerDate",width:150,align:"left"},{title:e.day_started_using,key:"dayUse",dataIndex:"dayUse",width:150,align:"left"},{title:e.registration_plate,key:"registrationPlate",dataIndex:"registrationPlate",width:150,align:"left"},{title:e.squish_vin,key:"squishVin",dataIndex:"squishVin",width:150,align:"left"},{title:e.card,key:"card",dataIndex:"card",width:150,align:"left"},{title:e.card_owner,key:"cardOwner",dataIndex:"cardOwner",width:150,align:"left"},{title:e.customer_id,key:"customerId",dataIndex:"customerId",width:150,align:"left"},{title:e.generation,key:"generation",dataIndex:"generation",width:150,align:"left"},{title:e.color,key:"color",dataIndex:"color",width:150,align:"left"},{title:e.note,key:"note",dataIndex:"note",width:200,align:"left",render:(t,g)=>{const p=g==null?void 0:g.note;return(p==null?void 0:p.length)>20?o(wt,{title:p,placement:"topLeft",children:o("div",{style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:p})}):o("div",{style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:p})}}];return Y(ve,{title:e.history_parking,footer:null,open:!0,onCancel:S,width:"75%",children:[o(it.ActionBox,{total:r.length}),o(st,{loading:_==null?void 0:_.isFetching,columns:s,pagination:!1,dataSource:A,bordered:!0,scroll:{...c,x:s.reduce((t,g)=>t+ +((g==null?void 0:g.width)??0),0)}})]})};Tt.propTypes={hideFormContractLogs:a.func,idBuilding:a.oneOfType([a.number,a.string]),formContractLogs:a.func};Tt.defaultProps={hideFormContractLogs:()=>{},idBuilding:0,formContractLogs:()=>{}};const Un=()=>{const{setVisibleSearchBox:C,setTitlePage:l,setVisibleFilterBox:m}=w.useContext(Pt),[r,d]=w.useState(),[n,_]=w.useState({...te}),[u,A]=w.useState(1),[S,c]=w.useState(me),[s,v]=w.useState([]),[t,g]=w.useState([]),[p,L]=w.useState([]),[y,I]=w.useState([]),[b,x]=w.useState(!1),[G,O]=w.useState(!1),[D,z]=w.useState([]),[j,Z]=w.useState(null),X=Ut(),{idBuilding:i}=X,{serviceInUses:M,getServiceInUses:$}=wa(),[Q,h,N]=pe(),[k,P,re]=pe(),[le,Te,Ce]=pe(),[_e,Ae,qe]=pe(),[ee,Se,U]=pe(),[Ie,Ye,Ke]=pe(),[De,Ne,ze]=pe(),[we]=H.useForm(),oe=M==null?void 0:M.filter(T=>(T==null?void 0:T.systemCode)===nt&&(T==null?void 0:T.serviceType)===_t),{getPermissionByModuleCode:Bt}=fa(),Fe=Bt(ya),Ct=(Fe==null?void 0:Fe[va])??!1,Mt=(Fe==null?void 0:Fe[Ta])??!1,Ee=w.useMemo(()=>t==null?void 0:t.map(T=>{var V;let F=0,B=0;const K=[];for(let q=0;q<T.contracts.length;q+=1){const E=T.contracts[q],{contractTemplate:ie,totalNumberUse:Pe}=E,{formula:se}=ie,Le=Dt({formula:se.formula,formulaType:se.formulaType,norm:1,ratio:1,totalNumberUse:Pe});E.totalPayment=Math.round(Le),E.status===$e&&(F+=1,B+=Number(E.totalPayment)),K.push({typeRow:"CONTRACT",id:E.id,key:`${T.id} - ${E.id}`,apartment:E.registrationPlate,registrationPlateRaw:E.registrationPlateRaw,contractTemplate:E.contractTemplate.name,status:E.status,amount:E.totalNumberUse,totalPayment:fe(E.totalPayment),paidUntilAt:E.paidUntilAt,registerDate:f(E.createdAt).format(R),dayOfUsing:`${f(E.startDate).format(R)}${E.deActiveAt?` - ${f(E.deActiveAt).format(R)}`:""}`,...((V=E==null?void 0:E.requiredInfo)==null?void 0:V.reduce((ce,W)=>{var de,be,ne;return W.key==="card"?ce[W.key]=((de=E==null?void 0:E.card)==null?void 0:de.code)??(W==null?void 0:W.value)??"":W.key==="card_owner"?ce[W.key]=((ne=(be=E==null?void 0:E.card)==null?void 0:be.owner)==null?void 0:ne.fullName)??(W==null?void 0:W.value)??"":ce[W.key]=W.value,ce},{}))??{},contract:E,apartmentId:T.id,apartmentName:T.name})}return{typeRow:"APARTMENT",id:T.id,key:T.id,apartment:T.name,amount:F,totalPayment:fe(B),children:K}}),[t]),[tt,at,Vt,Gt,$t]=Ia({dataRows:Ee,rowKey:"key",totalRows:p}),{selectedRowKeys:qt}=tt,Oe=async T=>{const{registerDate:F,serviceId:B,serviceType:K,apartment:V,contractTemplateId:q,registrationPlate:E,status:ie,dayStartedUsing:Pe,dayStoppedUsing:se,card:Le}=T,[ce,W]=F!=null&&F.length?[f(F[0]).startOf("day").toDate(),f(F[1]).endOf("day").toDate()]:[void 0,void 0],de=Pe?f(Pe).toDate():void 0,be=se?f(se).toDate():void 0,ne=await Da({idBuilding:i,filter:{serviceId:B,serviceType:K,unitName:V,unitGroupId:i,contractTemplateId:q!==""?q:void 0,createFrom:ce,createTo:W,deActiveAt:be,from:de,registrationPlate:E,card:Le,status:ie!==""?ie:void 0}});return I(ne==null?void 0:ne.data),ne},ke=async(T,F,B)=>{O(!0);const{registerDate:K,dayStartedUsing:V,dayStoppedUsing:q,serviceId:E,serviceType:ie,apartment:Pe,contractTemplateId:se,registrationPlate:Le,registrationPlateRaw:ce,card:W,status:de}=T,[be,ne]=K!=null&&K.length?[f(K[0]).startOf("day").toDate(),f(K[1]).endOf("day").toDate()]:[void 0,void 0],Qt=V?f(V).toDate():void 0,Jt=q?f(q).toDate():void 0,ue=await Ot({idBuilding:i,filter:{serviceId:E,serviceType:ie,unitName:Pe,unitGroupId:i,contractTemplateId:se!==""?se:void 0,createFrom:be,createTo:ne,deActiveAt:Jt,from:Qt,registrationPlate:Le,registrationPlateRaw:ce,card:W,status:de!==""?de:void 0},page:F,limit:B});return g((ue==null?void 0:ue.data)??[]),L((ue==null?void 0:ue.totalRecord)??[]),O(!1),ue},Yt=async()=>{var K;x(!0);const T=await $({idBuilding:i}),F=(T==null?void 0:T.data)??[],B=F==null?void 0:F.filter(V=>(V==null?void 0:V.systemCode)===nt&&(V==null?void 0:V.serviceType)===_t);if(B.length>0){const V=((K=B==null?void 0:B[0])==null?void 0:K.id)??"",q=B.find(ie=>ie.id===V);d(q),Z(V),_({...te,serviceId:V,serviceType:q==null?void 0:q.serviceType});const E=await At({idBuilding:i,filter:{serviceId:V}});v(E==null?void 0:E.data),await ke({...te,serviceId:V,serviceType:q==null?void 0:q.serviceType},u,S),await Oe({...te,serviceId:V,serviceType:q==null?void 0:q.serviceType})}x(!1)};w.useEffect(()=>(C(!0),l(`${e.service} ${e.parking.toLowerCase()}`),Yt(),()=>{C(!1),m(!1),l("")}),[]);const Kt=async T=>{if(T!==j){O(!0);const F=oe.find(K=>K.id===T);d(F),Z(T),_({...te,serviceId:T,serviceType:F==null?void 0:F.serviceType}),A(1),c(me);const B=await At({idBuilding:i,filter:{serviceId:T}});v(B==null?void 0:B.data),await ke({...te,serviceId:T,serviceType:F==null?void 0:F.serviceType},1,me),await Oe({...te,serviceId:T,serviceType:F==null?void 0:F.serviceType}),we.resetFields(),O(!1)}},zt=async T=>{_({...T}),await ke({...T,serviceId:r.id,serviceType:r.serviceType},u,S),await Oe({...T,serviceId:r.id,serviceType:r.serviceType}),at()},Ht=async(T,F)=>{T!==u&&A(T),F!==S&&c(F),await ke({...n,serviceId:r.id,serviceType:r.serviceType},T,F)},Re=async()=>{_({...te}),A(1),c(me),await ke({...te,serviceId:r.id,serviceType:r.serviceType},1,me),await Oe({...te,serviceId:r.id,serviceType:r.serviceType}),we.resetFields(),at()},Xt=async()=>{await ke({...n,serviceId:r.id,serviceType:r.serviceType},u,S),await Oe({...n,serviceId:r.id,serviceType:r.serviceType}),at()};w.useEffect(()=>{const T=Ee==null?void 0:Ee.flatMap(F=>[F.key,...F.children.map(B=>B.key)]);z(T)},[Ee]);const Wt=(T,F)=>{const B=[...D],K=B.indexOf(F.key);K>-1?B.splice(K,1):B.push(F.key),z(B)};return b?o(Ca,{isLoading:b}):r?Y(ct,{style:{flex:1,height:"100%"},children:[(oe==null?void 0:oe.length)>1?o(J,{style:{flex:1},span:"4",children:o(Sa,{menuActiveKey:j,handleSelectService:Kt,services:oe})}):null,o(J,{style:{flex:1,display:"flex",flexDirection:"column",position:"relative"},span:(oe==null?void 0:oe.length)>1?20:24,children:Y(Et,{children:[!(s!=null&&s.length)&&!b?o(Aa,{}):null,o(pt,{formFilter:we,contractTemplates:s,handleFilterChange:zt}),Y(Xe,{style:{flex:1},children:[o(Xe.Header,{children:o(dt,{idBuilding:i,service:r,filterObj:n,tableSelection:tt,refreshContracts:Re,selectAllRowComponent:$t,showFormAddContract:Ae,showFormImportContract:h,showFormExportContract:P,servicePermissionWrite:Ct,servicePermissionExport:Mt,showFormInactiveContract:Ye,showFormContractLogs:Ne})}),o(Xe.Content,{fluid:!0,children:o(ut,{loading:G,idBuilding:i,service:r,totalPayment:y,totalItem:p,tablePage:u,tablePageSize:S,selectedRowKeys:qt,dataSource:Ee,reloadContracts:Xt,handleTablePageChange:Ht,onSelectRow:Vt,onSelectAllRowOfPage:Gt,showFormUpdateContract:Se,showFormDetailContractTemplate:Te,servicePermissionWrite:Ct,onExpand:Wt,expandedKeys:D,showFormContractLogs:Ne})})]}),_e.isShow&&o(ht,{idBuilding:i,contractTemplates:s,requiredInfo:r.requiredInfo,refreshContracts:Re,onHide:qe}),ee.isShow&&o(ft,{idBuilding:i,apartment:ee.data.apartment,contract:ee.data.contract,contractTemplates:s,requiredInfo:r.requiredInfo,refreshContracts:Re,onHide:U}),Q.isShow&&o(mt,{contractTemplates:s,idBuilding:i,onHide:N,refreshContracts:Re,service:r}),le.isShow&&o(gt,{contractTemplate:le.data.contractTemplate,hideModal:Ce}),k.isShow?o(yt,{hideModalExportData:re,filter:n,serviceActive:r,totalItem:p}):null,Ie!=null&&Ie.isShow?o(vt,{hideFormInactiveContract:Ke,tableSelection:tt,service:r,filterObj:n,idBuilding:i,refreshContracts:Re}):null,De.isShow&&o(Tt,{idBuilding:i,hideFormContractLogs:ze,formContractLogs:De})]})})]}):null};export{Un as default};
