import{j as o,a as k,u as et,F as q,c as ft}from"./@emotion-63839449.js";import{l as gt}from"./lodash-88fe09e6.js";import{h as L}from"./moment-a468e1f9.js";import{a9 as B,s as re,b0 as pt,K as te,aB as St,at as _t,ag as yt,l as d,f2 as vt,f3 as wt,f4 as Tt,f5 as It,eu as Nt,ep as Ee,f1 as xe,eZ as De,fn as tt,fg as Pt,e_ as bt,a3 as it,I as G,hl as Ft,a5 as Ct,a as Re,fx as ie,fE as J,fy as oe,b1 as Et,c6 as xt,hm as Dt,hn as Rt,fz as Ve,fC as ze,ho as Lt,hp as Ot,fB as Mt,Y as ot,fF as fe,dy as nt,S as Pe,hq as K,hr as be,gU as kt,a8 as ve,hs as Ge,dx as We,ht as At,hu as Yt}from"./index-c2ded735.js";import"./file-saver-40cf32a9.js";import{m as Bt,D as ge,P as V,T as _e,F as at,a as Le,o as Ut,n as qe,R as je,d as Ht,u as $t}from"./index-b17d22e5.js";import{r as p}from"./react-4fd50329.js";import{P as $}from"./prop-types-1172f4d5.js";import"./react-redux-896b353b.js";import{u as Vt}from"./useTableCheckbox-753d19b2.js";import"./@firebase-43527ee1.js";import{F as U,u as ce}from"./index-687ba9e6.js";import{k as le,S as zt,e as Gt,f as Wt,i as qt,j as rt,c as st,l as de,m as Oe,n as ne,N as jt,o as pe,P as me,p as Jt}from"./constants-9bef80b2.js";import{u as Me}from"./react-router-a4308f7b.js";import{S as O,I as Se}from"./index-43183512.js";import{u as Kt}from"./useService-37d60dc0.js";import{u as Qt}from"./useFloor-e6fe641c.js";import{w as Xt,s as Zt,x as ei}from"./bill-d9d0423c.js";import{b as ti}from"./buildDetailBills-28b155ef.js";import{B as Q,a as Y,w as ii,T as we,R as ke,b as z,A as he,V as oi,P as ni,W as ai}from"./antd-f9eae174.js";import{B as ee}from"./index-881eef42.js";import{d as ri,g as si,a as ci,b as li,c as di,e as ui,f as mi,h as hi,i as fi,j as gi}from"./feeNotification-74acc339.js";import{M as ct}from"./index-6a3b7dc6.js";import{p as Fe}from"./printHtml-6274ec45.js";import{f as pi}from"./formatNumberWithPrecision-689b8fea.js";import"./hoist-non-react-statics-23d96a9a.js";import"./react-is-e8e5dbb3.js";import"./@babel-b64fd0f9.js";import"./stylis-79144faa.js";import"./classnames-4ba1ba1a.js";import"./redux-10bbab4c.js";import"./react-router-dom-2a8f5f6d.js";import"./history-a1882333.js";import"./resolve-pathname-e210f2ac.js";import"./tiny-invariant-dd7d57d2.js";import"./react-dom-40621ea0.js";import"./scheduler-765c72db.js";import"./@redux-saga-8bafe09b.js";import"./redux-logger-e1c9ca90.js";import"./dompurify-8e338605.js";import"./query-string-f5cca1e7.js";import"./decode-uri-component-4138e85d.js";import"./split-on-first-4f1167c8.js";import"./filter-obj-2ed190f4.js";import"./oidc-client-7da0eaf7.js";import"./firebase-878887a2.js";import"./rc-pagination-c1e6a0ac.js";import"./rc-picker-2e3d5fe5.js";import"./rc-util-0bc219f3.js";import"./rc-trigger-570b13ec.js";import"./rc-motion-ae889c42.js";import"./rc-align-e5d7b12e.js";import"./dom-align-ecb06dd6.js";import"./resize-observer-polyfill-0f9f8adb.js";import"./rc-resize-observer-b9ad4e29.js";import"./@ant-design-cba9d434.js";import"./@ctrl-fb5a5473.js";import"./rc-tabs-dfd19a56.js";import"./rc-dropdown-5378dd0a.js";import"./rc-menu-b15ebfe9.js";import"./rc-overflow-6be96612.js";import"./rc-select-564caf01.js";import"./rc-virtual-list-8a7b82a6.js";import"./rc-collapse-11b7d3c4.js";import"./shallowequal-4542d6f7.js";import"./rc-drawer-317f0b4d.js";import"./@rc-component-5a112e55.js";import"./rc-field-form-ef5549aa.js";import"./async-validator-dee29e8b.js";import"./scroll-into-view-if-needed-6b992d05.js";import"./compute-scroll-into-view-183f845a.js";import"./rc-image-e0357917.js";import"./rc-dialog-b1d1f07b.js";import"./rc-input-number-8bc068f7.js";import"./rc-rate-c64cf0d5.js";import"./rc-steps-2d1924c7.js";import"./rc-switch-b4e96de7.js";import"./rc-table-191ecc42.js";import"./rc-checkbox-018e8052.js";import"./rc-tree-67773537.js";import"./rc-tree-select-cb7eccc3.js";import"./copy-to-clipboard-64585c8c.js";import"./toggle-selection-93f4ad84.js";import"./rc-textarea-d01adcbb.js";import"./rc-input-02c2c2ba.js";import"./rc-upload-3ab0f08a.js";import"./rc-notification-d13dc43b.js";import"./rc-progress-4f1a7096.js";import"./rc-tooltip-08fa4217.js";import"./use-sync-external-store-5d1b6592.js";import"./idb-cdd1a92f.js";import"./path-to-regexp-ef8d5544.js";import"./account-86ffff50.js";import"./libphonenumber-js-0d5a9c92.js";import"./react-infinite-scroll-component-e33646cb.js";import"./index-f7aef2cc.js";function Si(e){if(Number.isNaN(Number(e)))return"";const a=String(e).split(".");let h=a[0];const n=a.length>1?`.${a[1]}`:"",c=/(\d+)(\d{3})/;for(;c.test(h);)h=h.replace(c,"$1,$2");return h+n}const H=p.createContext({idBuilding:0,feeNotificationPermissionWrite:!1,feeNotificationPermissionRead:!1,getsStatus:{isFetching:!1},setGetsStatus:()=>{},tableData:{records:[],totalRecord:0},setTableData:()=>{},tablePagination:{current:B,limit:re},setTablePagination:()=>{},filter:{...le},setFilter:()=>{},tableSelection:void 0,resetDataTableSelection:()=>{},onSelectRow:()=>{},onSelectAllRowOfPage:()=>{},selectAllRowComponent:()=>{},getTotalPaymentStatus:{isFetching:!1},setGetTotalPaymentStatus:()=>{},formHistory:void 0,showFormHistory:()=>{},hideFormHistory:()=>{},formSend:void 0,showFormSend:()=>{},hideFormSend:()=>{},tableDataTotal:{totalPayment:0},setTableDataTotal:()=>{},processPublic:void 0,showProcessPublic:()=>{},hideProcessPublic:()=>{},formFilter:void 0}),lt=e=>{const{children:t}=e,{getPermissionByModuleCode:a}=pt(),{idBuilding:h}=Me(),[n,c]=p.useState({isFetching:!1}),[i,r]=p.useState({records:[],totalRecord:0}),[l,g]=p.useState({isFetching:!1}),[u,s]=p.useState({totalPayment:0}),[m,f]=p.useState({current:B,limit:re}),[S,F]=p.useState({...le}),[I,C,R,P,_]=Vt({dataRows:i.records,rowKey:"key",totalRows:i.totalRecord}),[y,E,D]=te(),[T,A,N]=te(),M=a(St),x=(M==null?void 0:M[_t])??!1,v=(M==null?void 0:M[yt])??!1,[b]=U.useForm(),w={idBuilding:h,feeNotificationPermissionWrite:x,feeNotificationPermissionRead:v,getsStatus:n,setGetsStatus:c,tableData:i,setTableData:r,tablePagination:m,setTablePagination:f,filter:S,setFilter:F,tableSelection:I,resetDataTableSelection:C,onSelectRow:R,onSelectAllRowOfPage:P,selectAllRowComponent:_,formHistory:y,showFormHistory:E,hideFormHistory:D,formSend:T,showFormSend:A,hideFormSend:N,getTotalPaymentStatus:l,setGetTotalPaymentStatus:g,tableDataTotal:u,setTableDataTotal:s,formFilter:b};return o(H.Provider,{value:w,children:t})};lt.propTypes={children:$.node.isRequired};const _i=lt,yi=e=>{var l,g,u,s,m,f,S;const t=((g=(l=e==null?void 0:e.contract)==null?void 0:l.service)==null?void 0:g.identifier)??"",a=((u=e==null?void 0:e.service)==null?void 0:u.name)??"",h=((s=e==null?void 0:e.contract)==null?void 0:s.registrationPlate)??"",n=`${((f=(m=e==null?void 0:e.contract)==null?void 0:m.contractTemplate)==null?void 0:f.name)??""}${t==="PARKING"?` (${h})`:""}`,{content:c,note:i}=ti({createdFor:e.createdFor,serviceName:a,contractTemplateName:n,totalNumberUse:e.totalNumberUse,parentId:e.parentId,type:e.type,contentBill:e.content});let r=e.parentId?d.label.bill_debt:((S=vt[e.type])==null?void 0:S.name)??"";return e.type===wt&&(r=d.label.adjust_up),e.type===Tt&&(r=d.label.adjust_down),{...e,content:c,note:i,contractTemplateName:n,apartment:a,serviceCode:t,usageTime:e.startDate&&e.endData?`${L(e.startDate).format("DD/MM/YYYY")} - ${L(e.endDate).format("DD/MM/YYYY")}`:"",startDate:e.startDate,endDate:e.endDate,numberUsage:e.totalNumberUse,typeRow:"BILL",apartmentType:r,total:e.totalPayment-e.netRevenue,public:It[e.state]}},vi=(e,t=null)=>{var n,c,i;const a={...e,key:e.id,apartment:e.name,unitName:e.name,apartmentType:((n=Nt[e.unitTypeId])==null?void 0:n.name)??"",total:0,totalMustPay:0,children:[],strong:!0,typeRow:"APARTMENT",totalBalance:Number(((c=e==null?void 0:e.account)==null?void 0:c.balance)||0),totalDebt:0,totalExpectedReceivable:0,billIds:[],unitId:e.id},h=((i=e==null?void 0:e.bills)==null?void 0:i.map(r=>{var g,u,s;const l=yi(r);return a.total+=l.total,t&&Number(t)>Number(l.incurredCreatedFor)&&(a.totalDebt+=l.total),t&&Number(t)<=Number(l.incurredCreatedFor)&&(a.totalExpectedReceivable+=l.total),a.billIds.push(r.id),{...l,key:`${e.id}-${l.id}-${l.code}`,unitName:e.name,floorName:(e==null?void 0:e.floorName)||"",unitOwner:((u=(g=e==null?void 0:e.residents)==null?void 0:g[0])==null?void 0:u.fullName)??"",balance:Number(((s=e==null?void 0:e.account)==null?void 0:s.balance)||0)}}))??[];return h&&h.length&&!t&&(a.children=h),t&&delete a.children,a.totalMustPay=a.total-a.totalBalance,a},ae=async({filter:e,idBuilding:t,page:a,limit:h,incurredCreatedFor:n})=>{var c,i;try{const{feeNotificationMonth:r,unitType:l,unitName:g,floorId:u,serviceIds:s,states:m}=e,{code:f,codeLanguage:S,totalRecord:F,data:I}=await Xt({filterObject:{serviceIds:s&&s.length?s:void 0,unitName:g||void 0,unitType:l||void 0,floorId:u||void 0,from:((c=r==null?void 0:r[0])==null?void 0:c.startOf("month").startOf("day").toISOString())??void 0,to:((i=r==null?void 0:r[1])==null?void 0:i.endOf("month").endOf("day").toISOString())??void 0,status:Ee,state:m&&m.length?m:[xe,De]},page:a,limit:h,idBuilding:t});return{code:f,codeLanguage:S,data:I.map(C=>vi(C,n)),totalRecord:F}}catch(r){return{code:r.code,codeLanguage:r.codeLanguage,data:[],totalRecord:0}}},wi=async(e,t)=>{var a,h;try{const{feeNotificationMonth:n,unitType:c,unitName:i,floorId:r,serviceIds:l,states:g}=t,{code:u,codeLanguage:s,data:m}=await Zt({filterObject:{serviceIds:l&&l.length?l:void 0,unitName:i||void 0,unitType:c||void 0,floorId:r||void 0,from:((a=n==null?void 0:n[0])==null?void 0:a.startOf("month").startOf("day").toISOString())??void 0,to:((h=n==null?void 0:n[1])==null?void 0:h.endOf("month").endOf("day").toISOString())??void 0,paymentStatus:tt,status:Ee,state:g&&g.length?g:[xe,De]},idBuilding:e});return{code:u,codeLanguage:s,data:m}}catch({code:n,codeLanguage:c}){return{code:n,codeLanguage:c,data:0}}},ye=()=>{const{setGetsStatus:e,setTablePagination:t,resetDataTableSelection:a,setTableData:h,setTableDataTotal:n,idBuilding:c,setGetTotalPaymentStatus:i}=p.useContext(H);return{changeDataTable:async({filter:g,tablePagination:u,isResetTableSelection:s=!1})=>{e({isFetching:!0}),s&&a(),t({current:u.current,limit:u.limit});const m=await ae({filter:{...g},idBuilding:c,limit:u.limit,page:u.current});h({records:m.data,totalRecord:m.totalRecord}),e({isFetching:!1})},changeTotal:async({filter:g})=>{i({isFetching:!0});const u=await wi(c,g);n({totalPayment:u.data}),i({isFetching:!1})}}},Ti=()=>{const{idBuilding:e}=Me(),{setFilter:t,formFilter:a}=p.useContext(H),{getServiceInUses:h,serviceInUses:n}=Kt(),{apartmentTypes:c}=Bt(),{floors:i,getFloors:r}=Qt(),{changeDataTable:l,changeTotal:g}=ye();return p.useEffect(()=>{(async()=>(await h({idBuilding:e}),await r({idBuilding:e})))()},[]),{serviceInUses:n,apartmentTypes:c,floors:i,onSearch:async s=>{t(s),l({filter:s,isResetTableSelection:!0,tablePagination:{current:B,limit:re}}),g({filter:s})},formFilter:a}},Ii=()=>{const{serviceInUses:e,apartmentTypes:t,floors:a,onSearch:h,formFilter:n}=Ti(),c=p.useMemo(()=>[{label:d.floor,key:"floorId",component:k(O,{fluid:"true",placeholder:d.floor,getPopupContainer:i=>i.parentNode,children:[o(O.Option,{value:"",children:d.all_floor},"floor_0"),a.map(i=>o(O.Option,{value:i.id,children:i.name},`status_${i.id}`))]}),visible:!0},{label:d.unit,key:"unitName",component:o(Se,{placeholder:d.unit}),visible:!0},{label:d.apartment_type,key:"unitType",component:k(O,{fluid:"true",placeholder:d.apartment_type,getPopupContainer:i=>i.parentNode,children:[o(O.Option,{value:"",children:d.all},"apartment_type_0"),t.map(i=>o(O.Option,{value:i.id,children:i.name},`apartment_type_${i.id}`))]}),visible:!0},{label:d.status1,key:"states",component:o(O,{fluid:"true",placeholder:d.status1,getPopupContainer:i=>i.parentNode,mode:"multiple",children:Pt.filter(({id:i})=>i!==bt).map(i=>o(O.Option,{value:i.id,children:i.name},i.id))}),visible:!0},{label:d.invoice_month,key:"feeNotificationMonth",component:o(ge.RangePicker,{picker:"month",format:"MM/YYYY",fluid:"true",getPopupContainer:i=>i.parentNode}),visible:!0},{label:d.service,key:"serviceIds",component:o(O,{fluid:"true",mode:"multiple",placeholder:d.label.service,allowClear:!0,showSearch:!0,maxTagCount:1,filterOption:(i,r)=>r.children.toLowerCase().indexOf(i.toLowerCase())>=0,getPopupContainer:i=>i.parentNode,children:e.map(i=>o(O.Option,{value:i.id,children:i.name},i.id))}),visible:!0}],[a,t,e]);return o(V.FilterBox,{defaultFilter:{...le},onSearch:h,layout:"vertical",filters:c,formData:n})},Ni=()=>{const{tableSelection:e,selectAllRowComponent:t,feeNotificationPermissionRead:a,showFormHistory:h,showFormSend:n}=p.useContext(H),{isSelectAllItem:c,selectedRowKeysCache:i,byId:r}=e,l=()=>{h()},g=()=>{const m=i.map(f=>r==null?void 0:r[f]).filter(f=>(f==null?void 0:f.typeRow)==="BILL");n({bills:m,isAll:c})};return{isSelectedItem:p.useMemo(()=>{var m;return(m=i.map(f=>r==null?void 0:r[f]).filter(f=>(f==null?void 0:f.typeRow)==="BILL"))==null?void 0:m.length},[i.length]),feeNotificationPermissionRead:a,handleShowHistory:l,handleShowConfirmInvoice:g,titleTable:()=>t({totalItemSelected:e.selectedRowKeysCache.map(m=>{var f;return(f=e.byId)==null?void 0:f[m]}).filter(m=>(m==null?void 0:m.typeRow)==="APARTMENT").length,textSelectRow:d.you_selected_rows,textSelectAllRow:d.select_all_rows})}},Pi=()=>{const{isSelectedItem:e,feeNotificationPermissionRead:t,handleShowHistory:a,titleTable:h,handleShowConfirmInvoice:n}=Ni(),c=it(),i=[t?o(Q,{type:"primary",ghost:!0,css:r=>({marginRight:r.margin.xs}),icon:o(G,{name:"icon-history-outlined"}),onClick:()=>{c({action:Ft,label:Ct}),a()},children:d.history},"history"):null,o(Q,{type:"primary",disabled:!e,icon:o(G,{name:"icon-notification-filled"}),onClick:()=>{n()},children:d.send_invoices},"send_invoices")].filter(Boolean);return o(V.ActionBox,{actions:i,total:h()})},bi=()=>{const e=et(),{layoutScrollRef:t}=p.useContext(Re),{tableData:a,tableSelection:h,onSelectRow:n,onSelectAllRowOfPage:c,getsStatus:i,tablePagination:r,filter:l,tableDataTotal:g,feeNotificationPermissionWrite:u,getTotalPaymentStatus:s}=p.useContext(H),{changeDataTable:m}=ye(),{selectedRowKeys:f}=h,S=async(E,D)=>{E!==r.current?await m({filter:l,isResetTableSelection:!1,tablePagination:{current:E,limit:r.limit}}):D!==r.limit&&await m({filter:l,isResetTableSelection:!1,tablePagination:{current:r.current,limit:D}})},F=a.records,I={pageSize:r.limit,defaultCurrent:1,current:r.current,total:a.totalRecord,showQuickJumper:!0,showSizeChanger:!0,onChange:S},{totalPayment:C}=g,R={selectedRowKeys:f,onSelect:n,onSelectAll:c,fixed:!0},P={offsetScroll:e.offsetScrollX,getContainer:()=>t.current},_=i.isFetching,y=s.isFetching;return{loading:_,loadingTotalPayment:y,totalPayment:C,dataSource:F,pagination:I,rowSelection:R,sticky:P,feeNotificationPermissionWrite:u}},Fi=()=>{const{loading:e,loadingTotalPayment:t,totalPayment:a,dataSource:h,pagination:n,rowSelection:c,sticky:i,feeNotificationPermissionWrite:r}=bi(),l=u=>o("div",{children:u.map((s,m)=>k("p",{children:[d.turn," ",m+1,": ",s!=null&&s.createdAt?L(s.createdAt).format("DD/MM/YYYY HH:mm"):null]},m))}),g=[{title:d.unit,key:"apartment",fixed:!0,width:150,children:[{title:d.total,dataIndex:"apartment",key:"apartment",render:(u,s)=>o(Y.Text,{strong:!0,children:u}),fixed:!0,width:150}]},{title:d.label.floor,key:"floorName",width:150,children:[{title:"",dataIndex:"floorName",key:"floorName",render:(u,s)=>o(Y.Text,{strong:!0,children:u}),width:150}]},{title:`${d.label.apartment_type} / ${d.label.invoice_type}`,key:"apartmentType",width:200,children:[{title:"",dataIndex:"apartmentType",key:"apartmentType",render:(u,s)=>o(Y.Text,{strong:s.strong,children:u}),width:200}]},{title:d.status1,key:"public",width:120,children:[{title:"",dataIndex:"public",key:"public",width:120,align:"center",render:(u,s)=>{var m,f;return s!=null&&s.public?o(ii,{color:(m=s==null?void 0:s.public)==null?void 0:m.color,children:(f=s==null?void 0:s.public)==null?void 0:f.name}):null}}],align:"center"},{title:d.tariff,key:"contractTemplateName",width:150,children:[{title:"",dataIndex:"contractTemplateName",key:"contractTemplateName",render:(u,s)=>o(Y.Text,{strong:s.strong,children:u}),width:150}]},{title:d.label.consume,key:"numberUsage",width:100,children:[{title:"",dataIndex:"numberUsage",key:"numberUsage",render:(u,s)=>o(Y.Text,{strong:s.strong,children:u&&Si(u)}),width:100,align:"right"}]},{title:`${d.label.opening} - ${d.label.closing}`,key:"usageTime",width:200,children:[{title:"",dataIndex:"usageTime",key:"usageTime",render:(u,s)=>k(Y.Text,{children:[s.startDate?L(s.startDate).format("DD/MM/YYYY"):""," -"," ",s.endDate?L(s.endDate).format("DD/MM/YYYY"):""]}),width:200}]},{title:d.invoice_month,key:"createdFor",width:150,children:[{title:"",dataIndex:"createdFor",key:"createdFor",render:(u,s)=>o(Y.Text,{children:u?L(s.incurredCreatedFor,"YYYYMM").format("MM/YYYY"):""}),width:150}]},{title:d.label.send_email,key:"sendEmail",width:50,children:[{title:"",dataIndex:"sendEmailChild",key:"sendEmailChild",render:(u,s)=>{var m,f,S;return s.typeRow==="APARTMENT"?null:o(we,{title:l(((m=s==null?void 0:s.sentInvoiceHistories)==null?void 0:m[ie])??[]),children:((S=(f=s==null?void 0:s.sentInvoiceHistories)==null?void 0:f[ie])==null?void 0:S.length)??0})},width:50,align:"center"}],align:"center"},{title:d.print,key:"print",width:50,children:[{title:"",dataIndex:"printChild",key:"printChild",render:(u,s)=>{var m,f,S;return s.typeRow==="APARTMENT"?null:o(we,{title:l(((m=s==null?void 0:s.sentInvoiceHistories)==null?void 0:m[J])??[]),children:((S=(f=s==null?void 0:s.sentInvoiceHistories)==null?void 0:f[J])==null?void 0:S.length)??0})},width:50,align:"center"}],align:"center"},{title:d.label.sms,key:"sms",width:50,children:[{title:"",dataIndex:"smsChild",key:"smsChild",render:(u,s)=>{var m,f,S;return s.typeRow==="APARTMENT"?null:o(we,{title:l(((m=s==null?void 0:s.sentInvoiceHistories)==null?void 0:m[oe])??[]),children:((S=(f=s==null?void 0:s.sentInvoiceHistories)==null?void 0:f[oe])==null?void 0:S.length)??0})},width:50,align:"center"}],align:"center"},{title:d.label.total,key:"total",align:"right",fixed:"right",width:150,children:[{title:t?o(Et,{isLoading:!0}):xt(Math.round(a)),dataIndex:"total",key:"total",align:"right",render:u=>o(Y.NegativeNumber,{children:u}),fixed:"right",width:150}]}];return o(_e,{bordered:!0,columns:g,dataSource:h,loading:e,pagination:n,scroll:{x:g.reduce((u,s)=>u+s.width,0),scrollToFirstRowOnChange:!0},rowSelection:r?c:!1,sticky:i})},Ae={unitName:void 0,createdDate:[L().startOf("month").startOf("day"),L().endOf("month").endOf("day")],sendType:"",code:void 0,sendMethod:"",sendMailStatus:""},Ci=e=>{const{invoices:t,name:a,id:h}=e;return{id:e==null?void 0:e.code,typeRow:"APARTMENT",key:e==null?void 0:e.code,unit:a,children:t.sort((n,c)=>{const i=L(n.createdAt);return L(c.createdAt).isSameOrBefore(i)?-1:0}).map(n=>{var S,F,I;const{id:c,code:i,sendMethod:r,type:l,createdAt:g,sendMailStatus:u,sendSmsStatus:s,parent:m}=n,f={id:c,typeRow:"INVOICE",key:`${e==null?void 0:e.code}-${c}`,unit:"",code:i,method:((S=Dt[r])==null?void 0:S.name)??"",sendMethod:r,type:Rt[l]??"",createdAt:g?L(g).format("DD/MM/YYYY"):"",result:((F=Ve[u])==null?void 0:F.name)||((I=Ve[s])==null?void 0:I.name)||"",originalCode:m==null?void 0:m.code,feeNotification:{...n,unitId:h},isShowAction:!0,sendResult:u===ze||s===ze?d.success:""};return[zt,Gt].includes(n.errorMsg)&&(f.isShowAction=!1),n.errorMsg&&(f.sendResult=Wt[n.errorMsg]),f})}},Ei=async({filter:e,idBuilding:t,limit:a,page:h})=>await ri({filter:{...e,type:e.sendType},idBuilding:t,limit:a,page:h}),se=p.createContext({idBuilding:0,getsStatus:{isFetching:!1},setGetsStatus:()=>{},filter:{...Ae},setFilter:()=>{},tableData:{records:[],totalRecord:0},setTableData:()=>{},tablePagination:{current:1,limit:re},setTablePagination:()=>{},formSendEmail:void 0,showFormSendEmail:()=>{},hideFormSendEmail:()=>{},formPrint:void 0,showFormPrint:()=>{},hideFormPrint:()=>{},formPreview:void 0,showFormPreview:()=>{},hideFormPreview:()=>{}}),Ye=({children:e})=>{const t=Me(),{idBuilding:a}=t,[h,n]=p.useState({isFetching:!1}),[c,i]=p.useState({...Ae}),[r,l]=p.useState({records:[],totalRecord:0}),[g,u]=p.useState({current:1,limit:re}),[s,m,f]=te(),[S,F,I]=te(),[C,R,P]=te(),_={idBuilding:a,getsStatus:h,setGetsStatus:n,filter:c,setFilter:i,tableData:r,setTableData:({records:y,totalRecord:E})=>{l({records:y.map(D=>Ci(D)),totalRecord:E})},tablePagination:g,setTablePagination:u,formSendEmail:s,showFormSendEmail:m,hideFormSendEmail:f,formPrint:S,showFormPrint:F,hideFormPrint:I,formPreview:C,showFormPreview:R,hideFormPreview:P};return o(se.Provider,{value:_,children:e})};Ye.propTypes={children:$.node};Ye.defaultProps={children:o("div",{})};const Be=()=>{const{setGetsStatus:e,setTablePagination:t,idBuilding:a,setTableData:h}=p.useContext(se);return[async({filterInp:c,tablePaginationInp:i})=>{var u,s;e({isFetching:!0}),t({current:i.current,limit:i.limit});const{createdDate:r,...l}=c,g=await Ei({filter:{...l,from:((u=r==null?void 0:r[0])==null?void 0:u.startOf("day").toISOString())??void 0,to:((s=r==null?void 0:r[1])==null?void 0:s.endOf("day").toISOString())??void 0},idBuilding:a,limit:i.limit,page:i.current});h({records:g.data,totalRecord:g.totalRecord}),e({isFetching:!1})}]},xi=()=>{const{setFilter:e}=p.useContext(se),[t]=Be(),a=async n=>{e(n),await t({filterInp:n,tablePaginationInp:{current:1,limit:re}})},h=p.useMemo(()=>[{label:d.unit,key:"unitName",component:o(Se,{placeholder:d.unit,fluid:"true"}),visible:!0},{label:d.invoice_sent_at,key:"createdDate",component:o(ge.RangePicker,{placeholder:["DD/MM/YYYY","DD/MM/YYYY"],format:"DD/MM/YYYY",fluid:"true",getPopupContainer:n=>n.parentNode}),visible:!0},{label:d.invoice_code,key:"code",component:o(Se,{placeholder:d.invoice_code,fluid:"true"}),visible:!0},{label:d.send_method,key:"sendMethod",component:k(O,{fluid:"true",getPopupContainer:n=>n.parentNode,children:[o(O.Option,{value:"",children:d.all_method},"send_method_0"),Lt.map(n=>o(O.Option,{value:n.id,children:n.name},n.id))]}),visible:!0},{label:d.invoice_type,key:"sendType",component:k(O,{fluid:"true",getPopupContainer:n=>n.parentNode,children:[o(O.Option,{value:"",children:d.all},"invoice_type_0"),Ot.map(n=>o(O.Option,{value:n.id,children:n.name},n.id))]}),visible:!0},{label:d.send_result,key:"sendMailStatus",component:k(O,{fluid:"true",getPopupContainer:n=>n.parentNode,children:[o(O.Option,{value:"",children:d.all_result},"send_result_0"),Mt.map(n=>o(O.Option,{value:n.id,children:n.name},n.id))]}),visible:!0}],[]);return o(at,{initialValues:{...Ae},onSearch:a,layout:"vertical",filters:h,visibleFilterBox:!0})},Di=()=>{const{tableData:e}=p.useContext(se),[t]=ot();return o("div",{style:{display:"flex",flexDirection:"row",alignItems:"center"},children:k("span",{style:{fontWeight:t.fontWeightNormal,color:t.labelColor},children:[d.total," ",o("span",{style:{fontWeight:t.fontWeightBold,verticalAlign:"middle",color:t.blackColor},children:e.totalRecord})]})})},Ri=()=>{const e=et(),{layoutScrollRef:t}=p.useContext(Re),{filter:a,tablePagination:h,tableData:n,getsStatus:c,showFormPreview:i}=p.useContext(se),[r]=Be();p.useEffect(()=>{(async()=>await r({filterInp:a,tablePaginationInp:h}))()},[]);const l=async(m,f)=>{m!==h.current&&await r({filterInp:a,tablePaginationInp:{current:m,limit:h.limit}}),f!==h.limit&&await r({filterInp:a,tablePaginationInp:{current:h.current,limit:f}})},g=(m,f)=>{i({feeNotification:m,type:f})},u=[{key:"unit",dataIndex:"unit",title:d.unit,fixed:"left",width:150},{key:"code",dataIndex:"code",title:d.code,width:150,render:(m,f)=>o(Q,{onClick:()=>f.isShowAction&&g(f.feeNotification,fe),type:"link",style:{padding:0},children:m})},{key:"method",dataIndex:"method",title:d.send_method,width:150},{key:"type",dataIndex:"type",title:d.type,width:150},{key:"createdAt",dataIndex:"createdAt",title:d.sent_at,width:150},{key:"result",dataIndex:"result",title:d.send_result,width:150},{key:"sendResult",dataIndex:"sendResult",title:d.label.note,width:320},{key:"originalCode",dataIndex:"originalCode",title:d.invoice_original_code,width:200},{title:d.actions,key:"action",dataIndex:"action",align:"center",fixed:"right",width:108,render:(m,f,S)=>{if(f.typeRow!=="APARTMENT"){if(f.sendMethod===ie&&f.isShowAction)return k(q,{children:[o(G,{style:{fontSize:e.iconSize},title:d.label.send_email,name:"icon-mail-outlined",onClick:()=>g(f.feeNotification,ie)}),o(G,{style:{fontSize:e.iconSize,marginLeft:e.margin.xs},title:d.print,name:"icon-print-outlined",onClick:()=>g(f.feeNotification,J)})]});if(f.sendMethod===J&&f.isShowAction)return o(G,{style:{fontSize:e.iconSize},title:d.print,name:"icon-print-outlined",onClick:()=>g(f.feeNotification,J)});if(f.sendMethod===oe&&f.isShowAction)return o(G,{style:{fontSize:e.iconSize},title:d.label.sms,name:"icon-sms-outlined",onClick:()=>g(f.feeNotification,oe)})}return null}}],s={pageSize:h.limit,defaultCurrent:1,current:h.current,total:n.totalRecord,showQuickJumper:!0,showSizeChanger:!0,onChange:l};return o(_e,{border:!0,columns:u,dataSource:n.records,loading:c.isFetching,pagination:s,scroll:{x:u.reduce((m,f)=>m+f.width,0),scrollToFirstRowOnChange:!0},sticky:{offsetScroll:e.offsetScrollX,getContainer:()=>t.current},expandable:{defaultExpandAllRows:!0}})},Ce=async({idBuilding:e,invoiceType:t,sendMethod:a,totalInvoice:h,incurredCreatedFor:n,duePayment:c,roles:i=[]})=>{try{const r=await qt({idBuilding:e,feeNotification:{type:t,sendMethod:a,totalInvoice:h,incurredCreatedFor:n,duePayment:c?L(c).toDate():null,receiver:i!=null&&i.length?i==null?void 0:i.join("-"):null}});return{code:r.code,codeLanguage:r.codeLanguage,data:r.data}}catch({code:r,codeLanguage:l}){return{code:r,codeLanguage:l,data:{}}}},Ue=e=>{var y;const{filter:t,tablePagination:a}=p.useContext(se),{visible:h,onHide:n,feeNotification:c,idBuilding:i,type:r}=e,[l,g]=p.useState({isFetching:!1,code:void 0,codeLanguage:void 0}),[u,s]=p.useState({isFetching:!1,code:void 0,codeLanguage:void 0}),[m,f]=p.useState(),[S]=Be(),[F]=U.useForm();ce(l.code,l.codeLanguage),p.useEffect(()=>{(async()=>{g({code:void 0,codeLanguage:void 0,isFetching:!0});const{code:E,codeLanguage:D,data:T}=await si(i,c.id,r!==fe);f(T),g({code:E,codeLanguage:D,isFetching:!1})})()},[]),ce(u.code,u.codeLanguage,{message:d.success,description:d.success});const I=async()=>{var D,T,A;const E=await F.validateFields();if(E){s({isFetching:!0,code:void 0,codeLanguage:void 0});try{const N=await Ce({idBuilding:i,invoiceType:c==null?void 0:c.type,sendMethod:r,totalInvoice:1,incurredCreatedFor:c.incurredCreatedFor,duePayment:c.duePayment||null,roles:r===J?[]:E.roles});if(!Pe.includes(N.code)){s({isFetching:!1,code:N.code,codeLanguage:N.codeLanguage});return}let M;r===ie&&(M=await ci({feeNotificationIds:[c.id],idBuilding:i,invoiceGroupId:((D=N==null?void 0:N.data)==null?void 0:D.id)??null})),r===oe&&(M=await li({feeNotificationIds:[c.id],idBuilding:i,invoiceGroupId:((T=N==null?void 0:N.data)==null?void 0:T.id)??null})),r===J&&(M=await di({feeNotificationIds:[c.id],idBuilding:i,invoiceGroupId:((A=N==null?void 0:N.data)==null?void 0:A.id)??null}),Fe(M.data)),await S({filterInp:t,tablePaginationInp:{current:a.current,limit:a.limit}}),s({isFetching:!1,code:M.code,codeLanguage:M.codeLanguage})}catch(N){s({isFetching:!1,code:N.code,codeLanguage:N.codeLanguage})}}},C=()=>{n()},R=o(U,{form:F,name:"form_print_bill",layout:"vertical",initialValues:{roles:[]},children:[ie,oe].includes(r)?o(ke,{gutter:8,children:o(z,{span:24,children:o(U.Item,{name:"roles",label:d.receiver,rules:[{required:!0}],children:o(O,{fluid:"true",placeholder:d.receiver,mode:"multiple",children:nt.map(E=>o(O.Option,{value:E.id,children:E.name},E.id))})})})}):null}),P=o("div",{}),_=p.useMemo(()=>[ie,oe].includes(r)?d.invoice_resend:r===J?d.invoice_reprint:d.invoice_detail,[r]);return o(ct,{visible:h,title:_,loading:u.isFetching,footer:r===fe?null:k(q,{children:[o(Q,{type:"primary",ghost:!0,onClick:C,children:d.cancel}),o(Q,{loading:u.isFetching,type:"primary",onClick:I,children:(y=rt[r])==null?void 0:y.name})]}),onCancel:C,maskClosable:!u.isFetching,disabledButtonOk:u.isFetching,disabledButtonCancel:u.isFetching,isLoadingPreview:l.isFetching,beforePreview:R,afterPreview:P,html:m||"<div />"})};Ue.propTypes={idBuilding:$.instanceOf([$.number,$.string]),visible:$.bool.isRequired,onHide:$.func.isRequired,feeNotification:$.objectOf($.any),type:$.string};Ue.defaultProps={idBuilding:0,feeNotification:void 0,type:fe};const Li=()=>{const{hideFormHistory:e}=p.useContext(H),{formPreview:t,hideFormPreview:a,idBuilding:h}=p.useContext(se);return o(Le,{width:"80%",open:!0,title:d.invoice_sending_history,footer:null,onCancel:e,children:k("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:[o(xi,{}),k(ee,{style:{flex:1},children:[o(ee.Header,{children:o(Di,{})}),o(ee.Content,{fluid:!0,children:o(Ri,{})})]}),t.isShow?o(Ue,{idBuilding:h,onHide:a,type:t.data.type,feeNotification:t.data.feeNotification,visible:!0}):null]})})},Oi=()=>o(Ye,{children:o(Li,{})}),X=p.createContext({formSelect:void 0,selectedForm:{operationType:st,feeNotificationType:K,duePayment:L().endOf("months"),remindDebtTimes:be,feeNoticePeriod:L()},setSelectedForm:()=>{},getListUnitsStatus:{isFetching:!1},setGetListUnitsStatus:()=>{},filter:{unitName:void 0},setFilter:()=>{},units:[],setUnits:()=>{},formPreviewFee:void 0,showFormPreviewFee:()=>{},hideFormPreviewFee:()=>{},formUnitList:void 0,showFormUnitList:()=>{},hideFormUnitList:()=>{},feeNotificationSendStatus:{isFetching:!1,code:void 0,codeLanguage:void 0},setFeeNotificationSendStatus:()=>{},feeNotificationGroup:null,setFeeNotificationGroup:()=>{}}),dt=e=>{const{children:t}=e,[a]=U.useForm(),[h,n]=p.useState({isFetching:!1}),[c,i]=p.useState([]),[r,l]=p.useState({unitName:void 0}),[g,u]=p.useState({operationType:st,feeNotificationType:K,duePayment:L().endOf("months"),remindDebtTimes:void 0,feeNoticePeriod:L()}),[s,m]=p.useState({isFetching:!1,code:void 0,codeLanguage:void 0}),[f,S]=p.useState(null),[F,I,C]=te(),[R,P,_]=te(),y={formSelect:a,getListUnitsStatus:h,setGetListUnitsStatus:n,filter:r,setFilter:l,units:c,setUnits:i,formPreviewFee:F,showFormPreviewFee:I,hideFormPreviewFee:C,formUnitList:R,showFormUnitList:P,hideFormUnitList:_,selectedForm:g,setSelectedForm:u,feeNotificationSendStatus:s,setFeeNotificationSendStatus:m,feeNotificationGroup:f,setFeeNotificationGroup:S};return o(X.Provider,{value:y,children:t})};dt.propTypes={children:$.node.isRequired};const Mi=async({bills:e,idBuilding:t,incurredCreatedFor:a,unitId:h,invoiceType:n,remindDebtTimes:c,duePayment:i,operationType:r})=>{try{let l;return r===de&&(l=await ui({bills:e,idBuilding:t,incurredCreatedFor:a,unitId:h,remindDebtTimes:c,duePayment:L(i).toDate()})),r!==de&&(l=await mi({bills:e,idBuilding:t,incurredCreatedFor:a,unitId:h,remindDebtTimes:c,duePayment:L(i).toDate()})),{code:l.code,codeLanguage:l.codeLanguage,data:l.data}}catch(l){return{code:l.code,codeLanguage:l.codeLanguage,data:void 0}}},ki=()=>{const{idBuilding:e}=p.useContext(H),{hideFormPreviewFee:t,formPreviewFee:a,selectedForm:h}=p.useContext(X),[n,c]=p.useState({isFetching:!1,code:void 0,codeLanguage:void 0}),[i,r]=p.useState();ce(n.code,n.codeLanguage),p.useEffect(()=>{(async()=>{const{feeNoticePeriod:g,feeNotificationType:u,duePayment:s,remindDebtTimes:m,operationType:f}=h,S=L(g).startOf("month").format("YYYYMM");c({isFetching:!0,code:void 0,codeLanguage:void 0});const{billIds:F,unitId:I}=a==null?void 0:a.data,C=await Mi({bills:F,unitId:I,idBuilding:e,incurredCreatedFor:S,invoiceType:u,remindDebtTimes:m,duePayment:s,operationType:f});r(C.data),c({isFetching:!1,code:C.code,codeLanguage:C.codeLanguage})})()},[]);const l=()=>{t()};return{loadingPreview:n.isFetching,handleCancelProcessPreview:l,previewData:i}},Ai=()=>{const{handleCancelProcessPreview:e,loadingPreview:t,previewData:a}=ki();return o(ct,{visible:!0,title:d.invoice,onCancel:e,isLoadingPreview:t,html:a||"<div />",footer:!1})},Yi=20,Bi=()=>{var g,u;const{formUnitList:e,hideFormUnitList:t}=p.useContext(X),[a,h]=p.useState({current:B,limit:Yi}),[n,c]=p.useState([]),i=(u=(g=e==null?void 0:e.data)==null?void 0:g.units)==null?void 0:u.map((s,m)=>({key:m,id:m+1,name:s==null?void 0:s.name}));p.useEffect(()=>{const{limit:s,current:m}=a,f=s*(m-1),S=i.slice(f,s*m);c(S)},[]);const r=(s,m)=>{let{limit:f,current:S}=a;S!==s?S=s:f!==m&&(S=B,f=m),h({limit:f,current:S});const F=f*(s-1),I=i.slice(F,f*s);c(I)},l={pageSize:a.limit,defaultCurrent:B,current:a.current,total:i==null?void 0:i.length,onChange:r};return{hideFormUnitList:t,dataSource:n,pagination:l}},Ui=()=>{const{hideFormUnitList:e,dataSource:t,pagination:a}=Bi(),h=[{key:"id",dataIndex:"id",title:d.ordinal_numbers,width:150},{key:"name",dataIndex:"name",title:d.unit}];return o(Le,{title:d.unit_list,footer:null,open:!0,onCancel:e,children:o(_e,{columns:h,dataSource:t,pagination:a})})},Hi=()=>{const{formSend:e,tableData:t,idBuilding:a}=p.useContext(H),{selectedForm:h,formSelect:n,units:c,setFeeNotificationGroup:i}=p.useContext(X),[r,l]=p.useState(0),[g,u]=p.useState({isFetching:!1,code:void 0,codeLanguage:void 0}),{totalRecord:s}=t,{isAll:m}=e==null?void 0:e.data,{operationType:f,feeNotificationType:S,remindDebtTimes:F,feeNoticePeriod:I,duePayment:C,roles:R}=h,P=m?s:c==null?void 0:c.length;ce(g.code,g.codeLanguage);const _=()=>{Ut({isAll:!1,onOk:async()=>{u({isFetching:!0});const D=await Ce({idBuilding:a,invoiceType:S===K?S:F,sendMethod:f,totalInvoice:P,incurredCreatedFor:L(I).startOf("month").format("YYYYMM"),duePayment:C,roles:R});u({isFetching:!1,code:D.code,codeLanguage:D.codeLanguage}),Pe.includes(D.code)&&(i(D.data),l(r+1))},questionText:d.when_you_press_the_confirm_button_the_system_will_proceed_to_send_the_fee_notification_are_you_sure_you_want_to_proceed,totalItem:1})};return{nextStep:async()=>{if(await(n==null?void 0:n.validateFields())){if(r===1){if([Oe,de].includes(f)){_();return}if(f===ne){u({isFetching:!0});const T=await Ce({idBuilding:a,invoiceType:S===K?S:F,sendMethod:f,totalInvoice:P,incurredCreatedFor:L(I).startOf("month").format("YYYYMM"),duePayment:C});u({isFetching:!1,code:T.code,codeLanguage:T.codeLanguage}),Pe.includes(T.code)&&(i(T.data),l(r+1))}}r!==1&&l(r+1)}},prevStep:()=>{l(r-1)},current:r,operationType:f,loadingNextStep:g.isFetching}},$i=(e,t)=>{const a=e.split("{icon}");return k(q,{children:[a[0],t,a[1]]})},Je=async({idBuilding:e,feeNoticePeriod:t,unitsPerPage:a,duePayment:h,remindDebtTimes:n,idFeeNotificationGroup:c})=>{const i=h?L(h).toDate():void 0,r=L(t).startOf("month").format("YYYYMM");try{const l=await hi({duePayment:i,idBuilding:e,incurredCreatedFor:r,remindDebtTimes:n,targets:a,invoiceGroupId:c});return{code:l.code,codeLanguage:l.codeLanguage,data:l.data}}catch({code:l,codeLanguage:g}){return{code:l,codeLanguage:g,data:""}}},Te=20,Ke=60,Vi=async({isAll:e,idBuilding:t,invoiceType:a,remindDebtTimes:h,filterObject:n,feeNoticePeriod:c,units:i,duePayment:r,setFeeNotificationSendProgress:l,totalRecord:g,feeNotificationGroup:u})=>{var S,F,I,C,R,P;let s=0;const m={};let f=0;if(e){const _=Math.ceil(g/Te);let y=1;for(;y<=_;){const E=await ae({filter:n,idBuilding:t,limit:Te,page:y});if(((S=E==null?void 0:E.data)==null?void 0:S.length)>0){const D=((F=E==null?void 0:E.data)==null?void 0:F.map(A=>({name:A==null?void 0:A.name,floorName:A==null?void 0:A.floorName,unitId:A==null?void 0:A.unitId,bills:(A==null?void 0:A.billIds)||[]})))||[],T=await Je({duePayment:r,feeNoticePeriod:c,idBuilding:t,invoiceType:a,remindDebtTimes:h,unitsPerPage:D,idFeeNotificationGroup:(u==null?void 0:u.id)||null});m[f]||(m[f]={html:"",total:0,units:[]}),m[f].html+=T.data,m[f].total+=D.length,m[f].units=m[f].units.concat(D),m[f].total>=Ke&&(f+=1)}l(Math.floor(y*100/_)),y+=1}}if(!e){let _=[];for(let y=0;y<(i==null?void 0:i.length);y+=1)if(_.push({name:(I=i[y])==null?void 0:I.unitName,floorName:(C=i[y])==null?void 0:C.floorName,unitId:(R=i[y])==null?void 0:R.unitId,bills:((P=i[y])==null?void 0:P.billIds)||[]}),_.length===Te||y===i.length-1){s+=_.length;const E=await Je({duePayment:r,feeNoticePeriod:c,idBuilding:t,invoiceType:a,remindDebtTimes:h,unitsPerPage:_,idFeeNotificationGroup:(u==null?void 0:u.id)||null});m[f]||(m[f]={html:"",total:0,units:[]}),m[f].html+=E.data,m[f].total+=_.length,m[f].units=m[f].units.concat(_),m[f].total>=Ke&&(f+=1),_=[],l(Math.floor(s*100/i.length))}}return m},Qe=async({idBuilding:e,feeNoticePeriod:t,unitsPerPage:a,duePayment:h,remindDebtTimes:n,idFeeNotificationGroup:c})=>{const i=h?L(h).toDate():void 0,r=L(t).startOf("month").format("YYYYMM");try{const l=await fi({duePayment:i,idBuilding:e,incurredCreatedFor:r,remindDebtTimes:n,targets:a,invoiceGroupId:c});return{code:l.code,codeLanguage:l.codeLanguage,data:l.data}}catch({code:l,codeLanguage:g}){return{code:l,codeLanguage:g,data:""}}},Ie=20,zi=async({isAll:e,idBuilding:t,invoiceType:a,remindDebtTimes:h,filterObject:n,feeNoticePeriod:c,units:i,duePayment:r,setFeeNotificationSendProgress:l,totalRecord:g,feeNotificationGroup:u})=>{var f,S,F,I,C,R;let s=0;const m={code:500,codeLanguage:null};if(e){const P=Math.ceil(g/Ie);let _=1;for(;_<=P;){const y=await ae({filter:n,idBuilding:t,limit:Ie,page:_});if(((f=y==null?void 0:y.data)==null?void 0:f.length)>0){const E=((S=y==null?void 0:y.data)==null?void 0:S.map(T=>({name:T==null?void 0:T.name,floorName:T==null?void 0:T.floorName,unitId:T==null?void 0:T.unitId,bills:(T==null?void 0:T.billIds)||[]})))||[],D=await Qe({duePayment:r,feeNoticePeriod:c,idBuilding:t,invoiceType:a,remindDebtTimes:h,unitsPerPage:E,idFeeNotificationGroup:(u==null?void 0:u.id)||null});m.code=D.code,m.codeLanguage=D.codeLanguage}l(Math.floor(_*100/P)),_+=1}}if(!e){let P=[];for(let _=0;_<(i==null?void 0:i.length);_+=1)if(P.push({name:(F=i[_])==null?void 0:F.unitName,floorName:(I=i[_])==null?void 0:I.floorName,unitId:(C=i[_])==null?void 0:C.unitId,bills:((R=i[_])==null?void 0:R.billIds)||[]}),P.length===Ie||_===i.length-1){s+=P.length;const y=await Qe({duePayment:r,feeNoticePeriod:c,idBuilding:t,invoiceType:a,remindDebtTimes:h,unitsPerPage:P,idFeeNotificationGroup:(u==null?void 0:u.id)||null});m.code=y==null?void 0:y.code,m.codeLanguage=y==null?void 0:y.codeLanguage,P=[],l(Math.floor(s*100/i.length))}}return m},Xe=async({idBuilding:e,feeNoticePeriod:t,unitsPerPage:a,duePayment:h,remindDebtTimes:n,idFeeNotificationGroup:c})=>{const i=h?L(h).toDate():void 0,r=L(t).startOf("month").format("YYYYMM");try{const l=await gi({duePayment:i,idBuilding:e,incurredCreatedFor:r,targets:a,remindDebtTimes:n,invoiceGroupId:c});return{code:l.code,codeLanguage:l.codeLanguage,data:l.data}}catch({code:l,codeLanguage:g}){return{code:l,codeLanguage:g,data:""}}},Ne=20,Gi=async({isAll:e,idBuilding:t,invoiceType:a,remindDebtTimes:h,filterObject:n,feeNoticePeriod:c,units:i,duePayment:r,setFeeNotificationSendProgress:l,totalRecord:g,feeNotificationGroup:u})=>{var f,S,F,I,C,R;let s=0;const m={code:500,codeLanguage:null};if(e){const P=Math.ceil(g/Ne);let _=1;for(;_<=P;){const y=await ae({filter:n,idBuilding:t,limit:Ne,page:_});if(((f=y==null?void 0:y.data)==null?void 0:f.length)>0){const E=((S=y==null?void 0:y.data)==null?void 0:S.map(T=>({name:T==null?void 0:T.name,floorName:T==null?void 0:T.floorName,unitId:T==null?void 0:T.unitId,bills:(T==null?void 0:T.billIds)||[]})))||[],D=await Xe({duePayment:r,feeNoticePeriod:c,idBuilding:t,invoiceType:a,remindDebtTimes:h,unitsPerPage:E,idFeeNotificationGroup:(u==null?void 0:u.id)||null});m.code=D.code,m.codeLanguage=D.codeLanguage}l(Math.floor(_*100/P)),_+=1}}if(!e){let P=[];for(let _=0;_<(i==null?void 0:i.length);_+=1)if(P.push({name:(F=i[_])==null?void 0:F.unitName,floorName:(I=i[_])==null?void 0:I.floorName,unitId:(C=i[_])==null?void 0:C.unitId,bills:((R=i[_])==null?void 0:R.billIds)||[]}),P.length===Ne||_===i.length-1){s+=P.length;const y=await Xe({duePayment:r,feeNoticePeriod:c,idBuilding:t,invoiceType:a,remindDebtTimes:h,unitsPerPage:P,idFeeNotificationGroup:(u==null?void 0:u.id)||null});m.code=y==null?void 0:y.code,m.codeLanguage=y==null?void 0:y.codeLanguage,P=[],l(Math.floor(s*100/i.length))}}return m},Wi=()=>{const{formSend:e,filter:t,tablePagination:a,tableData:h,idBuilding:n}=p.useContext(H),{selectedForm:c,units:i,showFormUnitList:r,feeNotificationSendStatus:l,setFeeNotificationSendStatus:g,feeNotificationGroup:u}=p.useContext(X),{changeDataTable:s}=ye(),m=it(),[f,S]=p.useState(0),[F,I]=p.useState([]),{totalRecord:C}=h,{isAll:R}=e==null?void 0:e.data,{operationType:P,feeNotificationType:_,remindDebtTimes:y,feeNoticePeriod:E,duePayment:D}=c;p.useEffect(()=>{const v=b=>{b.preventDefault(),b.returnValue=""};return window.addEventListener("beforeunload",v),()=>{window.removeEventListener("beforeunload",v)}},[]),ce(l.code,l.codeLanguage,{message:d.success,description:d.sent_successfully},()=>{g({isFetching:!1,code:void 0,codeLanguage:void 0})});const T=async()=>{m({action:kt,label:ve}),S(0),g({isFetching:!0});const v=await Vi({isAll:R,idBuilding:n,invoiceType:_,remindDebtTimes:y,filterObject:t,feeNoticePeriod:E,units:i,duePayment:D,setFeeNotificationSendProgress:S,totalRecord:C,feeNotificationGroup:u}),b=Object.keys(v).map((w,Z)=>({key:Z,index:Z,apartmentList:`${v[w].units[0].name} - ${v[w].units[v[w].units.length-1].name}`,numberOfInvoice:v[w].units.length,status:jt,html:v[w].html,units:v[w].units}));I(b),b.length===1&&(Fe(b[0].html),I([{...b[0],status:pe}])),g({isFetching:!1}),await s({filter:t,isResetTableSelection:!0,tablePagination:{current:a.current,limit:a.limit}})},A=async()=>{m({action:Ge,label:ve}),S(0),g({isFetching:!0,code:void 0,codeLanguage:void 0});const{code:v,codeLanguage:b}=await zi({isAll:R,idBuilding:n,invoiceType:_,remindDebtTimes:y,filterObject:t,feeNoticePeriod:E,units:i,duePayment:D,setFeeNotificationSendProgress:S,totalRecord:C,feeNotificationGroup:u});g({isFetching:!1,code:v,codeLanguage:b}),await s({filter:t,isResetTableSelection:!0,tablePagination:{current:a.current,limit:a.limit}})},N=async()=>{m({action:Ge,label:ve}),S(0),g({isFetching:!0,code:void 0,codeLanguage:void 0});const{code:v,codeLanguage:b}=await Gi({isAll:R,idBuilding:n,invoiceType:_,remindDebtTimes:y,filterObject:t,feeNoticePeriod:E,units:i,duePayment:D,setFeeNotificationSendProgress:S,totalRecord:C,feeNotificationGroup:u});g({isFetching:!1,code:v,codeLanguage:b}),await s({filter:t,isResetTableSelection:!0,tablePagination:{current:a.current,limit:a.limit}})},M=v=>()=>{Fe(v.html);const b={...v,status:pe},{index:w}=b,Z=[...F];Z.splice(w,1,b),I(Z)},x=v=>{r(v)};return p.useEffect(()=>{P===ne&&T(),P===Oe&&A(),P===de&&N()},[]),{loadingSend:l.isFetching,percent:f,dataSource:F,operationType:P,onClickPrintPage:M,handleShowUnitListModal:x}},qi=()=>{const{loadingSend:e,percent:t,dataSource:a,operationType:h,onClickPrintPage:n,handleShowUnitListModal:c}=Wi(),i=[{title:"#",dataIndex:"index",key:"index",render:l=>Number(l)+1},{title:d.unit_list,dataIndex:"apartmentList",key:"apartmentList",render:(l,g)=>k(Q,{type:"link",style:{paddingLeft:0},onClick:()=>{c(g)},children:[l," ",o(G,{name:"icon-eye-outlined"})]})},{title:d.label.number_of_invoice,dataIndex:"numberOfInvoice",key:"numberOfInvoice",render:l=>pi(l)},{title:d.label.status,dataIndex:"status",key:"status",render:l=>o(Y.Text,{strong:!0,style:{color:l===pe?"#52c41a":"#ff4d4f"},children:l===pe?d.label.printed:d.label.not_printed})},{title:d.action,dataIndex:"action",key:"action",align:"center",render:(l,g)=>o(G,{title:d.print,onClick:n(g),name:"icon-print-outlined",css:u=>({fontSize:u.iconSize})})}],r=p.useMemo(()=>{const l={percent:t,loading:e,title:"",subTitle:"",extra:null};return h===Oe&&(l.title=!e&&t===100?o(q,{children:d.the_invoice_is_created_successfully_the_system_is_in_the_process_of_sending_it_to_the_residents_email}):o(he,{message:d.please_do_not_close_this_window_until_system_completes,type:"warning"}),l.subTitle=!e&&t===100?d.you_can_close_the_web_window_after_completion_the_system_will_send_an_email_with_the_results_of_the_invoice_sending:""),h===de&&(l.title=!e&&t===100?o(q,{children:d.the_invoice_is_created_successfully_the_system_is_in_the_process_of_sending_it_to_the_residents_sms}):o(he,{message:d.please_do_not_close_this_window_until_system_completes,type:"warning"})),h===ne&&(l.title=!e&&t===100?$i(d.the_invoice_is_created_successfully_please_click_the_button_to_proceed_to_print_the_invoice,o(G,{name:"icon-print-outlined",style:{fontSize:"24px"}})):o(he,{message:d.please_do_not_close_this_window_until_system_completes,type:"warning"}),l.extra=!e&&t===100?o(_e,{columns:i,dataSource:a,pagination:!1},"table"):null),l},[h,e,a,t]);return o("div",{children:o(oi,{icon:o(ni,{type:"circle",percent:r.percent,strokeColor:{"0%":"#108ee9","100%":"#87d068"}}),title:r.title,subTitle:r.subTitle,extra:[r.extra]})})},ji=e=>{const t={};return t.totalMustPay=(e==null?void 0:e.total)??0,t.totalDebt=(e==null?void 0:e.debt)??0,t.totalExpectedReceivable=(e==null?void 0:e.period)??0,t.totalBalance=(e==null?void 0:e.balance)??0,{...e,totalRow:t}},Ze=async({idBuilding:e,filter:t})=>{var a;try{const{code:h,codeLanguage:n,data:c}=await ei({filter:{unitName:t!=null&&t.unitName?t==null?void 0:t.unitName:void 0,incurredCreatedFor:t==null?void 0:t.incurredCreatedFor,paymentStatus:tt,status:Ee,state:t!=null&&t.states&&((a=t==null?void 0:t.states)!=null&&a.length)?t.states:[xe,De]},idBuilding:e});return{code:h,codeLanguage:n,data:ji(c)}}catch({code:h,codeLanguage:n}){return{code:h,codeLanguage:n,data:0}}},Ji=()=>{const{formSend:e,filter:t,idBuilding:a}=p.useContext(H),{showFormPreviewFee:h,units:n,setUnits:c,selectedForm:i,setGetListUnitsStatus:r,getListUnitsStatus:l}=p.useContext(X),[g,u]=p.useState({current:B,limit:me}),{bills:s,isAll:m}=e==null?void 0:e.data,[f,S]=p.useState({totalMustPay:0,totalDebt:0,totalExpectedReceivable:0,totalBalance:0}),[F,I]=p.useState([]),[C,R]=p.useState(0),{feeNoticePeriod:P}=i,_=L(P).startOf("month").format("YYYYMM");p.useEffect(()=>{const N={...f},{limit:M,current:x}=g;if(!m){r({isFetching:!0});const v={};s==null||s.forEach(ut=>{const{unitId:W,total:j,incurredCreatedFor:He,floorName:mt,unitName:ht,id:$e,balance:ue}=ut;v[W]&&(N.totalMustPay+=j,v[W].totalMustPay+=j,v[W].billIds.push($e)),v[W]||(v[W]={key:W,unitId:W,totalDebt:0,totalExpectedReceivable:0,floorName:mt,unitName:ht,totalBalance:ue,totalMustPay:j-ue,billIds:[$e]},N.totalBalance+=ue,N.totalMustPay+=j-ue),Number(_)>Number(He)&&(v[W].totalDebt+=j,N.totalDebt+=j),Number(_)<=Number(He)&&(v[W].totalExpectedReceivable+=j,N.totalExpectedReceivable+=j)});const b=gt.orderBy(Object.values(v)||[],["floorName","unitName"],["asc","asc"]),w=M*(x-1),Z=b.slice(w,M*x);I(Z),c(b),S(N),R(b.length),r({isFetching:!1})}m&&(async()=>{var w;r({isFetching:!0});const[v,b]=await Promise.all([ae({filter:{...t},idBuilding:a,limit:M,page:x,incurredCreatedFor:_}),Ze({idBuilding:a,filter:{...t,incurredCreatedFor:_}})]);c((v==null?void 0:v.data)||[]),I((v==null?void 0:v.data)||[]),R((v==null?void 0:v.totalRecord)||0),S((w=b==null?void 0:b.data)==null?void 0:w.totalRow),r({isFetching:!1})})()},[]);const y=N=>{h({...N})},E=async N=>{var M;if(u({current:B,limit:me}),!m){r({isFetching:!0});const x={totalMustPay:0,totalDebt:0,totalExpectedReceivable:0,totalBalance:0};let v=n||[];N&&N.unitName&&!t.unitName&&(v=[],n.forEach(w=>{qe(w.unitName).includes(qe(N.unitName))&&(x.totalMustPay+=(w==null?void 0:w.totalMustPay)??0,x.totalDebt+=(w==null?void 0:w.totalDebt)??0,x.totalExpectedReceivable+=(w==null?void 0:w.totalExpectedReceivable)??0,x.totalBalance+=(w==null?void 0:w.totalBalance)??0,v.push(w))})),(!N||!N.unitName)&&n.forEach(w=>{x.totalMustPay+=(w==null?void 0:w.totalMustPay)??0,x.totalDebt+=(w==null?void 0:w.totalDebt)??0,x.totalExpectedReceivable+=(w==null?void 0:w.totalExpectedReceivable)??0,x.totalBalance+=(w==null?void 0:w.totalBalance)??0});const b=v.slice(0,me*B);S(x),I(b),R(v.length),await je(400),r({isFetching:!1})}if(m){r({isFetching:!0});const[x,v]=await Promise.all([ae({filter:{...N},idBuilding:a,limit:me,page:B,incurredCreatedFor:_}),Ze({idBuilding:a,filter:{...N,incurredCreatedFor:_}})]);c((x==null?void 0:x.data)||[]),I((x==null?void 0:x.data)||[]),R((x==null?void 0:x.totalRecord)||0),S((M=v==null?void 0:v.data)==null?void 0:M.totalRow),r({isFetching:!1})}},D={unitName:t==null?void 0:t.unitName},T=async(N,M)=>{let{limit:x,current:v}=g;if(v!==N?v=N:x!==M&&(v=B,x=M),u({limit:x,current:v}),r({isFetching:!0}),m){const b=await ae({filter:{...t},idBuilding:a,limit:x,page:v,incurredCreatedFor:_});c((b==null?void 0:b.data)||[]),I((b==null?void 0:b.data)||[]),R((b==null?void 0:b.totalRecord)||0)}if(!m){const b=x*(N-1),w=n.slice(b,x*N);I(w),await je(400)}r({isFetching:!1})},A={pageSize:g.limit,defaultCurrent:B,current:g.current,total:C,onChange:T,showQuickJumper:!1,showSizeChanger:!0};return{dataSource:F,totalRecord:C,totalRow:f,onClickBtnPreview:y,loading:l.isFetching,onSearch:E,initialValuesFilter:D,pagination:A}},Ki=()=>{const{dataSource:e,totalRow:t,onClickBtnPreview:a,totalRecord:h,onSearch:n,initialValuesFilter:c,loading:i,pagination:r}=Ji(),l=[{title:d.unit,key:"unitName",width:120,fixed:"left",children:[{title:d.total,key:"total",dataIndex:"unitName",width:150}]},{title:d.floor,key:"floorName",dataIndex:"floorName",width:120},{title:d.debt,key:"totalDebt",width:150,align:"right",children:[{title:o(Y.NegativeNumber,{children:(t==null?void 0:t.totalDebt)??0}),key:"totalDebt",dataIndex:"totalDebt",width:150,align:"right",render:u=>o(Y.NegativeNumber,{children:u})}]},{title:d.expected_receivable,key:"totalExpectedReceivable",width:150,align:"right",children:[{title:o(Y.NegativeNumber,{children:(t==null?void 0:t.totalExpectedReceivable)??0}),key:"totalExpectedReceivable",dataIndex:"totalExpectedReceivable",width:150,align:"right",render:u=>o(Y.NegativeNumber,{children:u})}]},{title:d.label.total_service_advance_payment,key:"totalBalance",width:150,align:"right",children:[{title:o(Y.NegativeNumber,{children:(t==null?void 0:t.totalBalance)??0}),key:"totalBalance",dataIndex:"totalBalance",width:150,align:"right",render:u=>o(Y.NegativeNumber,{children:u})}]},{title:d.total,key:"totalMustPay",width:150,align:"right",children:[{title:o(Y.NegativeNumber,{children:(t==null?void 0:t.totalMustPay)??0}),key:"totalMustPay",dataIndex:"totalMustPay",width:150,align:"right",render:u=>o(Y.NegativeNumber,{children:u})}]},{title:d.action,key:"action",dataIndex:"action",width:70,align:"center",fixed:"right",render:(u,s)=>o(G,{onClick:()=>a(s),name:"icon-eye-outlined",css:m=>({fontSize:m.iconSize}),title:d.label.preview})}],g=[{label:d.unit,key:"unitName",component:o(Se,{placeholder:d.unit,disabled:c==null?void 0:c.unitName}),visible:!0}];return k(q,{children:[o(at,{initialValues:c,filters:g,onSearch:Ht(n),visibleFilterBox:!0,size:"small",onRefresh:n}),k(V.Container,{children:[o(V.Header,{children:o(V.ActionBox,{total:h})}),o(V.Content,{children:o(V.Table,{columns:l,dataSource:e,pagination:r,loading:i})})]})]})},Qi=()=>{const{setSelectedForm:e,formSelect:t,selectedForm:a}=p.useContext(X),h=(c,i)=>{const r={...a,...i};c!=null&&c.feeNotificationType&&(t.setFieldsValue({remindDebtTimes:(c==null?void 0:c.feeNotificationType)!==K?be:void 0}),r.remindDebtTimes=(c==null?void 0:c.feeNotificationType)!==K?be:null),c!=null&&c.operationType&&(t.setFieldsValue({roles:(c==null?void 0:c.operationType)!==ne?[We]:[]}),r.roles=(c==null?void 0:c.operationType)!==ne?[We]:[]),e(r)};p.useEffect(()=>{t.setFieldsValue({...a})},[]);const n={operationType:ne,feeNotificationType:K,duePayment:L().endOf("months"),remindDebtTimes:void 0,feeNoticePeriod:L()};return{selectedForm:a,formSelect:t,initialValues:n,onValuesChange:h}},Xi=()=>{const{selectedForm:e,formSelect:t,initialValues:a,onValuesChange:h}=Qi();return o(U,{initialValues:a,form:t,name:"formSelect",layout:"vertical",onValuesChange:h,children:k(ke,{gutter:[12,0],children:[o(z,{span:12,children:o(U.Item,{rules:[{required:!0}],label:d.operation_type,name:"operationType",children:o(O,{showSearch:!1,fluid:"true",placeholder:d.operation_type,getPopupContainer:n=>n.parentNode,children:Jt.map(n=>o(O.Option,{value:n.id,children:n.name},n.id))})})}),(e==null?void 0:e.operationType)!==ne?o(z,{span:12,children:o(U.Item,{name:"roles",label:d.receiver,rules:[{required:!0}],children:o(O,{fluid:"true",placeholder:d.receiver,mode:"multiple",children:nt.map(n=>o(O.Option,{value:n.id,children:n.name},n.id))})})}):o(z,{span:12}),o(z,{span:12,children:o(U.Item,{rules:[{required:!0}],label:d.invoice_type,name:"feeNotificationType",children:o(O,{showSearch:!1,fluid:"true",placeholder:d.invoice_type,getPopupContainer:n=>n.parentNode,children:At.map(n=>o(O.Option,{value:n.id,children:n.name},n.id))})})}),(e==null?void 0:e.feeNotificationType)!==K?o(z,{span:12,children:o(U.Item,{label:d.remind_debt_times,name:"remindDebtTimes",rules:[{required:!0}],children:o(O,{style:{width:"100%"},children:Yt.map(n=>o(O.Option,{value:n.id,children:n.name},n.id))})})}):o(z,{span:12}),o(z,{span:12,children:o(U.Item,{label:d.invoice_period,name:"feeNoticePeriod",rules:[{required:!0}],children:o(ge,{fluid:"true",picker:"month",allowClear:!1,format:"MM/YYYY"})})}),o(z,{span:12,children:o(U.Item,{label:d.label.payment_due_date,name:"duePayment",rules:[{required:!0}],children:o(ge,{fluid:"true",allowClear:!1,format:"DD/MM/YYYY"})})})]})})},Zi=()=>{var r,l;const{current:e,prevStep:t,nextStep:a,operationType:h,loadingNextStep:n}=Hi(),[c]=ot(),i=[{key:"select_send_method",title:d.select_send_method,content:o(Xi,{})},{key:"verify_information",title:d.verify_information,content:o(Ki,{})},{key:"result",title:d.result,content:o(qi,{})}];return k(q,{children:[o(ee,{style:{marginBottom:c.marginSm},children:o(ee.Content,{style:{display:"flex",alignItems:"center"},children:o(ai,{current:e,items:i})})}),o(ee,{children:k(ee.Content,{children:[o(ke,{gutter:[12,0],children:o(z,{span:24,children:i[e].content})}),k("div",{style:{textAlign:"right",marginTop:c.marginSm},children:[e>0&&e!==i.length-1&&o(Q,{style:{margin:"0 8px"},onClick:()=>t(),children:d.button.back}),e<i.length-1&&o(Q,{type:"primary",onClick:()=>a(),loading:n,children:e===1?(l=(r=rt)==null?void 0:r[h])==null?void 0:l.name:d.button.next})]})]})})]})},eo=()=>{const{hideFormSend:e}=p.useContext(H),{selectedForm:t,formPreviewFee:a,feeNotificationSendStatus:h,formUnitList:n}=p.useContext(X);return{selectedForm:t,formPreviewFee:a,handleHideFormConfirm:()=>{h.isFetching||e()},isShowUnitListModal:n==null?void 0:n.isShow,isShowFormPreviewFee:a==null?void 0:a.isShow}},to=()=>{const{handleHideFormConfirm:e,isShowUnitListModal:t,isShowFormPreviewFee:a}=eo();return k(q,{children:[o(Le,{width:"80%",open:!0,title:d.send_invoices,footer:!1,onCancel:e,children:o(Zi,{})}),a?o(Ai,{}):null,t?o(Ui,{}):null]})},io=()=>o(dt,{children:o(to,{})}),oo=()=>{const{isRemindDebt:e}=$t(),{setTitlePage:t,setVisibleFilterBox:a,setVisibleSearchBox:h}=p.useContext(Re),{formHistory:n,formSend:c}=p.useContext(H),{changeDataTable:i,changeTotal:r}=ye();return p.useEffect(()=>(t(d.send_invoices),h(!0),(async()=>(i({filter:le,isResetTableSelection:!0,tablePagination:{current:B,limit:re}}),r({filter:le})))(),()=>{t(""),h(!1),a(!1)}),[]),[e,n.isShow,c.isShow]},no=ft("div",{target:"e1qjfkl70"})({name:"pr10xp",styles:"margin-bottom:10px"}),ao=()=>{const[e,t,a]=oo();return k(q,{children:[e&&o(no,{children:o(he,{type:"warning",message:d.label.debt_invoice_warning,closable:!0,showIcon:!0})}),k(V.Wrapper,{children:[o(Ii,{}),k(V.Container,{children:[o(V.Header,{children:o(Pi,{})}),o(V.Content,{children:o(Fi,{})})]}),t&&o(Oi,{}),a&&o(io,{})]})]})},Kn=()=>o(_i,{children:o(ao,{})});export{Kn as default};
