import{j as i,a as A,u as fe,F as Ve}from"./@emotion-63839449.js";import{d as ve,l as ce,D as Ee,P as ee,a as De}from"./index-b17d22e5.js";import{r as f}from"./react-4fd50329.js";import{n as Ie}from"./lodash-88fe09e6.js";import{h as w}from"./moment-a468e1f9.js";import{a9 as Y,s as L,b0 as Ne,K as he,aP as Oe,ag as Qe,aN as $e,at as Ge,bv as Ke,dk as He,gk as We,l as s,gl as ze,a3 as be,I as le,dq as Xe,a5 as ue,bG as Je,a0 as Ze,a as Ye,bH as je,gm as et,gn as tt,S as ye,go as at,gp as st}from"./index-c2ded735.js";import"./file-saver-40cf32a9.js";import{I as Le,S as Q}from"./index-43183512.js";import{R as ge,D as te,a as $,b as it,c as nt,d as _e,e as Ce,f as ot,g as rt,h as ct,i as qe}from"./constant-e1099cfb.js";import{c as Se}from"./compareObject-7b349d22.js";import{F as G,u as pe}from"./index-687ba9e6.js";import"./react-redux-896b353b.js";import"./@firebase-43527ee1.js";import{P as se}from"./prop-types-1172f4d5.js";import{u as dt,a as lt}from"./react-router-a4308f7b.js";import{c as ut,g as me,a as we,F as Fe,u as pt}from"./updateRequest-0c593df4.js";import{u as mt}from"./useQuery-d54d310a.js";import{S as Me,B as xe,r as ht,w as gt,T as de,A as Be,b as re,Q as Ae,R as Ue}from"./antd-f9eae174.js";import{d as ft}from"./downloadFileFromUrl-79614833.js";import{L as ke}from"./react-router-dom-2a8f5f6d.js";import"./hoist-non-react-statics-23d96a9a.js";import"./react-is-e8e5dbb3.js";import"./@babel-b64fd0f9.js";import"./stylis-79144faa.js";import"./account-86ffff50.js";import"./index-881eef42.js";import"./libphonenumber-js-0d5a9c92.js";import"./react-infinite-scroll-component-e33646cb.js";import"./classnames-4ba1ba1a.js";import"./redux-10bbab4c.js";import"./react-dom-40621ea0.js";import"./scheduler-765c72db.js";import"./@redux-saga-8bafe09b.js";import"./redux-logger-e1c9ca90.js";import"./dompurify-8e338605.js";import"./query-string-f5cca1e7.js";import"./decode-uri-component-4138e85d.js";import"./split-on-first-4f1167c8.js";import"./filter-obj-2ed190f4.js";import"./oidc-client-7da0eaf7.js";import"./firebase-878887a2.js";import"./history-a1882333.js";import"./resolve-pathname-e210f2ac.js";import"./tiny-invariant-dd7d57d2.js";import"./rc-pagination-c1e6a0ac.js";import"./rc-picker-2e3d5fe5.js";import"./rc-util-0bc219f3.js";import"./rc-trigger-570b13ec.js";import"./rc-motion-ae889c42.js";import"./rc-align-e5d7b12e.js";import"./dom-align-ecb06dd6.js";import"./resize-observer-polyfill-0f9f8adb.js";import"./rc-resize-observer-b9ad4e29.js";import"./@ant-design-cba9d434.js";import"./@ctrl-fb5a5473.js";import"./rc-tabs-dfd19a56.js";import"./rc-dropdown-5378dd0a.js";import"./rc-menu-b15ebfe9.js";import"./rc-overflow-6be96612.js";import"./rc-select-564caf01.js";import"./rc-virtual-list-8a7b82a6.js";import"./rc-collapse-11b7d3c4.js";import"./shallowequal-4542d6f7.js";import"./rc-drawer-317f0b4d.js";import"./@rc-component-5a112e55.js";import"./rc-field-form-ef5549aa.js";import"./async-validator-dee29e8b.js";import"./scroll-into-view-if-needed-6b992d05.js";import"./compute-scroll-into-view-183f845a.js";import"./rc-image-e0357917.js";import"./rc-dialog-b1d1f07b.js";import"./rc-input-number-8bc068f7.js";import"./rc-rate-c64cf0d5.js";import"./rc-steps-2d1924c7.js";import"./rc-switch-b4e96de7.js";import"./rc-table-191ecc42.js";import"./rc-checkbox-018e8052.js";import"./rc-tree-67773537.js";import"./rc-tree-select-cb7eccc3.js";import"./copy-to-clipboard-64585c8c.js";import"./toggle-selection-93f4ad84.js";import"./rc-textarea-d01adcbb.js";import"./rc-input-02c2c2ba.js";import"./rc-upload-3ab0f08a.js";import"./rc-notification-d13dc43b.js";import"./rc-progress-4f1a7096.js";import"./rc-tooltip-08fa4217.js";import"./use-sync-external-store-5d1b6592.js";import"./idb-cdd1a92f.js";import"./path-to-regexp-ef8d5544.js";import"./department-807891d3.js";import"./staff-2880022d.js";const K=f.createContext({idBuilding:0,taskPermissionWrite:!1,taskPermissionExport:!1,getListRequestStatus:{isFetching:!1},setGetListRequestStatus:()=>{},activeTab:ge,setActiveTab:()=>{},filter:{...te},setFilter:()=>{},formFilter:void 0,tableData:{records:[],totalRecord:0},setTableData:()=>{},tablePagination:{current:Y,limit:L},setTablePagination:()=>{},modalAddRequest:void 0,showModalAddRequest:()=>{},hideModalAddRequest:()=>{},modalUpdateRequest:void 0,showModalUpdateRequest:()=>{},hideModalUpdateRequest:()=>{},modalDuplicateRequest:void 0,showModalDuplicateRequest:()=>{},hideModalDuplicateRequest:()=>{},departmentData:{isFetching:!1,records:[]},setDepartmentData:()=>{},apartmentData:{isFetching:!1,records:[]},setApartmentData:()=>{},helpDeskPermissionRead:!1}),Pe=({children:t})=>{const{idBuilding:a}=dt(),{getPermissionByModuleCode:n}=Ne(),[d,l]=f.useState({isFetching:!1}),[u,e]=f.useState($),[v,h]=f.useState({...te}),[y,p]=f.useState({records:[],totalRecord:0}),[m,g]=f.useState({current:Y,limit:L}),[D,R]=f.useState({isFetching:!1,records:[]}),[x,C]=f.useState({isFetching:!1,records:[]}),[P]=G.useForm(),[q,r,S]=he(),[F,U,N]=he(),[k,X,J]=he(),M=n(Oe),H=(M==null?void 0:M[Qe])??!1,B=n($e),W=(B==null?void 0:B[Ge])??!1,ae=(B==null?void 0:B[Ke])??!1,z={idBuilding:a,taskPermissionWrite:W,taskPermissionExport:ae,getListRequestStatus:d,setGetListRequestStatus:l,activeTab:u,setActiveTab:e,filter:v,setFilter:h,formFilter:P,tableData:y,setTableData:p,tablePagination:m,setTablePagination:g,modalAddRequest:q,showModalAddRequest:r,hideModalAddRequest:S,modalUpdateRequest:F,showModalUpdateRequest:U,hideModalUpdateRequest:N,modalDuplicateRequest:k,showModalDuplicateRequest:X,hideModalDuplicateRequest:J,departmentData:D,setDepartmentData:R,apartmentData:x,setApartmentData:C,helpDeskPermissionRead:H};return i(K.Provider,{value:z,children:t})};Pe.propTypes={children:se.node};Pe.defaultProps={children:i("div",{})};const vt=Pe,Dt=t=>({id:t.id,name:t.fullName}),yt=t=>{var a;return{id:t.id,name:t.name,residents:((a=t==null?void 0:t.residents)==null?void 0:a.map(n=>Dt(n)))??[]}},ie=async({idBuilding:t,filter:a,page:n,limit:d})=>{try{const l=await He({filter:a,idBuilding:t,limit:d,page:n});return{code:l.code,codeLanguage:l.codeLanguage,data:l.data.map(u=>yt(u))}}catch(l){return{code:l.code,codeLanguage:l.codeLanguage,data:[]}}},St=async({idBuilding:t,filter:a,page:n,limit:d})=>{const{content:l,requestBy:u,apartment:e,department:v,requestDate:h,status:y}=a;try{const p=(h==null?void 0:h[0])??void 0,m=(h==null?void 0:h[1])??void 0,g=await We({filter:{departmentId:v||void 0,keyword:l||void 0,requestFrom:u||void 0,unitId:e||void 0,from:p?w(p).format("DD-MM-YYYY"):void 0,to:m?w(m).format("DD-MM-YYYY"):void 0,status:y||void 0},idBuilding:t,limit:d,page:n});return{code:g.code,codeLanguage:g.codeLanguage,data:g.data.map(D=>ut(D)),totalRecord:g.totalRecord}}catch(p){return{code:p.code,codeLanguage:p.codeLanguage,data:[],totalRecord:0}}},ne=()=>{const{idBuilding:t,setTableData:a,setGetListRequestStatus:n,setDepartmentData:d,setApartmentData:l,apartmentData:u}=f.useContext(K);return{changeDataTable:async({filter:y,limit:p,page:m})=>{n({isFetching:!0});const g=await St({filter:{...y},idBuilding:t,limit:p,page:m});a({records:g.data,totalRecord:g.totalRecord}),n({isFetching:!1})},changeDataDepartment:async()=>{d({isFetching:!0,records:[]});const y=await me(t);d({isFetching:!1,records:y.data})},changeDataUnit:async(y,p=null)=>{var g;if(p&&(((g=u==null?void 0:u.records)==null?void 0:g.find(R=>R.id===p&&R.name===y))??null))return;l({...u,isFetching:!0});const m=await ie({idBuilding:t,page:Y,limit:L,filter:{name:y}});l({isFetching:!1,records:m.data})}}},oe=()=>{const{getAllQuery:t,setQuery:a}=mt(),{setTablePagination:n,setActiveTab:d,setFilter:l,formFilter:u,apartmentData:e}=f.useContext(K);return{getQueryParamsTask:()=>{const{limit:y,page:p,status:m,content:g,requestBy:D,unitId:R,unitName:x,departmentId:C,requestDateFrom:P,requestDateTo:q}=t(),r={pagination:{limit:y&&+y||L,page:p&&+p||Y},status:m||$,filter:{content:g||"",requestBy:D||"",apartment:R&&+R||"",department:C&&+C||"",requestDate:P&&q&&w(P,"DD/MM/YYYY",!0).isValid()&&w(q,"DD/MM/YYYY",!0).isValid()?[w(P,"DD/MM/YYYY",!0),w(q,"DD/MM/YYYY",!0)]:[]},extraData:{unitName:x}};n({limit:r.pagination.limit,current:r.pagination.page}),d(r.status),l({...r.filter}),u.setFieldsValue({...r.filter});const S={limit:r.pagination.limit,page:r.pagination.page,status:m,content:g,requestBy:D,unitId:r.filter.apartment,unitName:r.extraData.unitName,departmentId:r.filter.department,requestDateFrom:"",requestDateTo:""};return r.filter.requestDate&&Array.isArray(r.filter.requestDate)&&r.filter.requestDate.length&&(S.requestDateFrom=w(r.filter.requestDate[0]).format("DD/MM/YYYY"),S.requestDateTo=w(r.filter.requestDate[1]).format("DD/MM/YYYY")),a(S),r},setQueryParamsTask:({limit:y=L,page:p=Y,status:m=$,filter:g=te})=>{var S;const{content:D="",requestBy:R="",apartment:x="",department:C=null,requestDate:P=[]}=g,q=(S=e.records)==null?void 0:S.find(({id:F})=>F===x),r={limit:y,page:p,status:m,content:D,requestBy:R,unitId:q?x:"",unitName:q?q==null?void 0:q.name:"",departmentId:C,requestDateFrom:"",requestDateTo:""};P&&Array.isArray(P)&&P.length&&(r.requestDateFrom=w(P[0]).format("DD/MM/YYYY"),r.requestDateTo=w(P[1]).format("DD/MM/YYYY")),a(r)}}},wt=()=>{const{activeTab:t,formFilter:a,apartmentData:n,departmentData:d,filter:l,tablePagination:u}=f.useContext(K),{setQueryParamsTask:e}=oe(),{changeDataUnit:v}=ne(),{changeDataTable:h}=ne(),y=async m=>{const g=Se(m,l);g&&await h({filter:{...m,status:t},limit:u.limit,page:u.current}),g||e({limit:L,page:Y,filter:{...m},status:t})},p=ve(async m=>{await v(m)});return[y,p,a,d,n]},Ft=()=>{const[t,a,n,d,l]=wt(),u=f.useMemo(()=>[{label:s.content,key:"content",component:i(Le,{placeholder:s.content,fluid:"true"}),visible:!0},{label:s.creator,key:"requestBy",component:A(Q,{placeholder:s.creator,fluid:"true",getPopupContainer:e=>e.parentNode,children:[i(Q.Option,{value:"",children:s.all_type},"request_0"),it.map(e=>i(Q.Option,{value:e.value,children:e.label},e.value))]}),visible:!0},{label:s.unit,key:"apartment",component:A(Q,{fluid:"true",showSearch:!0,placeholder:s.select_apartment,filterOption:!1,loading:l.isFetching,onSearch:a,getPopupContainer:e=>e.parentNode,dropdownRender:e=>l.isFetching?i("div",{style:{display:"flex",flexDirection:"row",justifyContent:"center",alignItems:"center"},children:i(Me,{})}):e,children:[i(Q.Option,{value:"",children:s.all_apartment},"apartment_0"),l.records.map(({id:e,name:v})=>i(Q.Option,{value:e,children:v},e))]}),visible:!0},{label:s.department,key:"department",component:A(Q,{loading:d.isFetching,placeholder:s.department,fluid:"true",getPopupContainer:e=>e.parentNode,children:[i(Q.Option,{value:"",children:s.all_department},"department_0"),d.records.map(({id:e,name:v})=>i(Q.Option,{value:e,children:v},e))]}),visible:!0},{label:s.created_at,key:"requestDate",component:i(Ee.RangePicker,{placeholder:[ce,ce],format:[ce,ce],fluid:"true",getPopupContainer:e=>e.parentNode}),visible:!0}],[d,l]);return i(ee.FilterBox,{defaultFilter:te,filters:u,formData:n,onSearch:t})},Pt=async(t,a)=>{const{content:n,requestBy:d,apartment:l,department:u,requestDate:e,status:v}=a;try{const h=(e==null?void 0:e[0])??void 0,y=(e==null?void 0:e[1])??void 0,p=await ze(t,{departmentId:u||void 0,keyword:n||void 0,requestFrom:d||void 0,unitId:l||void 0,from:h?w(h).format("DD-MM-YYYY"):void 0,to:y?w(y).format("DD-MM-YYYY"):void 0,status:v||void 0});return{code:p.code,codeLanguage:p.codeLanguage,data:p.data}}catch(h){return{code:h.code,codeLanguage:h.codeLanguage,data:void 0}}},Rt=()=>{const{taskPermissionWrite:t,taskPermissionExport:a,tableData:n,idBuilding:d,filter:l,activeTab:u,showModalAddRequest:e}=f.useContext(K),[v,h]=f.useState({isFetching:!1,code:void 0,codeLanguage:void 0});pe(v.code,v.codeLanguage,{message:s.success,description:s.export_data_success});const y=async()=>{h({isFetching:!0,code:void 0,codeLanguage:void 0});const D=await Pt(d,{...l,status:u});D.data&&ft(D.data,document,"thong-tin-yeu-cau.xlsx"),h({isFetching:!1,code:D.code,codeLanguage:D.codeLanguage})},p=()=>{e()},m=v.isFetching,{totalRecord:g}=n;return[a,t,m,g,y,p]};function Tt(){const[t,a,n,d,l,u]=Rt(),e=be(),v=[t?i(xe,{css:h=>({marginRight:h.margin.xs}),type:"primary",ghost:!0,icon:i(le,{name:"icon-download-outlined"}),loading:n,onClick:()=>{e({action:Xe,label:ue}),l()},children:s.export},"export"):null,a?i(xe,{type:"primary",icon:i(le,{name:"icon-plus-circle-outlined"}),onClick:()=>{e({action:Je,label:ue}),u()},children:s.add},"add"):null].filter(Boolean);return i(ee.ActionBox,{actions:v,total:i("span",{children:d})})}const _t=()=>{const{activeTab:t,filter:a}=f.useContext(K),{badges:n}=Ze(),{setQueryParamsTask:d}=oe(),l=async e=>{d({limit:L,page:Y,filter:{...a},status:e})},u=nt.map(e=>e.value===$?{...e,label:i("span",{children:i(ht,{count:n.TASK,offset:[25,8],children:e.label})})}:e);return[t,l,u]},Ct=()=>{const[t,a,n]=_t();return i(ee.Tabs,{activeKey:t,onTabChange:a,tabs:n})},qt=()=>{const{layoutScrollRef:t}=f.useContext(Ye),{idBuilding:a,taskPermissionWrite:n,activeTab:d,tableData:l,getListRequestStatus:u,tablePagination:e,filter:v,showModalUpdateRequest:h,showModalDuplicateRequest:y,helpDeskPermissionRead:p}=f.useContext(K),{setQueryParamsTask:m}=oe(),g=fe(),D=async(M,H)=>{let{current:B,limit:W}=e;B!==M&&(B=M),W!==H&&(W=H,B=Y),m({limit:W,page:B,filter:{...v},status:d})},R=d===$,x=d===_e,C=d===$,P=d===Ce,q=d===Ce,r=d===_e,S=u.isFetching,F=l.records,U={current:e.current,pageSize:e.limit,total:l.totalRecord,showQuickJumper:!0,showSizeChanger:!0,onChange:D},N={scrollToFirstRowOnChange:!0},k={offsetScroll:g.offsetScrollX,getContainer:()=>t.current};return[a,n&&d===$,n,S,F,U,N,k,M=>{h({...M})},M=>{y({...M})},R,x,C,P,r,q,p]};function xt(){const[t,a,n,d,l,u,e,v,h,y,p,m,g,D,R,x,C]=qt(),P=be(),q=[{title:s.code,key:"code",dataIndex:"code",width:170,fixed:"left",render:(r,S)=>A("div",{children:[i(ke,{to:`/buildings/${t}/task/${S.id}`,children:r}),i("div",{css:F=>({marginTop:F.margin.xss}),children:[ot,ge,rt].includes(S.status)&&S.expiryDate&&w(S.expiryDate).isBefore(w(),"minutes")?i(gt,{color:"error",children:s.expired}):null})]})},{title:s.unit,key:"apartmentName",dataIndex:"apartmentName",width:120,align:"left"},g?{title:s.expiry_date,key:"expiryDate",dataIndex:"expiryDate",width:150,align:"left",render:r=>r?w(r).format("DD/MM/YYYY HH:mm"):""}:null,{title:s.content,key:"content",dataIndex:"content",width:300,ellipsis:{showTitle:!1},render:(r,S)=>{const F=r;return(F==null?void 0:F.length)>30?A(de,{title:F,placement:"topLeft",children:[" ",i("div",{style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:F})," "]}):i("div",{style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:F})}},{title:s.created_at,key:"requestDate",dataIndex:"requestDate",width:100,align:"center",render:r=>r?w(r).format("DD/MM/YYYY"):""},C?{title:s.help_desk_code,key:"helpDeskCode",dataIndex:"helpDeskCode",width:150,align:"center",render:(r,S)=>S!=null&&S.helpDeskId?i(ke,{to:`/buildings/${t}/help-desk?helpDeskId=${S==null?void 0:S.helpDeskId}`,target:"_blank",children:S==null?void 0:S.helpDeskCode}):null}:null,D?{title:s.complete_date,key:"completeDate",dataIndex:"completeDate",width:150,render:r=>r?w(r).format("DD/MM/YYYY"):""}:null,R?{title:s.cancel_date,key:"cancelDate",dataIndex:"cancelDate",width:100,render:r=>r?w(r).format("DD/MM/YYYY"):""}:null,x?{title:s.results_of_the_request,key:"result",dataIndex:"result",width:150,render:r=>i(de,{placement:"topLeft",title:r,children:r})}:null,m?{title:s.reason,key:"reason",dataIndex:"reason",width:150,ellipsis:{showTitle:!1},render:r=>i(de,{placement:"topLeft",title:r,children:r})}:null,{title:s.department,key:"departmentName",dataIndex:"departmentName",width:150,align:"center"},p?{title:s.status1,key:"status",dataIndex:"status",align:"center",width:100,render:(r,S)=>{var F;return A(de,{title:`${s.completed} / ${s.canceled} / ${s.total}`,children:[i("span",{children:((F=ct[r])==null?void 0:F.label)??""}),i("br",{}),r===ge?i("span",{css:U=>({color:U.color.primary,marginRight:U.margin.xss,fontSize:"20px"}),children:"•"}):null,A("span",{children:[S.statistics.completed," / ",S.statistics.cancelled," / ",S.statistics.total]})]})}}:null,[a,n].includes(!0)?{title:s.actions,key:"action",fixed:"right",align:"center",width:100,render:(r,S)=>A(Ve,{children:[a?i(le,{css:F=>({fontSize:F.iconSize}),onClick:()=>{P({action:je,label:ue}),h(S)},name:"icon-edit-outlined",title:s.update}):null,n?i(le,{css:F=>({fontSize:F.iconSize,marginLeft:a?F.margin.xs:0}),onClick:()=>{P({action:et,label:ue}),y(S)},name:"icon-copy-outlined",title:s.duplicate_request}):null]})}:null].filter(Boolean);return i(ee.Table,{columns:q,dataSource:l,loading:d,pagination:u,scroll:{...e,x:q.reduce((r,S)=>r+S.width,0)},sticky:v})}const At=async(t,a)=>{const{expiryDate:n,department:d,receiver:l,content:u,apartment:e,resident:v,requestByResident:h,attachments:y}=a,p={description:u,departmentId:d,receiverId:l,dueDate:w(n).toDate(),attachments:y.filter(Boolean)};h&&(p.unitId=e,p.residentId=v);try{const m=await tt(t,p);return{code:m.code,codeLanguage:m.codeLanguage}}catch(m){return{code:m.code,codeLanguage:m.codeLanguage}}},kt=()=>{var ae,z;const{idBuilding:t,modalAddRequest:a,hideModalAddRequest:n,activeTab:d,tablePagination:l,filter:u}=f.useContext(K),{changeDataTable:e}=ne(),{setQueryParamsTask:v}=oe(),[h,y]=f.useState({isFetching:!1,records:[]}),[p,m]=f.useState({isFetching:!1,records:[]}),[g,D]=f.useState({isFetching:!1,records:[]}),[R,x]=f.useState({isFetching:!1,code:void 0,codeLanguage:void 0}),[C]=G.useForm(),[P,q]=f.useState(((z=(ae=a==null?void 0:a.data)==null?void 0:ae.attachments)==null?void 0:z.map((T,c)=>({uid:c,name:T,status:"done",url:T})))??[]),[r,S]=f.useState({isPreview:!1,photoPreview:""}),F=T=>{var c,o;S({isPreview:!0,photoPreview:((o=(c=T==null?void 0:T.response)==null?void 0:c.data)==null?void 0:o.url)??T.url})},U=({fileList:T})=>{let c=T;c.length>10&&(c=c.splice(1,10)),c=c.filter(o=>o.status),q(c)},N=()=>{S({isPreview:!1,photoPreview:""})};pe(R.code,R.codeLanguage,{message:s.success,description:s.add_data_success},()=>{n()}),f.useEffect(()=>{(async()=>{y({isFetching:!0,records:[]});const T=await me(t);y({isFetching:!1,records:Array.isArray(T==null?void 0:T.data)?T==null?void 0:T.data:[]}),m({isFetching:!0,records:[]});const c=await we(t);m({isFetching:!1,records:Array.isArray(c==null?void 0:c.data)?c==null?void 0:c.data:[]})})()},[]);const k=async T=>{if(T.requestByResident){D({isFetching:!0,records:[]});const c=await ie({idBuilding:t,limit:L,page:Y});D({isFetching:!1,records:c.data}),C.setFieldsValue({apartment:void 0,resident:void 0})}else T.department?C.setFieldsValue({receiver:void 0}):T.apartment&&C.setFieldsValue({resident:void 0})},X=async()=>{var c;if(await C.validateFields()){const o=C.getFieldsValue(),V=(((c=C.getFieldValue("photos"))==null?void 0:c.fileList)??[]).map(I=>{var E,b;return((b=(E=I==null?void 0:I.response)==null?void 0:E.data)==null?void 0:b.url)??void 0}),Z={...o,attachments:V};x({isFetching:!0,code:void 0,codeLanguage:void 0});const O=await At(t,Z);if(ye.includes(O.code)){const I={limit:l.limit,page:l.current,filter:{...u},status:d},E={limit:L,page:Y,filter:{...te},status:$},b=Se(E,I);b&&await e({limit:L,page:Y,filter:{...te,status:$}}),b||v({...E})}x({isFetching:!1,code:O.code,codeLanguage:O.codeLanguage})}},J=()=>n(),M=async T=>{D({...g,isFetching:!0});const c=await ie({idBuilding:t,page:Y,limit:L,filter:{name:T}});D({isFetching:!1,records:c.data})},H=ve(async T=>{await M(T)});return[R.isFetching,C,{expiryDate:void 0,department:void 0,receiver:void 0,content:void 0,requestByResident:!1,apartment:void 0,resident:void 0,photos:[]},h,p,g,H,X,J,k,P,U,F,r,N]},Et=()=>{const[t,a,n,d,l,u,e,v,h,y,p,m,g,D,R]=kt();return A(De,{title:s.add_task,open:!0,onOk:v,onCancel:h,confirmLoading:t,okText:s.confirm,cancelText:s.cancel,okBtnProps:{loading:t,disabled:t},width:"50%",children:[i(G,{layout:"vertical",name:"form_add_request",form:a,initialValues:n,onValuesChange:y,children:i(Fe,{isFetching:t,department:d,receiver:l,apartment:u,handleSearchApartment:e,photos:p,onChangePhotos:m,onClickPreviewPhoto:g,previewPhoto:D,onClickBtnCloseModalPreviewPhoto:R})}),i(Be,{message:s.after_create_task_will_show_in_tab_in_progress,type:"info",showIcon:!0})]})},bt={approvalStatus:s.status_approval_request.toLowerCase(),description:s.description.toLowerCase(),dueDate:s.due_date.toLowerCase(),progressStatus:s.status_request.toLowerCase(),receiverId:s.receiver.toLowerCase()},Yt=t=>{let a;switch(t.action){case"create":a=s.activity_action_create;break;case"update":a=s.activity_action_update;break}const n=Object.keys(t.changedData).map(l=>bt[l]),d=t.action==="create"?s.task:Ie(n,", ");return` ${a} ${d}`},Lt=t=>{var a,n;return{id:t.id,createdAt:t.actionDate,actor:((n=(a=t==null?void 0:t.employee)==null?void 0:a[0])==null?void 0:n.fullName)??s.deleted_account,content:Yt(t)}},Mt=async(t,a)=>{try{const n=await at(t,a);return{code:n.code,codeLanguage:n.codeLanguage,data:n.data.map(d=>Lt(d))}}catch(n){return{code:n.code,codeLanguage:n.codeLanguage,data:[]}}},Bt=()=>{var z,T,c;const{idBuilding:t,hideModalUpdateRequest:a,activeTab:n,modalUpdateRequest:d,filter:l,tablePagination:u}=f.useContext(K),{data:e}=d,{changeDataTable:v}=ne(),[h,y]=f.useState({isFetching:!1,records:[]}),[p,m]=f.useState({isFetching:!1,records:[{id:e.department.id,name:e.department.name}]}),[g,D]=f.useState({isFetching:!1,records:[{id:e.receiver.id,name:e.receiver.name,departments:[e.department.id]}]}),[R,x]=f.useState(["content","requestByResident","apartment","resident","department"]),C=f.useMemo(()=>({isFetching:!1,records:[{id:e.apartment.id,name:e.apartment.name,residents:e.apartment.residents}]}),[e]),[P,q]=f.useState({isFetching:!1,code:void 0,codeLanguage:void 0}),[r]=G.useForm(),[S,F]=f.useState(((T=(z=d==null?void 0:d.data)==null?void 0:z.attachments)==null?void 0:T.map((o,_)=>({uid:_,name:o,status:"done",url:o})))??[]),[U,N]=f.useState({isPreview:!1,photoPreview:""}),k=o=>{var _,V;N({isPreview:!0,photoPreview:((V=(_=o==null?void 0:o.response)==null?void 0:_.data)==null?void 0:V.url)??o.url})},X=({fileList:o})=>{let _=o;_.length>10&&(_=_.splice(1,10)),_=_.filter(V=>V.status),F(_)},J=()=>{N({isPreview:!1,photoPreview:""})};pe(P.code,P.codeLanguage,{message:s.success,description:s.update_request_success},()=>{a()}),f.useEffect(()=>{(async()=>{m({...p,isFetching:!0});const o=await me(t);m({isFetching:!1,records:Array.isArray(o==null?void 0:o.data)?o==null?void 0:o.data:[]})})(),(async()=>{D({...g,isFetching:!0});const o=await we(t);D({isFetching:!1,records:Array.isArray(o==null?void 0:o.data)?o==null?void 0:o.data:[]})})(),(async()=>{y({isFetching:!0,records:[]});const o=await Mt(t,e.id);y({isFetching:!1,records:o.data})})()},[]),f.useEffect(()=>{var _,V;let o=!1;e.apartment&&(e.resident?o=!((V=(_=e==null?void 0:e.apartment)==null?void 0:_.residents)==null?void 0:V.find(O=>O.id===e.resident.id)):o=!0),o&&(r.setFieldsValue({resident:void 0}),x(["content","requestByResident","apartment","department"]))},[e]);const M=async(o,_)=>{o.requestByResident?r.setFieldsValue({apartment:void 0,resident:void 0}):o.department?r.setFieldsValue({receiver:void 0}):o.apartment&&r.setFieldsValue({resident:void 0})},H=async()=>{var _;if(await r.validateFields()){const V=r.getFieldsValue(),O=(((_=r.getFieldValue("photos"))==null?void 0:_.fileList)??[]).map(b=>{var j,Te;return((Te=(j=b==null?void 0:b.response)==null?void 0:j.data)==null?void 0:Te.url)??(b==null?void 0:b.url)}),I={...V,attachments:O};q({isFetching:!0,code:void 0,codeLanguage:void 0});const E=await pt(t,e.id,I);ye.includes(E.code)&&await v({filter:{...l,status:n},limit:u.limit,page:u.current}),q({isFetching:!1,code:E.code,codeLanguage:E.codeLanguage})}},B=()=>a(),W=P.isFetching,ae={expiryDate:e.expiryDate?w(e.expiryDate):void 0,department:e.department.id,receiver:e.receiver.id,content:e.content,requestByResident:!!e.apartment.id,apartment:e.apartment.id,resident:(c=e==null?void 0:e.resident)==null?void 0:c.id,photos:{fileList:e==null?void 0:e.attachments.map(o=>({response:{data:{url:o}}}))}};return[W,r,ae,p,g,C,h,R,H,B,M,S,X,k,U,J]},Ut=()=>{const[t,a,n,d,l,u,e,v,h,y,p,m,g,D,R,x]=Bt(),C=fe();return i(De,{title:s.update_task,open:!0,onOk:h,onCancel:y,confirmLoading:t,okText:s.confirm,cancelText:s.cancel,okBtnProps:{loading:t,disabled:t},width:"90%",children:A(Ue,{gutter:[C.margin.md],children:[A(re,{span:"12",children:[i(G,{layout:"vertical",name:"form_update_request",form:a,initialValues:n,onValuesChange:p,children:i(Fe,{isFetching:t,department:d,receiver:l,apartment:u,disabledItem:v,photos:m,onChangePhotos:g,onClickPreviewPhoto:D,previewPhoto:R,onClickBtnCloseModalPreviewPhoto:x})}),i(Be,{message:s.noted_task_due_date_have_to_lower_or_equal_than_subtask_of_task_due_date,type:"warning",showIcon:!0})]}),i(re,{span:"12",children:e.isFetching?i(Me,{}):i(Ae,{children:e.records.map(P=>A(Ae.Item,{children:[w(P.createdAt).format("DD/MM/YYYY HH:mm:ss"),": ",i("strong",{children:P.actor})," ",P.content]},P.id))})})]})})},Re=({field:t,receiver:a,disabledItem:n})=>{var l;const d=fe();return A(Ue,{gutter:[d.margin.xs,0],children:[i(re,{span:24,children:i(G.Item,{name:t?[t.name,"expiryDate"]:"expiryDate",fieldKey:t?[t.fieldKey,"expiryDate"]:"expiryDate",dependencies:["expiryDate"],rules:[{required:!0},({getFieldValue:u})=>({validator(e,v){if(!v)return Promise.reject(new Error(s.status.data_require));if(v&&w(v).isBefore(w().subtract(1,"day")))return Promise.reject(new Error(`${s.min_due_date}: ${w().format("DD/MM/YYYY")}`));const h=u("expiryDate");return h&&v&&w(v).isAfter(w(h).add(1,"day"))?Promise.reject(new Error(`${s.max_due_date}: ${w().format("DD/MM/YYYY")}`)):Promise.resolve()}})],label:s.expiry_date,children:i(Ee,{disabledDate:u=>w(u).isBefore(w().subtract(1,"day")),format:"DD/MM/YYYY",placeholder:"DD/MM/YYYY",fluid:!0})})}),i(re,{span:24,children:i(G.Item,{name:t?[t.name,"receiver"]:"receiver",fieldKey:t?[t.fieldKey,"receiver"]:"receiver",rules:[{required:!0}],label:s.receiver,children:i(Q,{disabled:n.includes("receiver"),loading:a.isFetching,placeholder:s.receiver,fluid:!0,children:((l=a==null?void 0:a.records)==null?void 0:l.map(({id:u,name:e})=>i(Q.Option,{value:u,children:e},u)))??[]})})}),i(re,{span:24,children:i(G.Item,{name:t?[t.name,"content"]:"content",fieldKey:t?[t.fieldKey,"content"]:"content",rules:[{required:!0}],label:s.content,children:i(Le.TextArea,{disabled:n.includes("content"),rows:"3",placeholder:s.content})})})]},t==null?void 0:t.key)};Re.propTypes={field:se.objectOf(se.any),receiver:se.objectOf(se.any),disabledItem:se.arrayOf(se.any)};Re.defaultProps={field:void 0,receiver:{isFetching:!1,records:[]},disabledItem:[]};const Vt=async(t,a,n)=>{const{expiryDate:d,department:l,receiver:u,content:e,apartment:v,resident:h,requestByResident:y,tasks:p,attachments:m}=n,g={id:a.id,description:e,departmentId:l,receiverId:u,dueDate:w(d).endOf("day").toDate(),tasks:p.map((D,R)=>({id:a.tasks[R].id,description:D.content,dueDate:w(D.expiryDate).endOf("day").toDate(),assignees:[D.receiver]})),attachments:m};y&&(g.unitId=v,g.residentId=h);try{const D=await st(t,g);return{code:D.code,codeLanguage:D.codeLanguage}}catch(D){return{code:D.code,codeLanguage:D.codeLanguage}}},It=()=>{var z,T;const{idBuilding:t,hideModalDuplicateRequest:a,modalDuplicateRequest:n,tablePagination:d,filter:l,activeTab:u}=f.useContext(K),{data:e}=n,{changeDataTable:v}=ne(),{setQueryParamsTask:h}=oe(),[y,p]=f.useState([]),[m,g]=f.useState({isPreview:!1,photoPreview:""}),D=c=>{var o,_;g({isPreview:!0,photoPreview:((_=(o=c==null?void 0:c.response)==null?void 0:o.data)==null?void 0:_.url)??c.url})},R=({fileList:c})=>{let o=c;o.length>10&&(o=o.splice(1,10)),o=o.filter(_=>_.status),p(o)},x=()=>{g({isPreview:!1,photoPreview:""})},[C,P]=f.useState({isFetching:!1,records:[{id:e.department.id,name:e.department.name}]}),[q,r]=f.useState({isFetching:!1,records:[{id:e.receiver.id,name:e.receiver.name,departments:[e.department.id]}]}),[S,F]=f.useState({isFetching:!1,records:[]}),[U,N]=f.useState({isFetching:!1,code:void 0,codeLanguage:void 0}),[k]=G.useForm();pe(U.code,U.codeLanguage,{message:s.success,description:s.duplicate_request_success},()=>{a()}),f.useEffect(()=>{(async()=>{P({...C,isFetching:!0});const c=await me(t);P({isFetching:!1,records:Array.isArray(c==null?void 0:c.data)?c==null?void 0:c.data:[]}),k.setFieldsValue({department:e.department.id})})(),(async()=>{r({...q,isFetching:!0});const c=await we(t);r({isFetching:!1,records:Array.isArray(c==null?void 0:c.data)?c==null?void 0:c.data:[]}),k.setFieldsValue({receiver:e.receiver.id,tasks:e.tasks.filter(o=>o.status!==qe).map(o=>({content:o.content,expiryDate:o.expiryDate?w(o.expiryDate):void 0,receiver:o.receiver.id}))})})(),e.apartment.id&&(async()=>{var Z;F({isFetching:!0,records:[]});const c=await ie({filter:{id:(Z=e==null?void 0:e.apartment)==null?void 0:Z.id},idBuilding:t,paging:Y,limit:L}),_=(await ie({filter:l,idBuilding:t,paging:Y,limit:L})).data.filter(O=>!c.data.some(I=>I.id===O.id)),V=[...c.data,..._];F({isFetching:!1,records:V}),k.setFieldsValue({apartment:e.apartment.id,resident:e.resident.id})})()},[e]);const X=async c=>{if(c.requestByResident){F({isFetching:!0,records:[]});const o=await ie({idBuilding:t,limit:L,page:Y});F({isFetching:!1,records:o.data}),k.setFieldsValue({apartment:void 0,resident:void 0})}else c.department?k.setFieldsValue({receiver:void 0}):c.apartment&&k.setFieldsValue({resident:void 0})},J=async()=>{var o;if(await k.validateFields()){const _=k.getFieldsValue(),Z=(((o=k.getFieldValue("photos"))==null?void 0:o.fileList)??[]).map(E=>{var b,j;return((j=(b=E==null?void 0:E.response)==null?void 0:b.data)==null?void 0:j.url)??(E==null?void 0:E.url)}),O={..._,attachments:Z};N({isFetching:!0,code:void 0,codeLanguage:void 0});const I=await Vt(t,e,O);if(ye.includes(I.code)){const E={limit:d.limit,page:d.current,filter:{...l},status:u},b={limit:L,page:Y,filter:{...te},status:$},j=Se(b,E);j&&await v({limit:L,page:Y,filter:{...te,status:$}}),j||h({...b})}N({isFetching:!1,code:I.code,codeLanguage:I.codeLanguage})}},M=()=>a(),H=ve(async c=>{F({...S,isFetching:!0});const o=await ie({idBuilding:t,page:Y,limit:L,filter:{name:c}});F({isFetching:!1,records:o.data})}),B=U.isFetching,W={expiryDate:e.expiryDate?w(e.expiryDate):void 0,department:(z=e.department)==null?void 0:z.id,receiver:(T=e.receiver)==null?void 0:T.id,content:e.content,requestByResident:!!e.apartment.id,apartment:void 0,resident:void 0,tasks:e.tasks.filter(c=>c.status!==qe).map(c=>({content:c.content,expiryDate:c.expiryDate?w(c.expiryDate):void 0})),photos:{fileList:[]}};return[B,k,W,C,q,S,H,J,M,X,["content"],y,D,R,x,m]},Nt=()=>{const[t,a,n,d,l,u,e,v,h,y,p,m,g,D,R,x]=It();return i(De,{title:s.duplicate_request,open:!0,onOk:v,onCancel:h,confirmLoading:t,okText:s.confirm,cancelText:s.cancel,okBtnProps:{loading:t,disabled:t},children:A(G,{layout:"vertical",name:"form_duplicate_request",form:a,initialValues:n,onValuesChange:y,children:[i(Fe,{department:d,receiver:l,apartment:u,handleSearchApartment:e,photos:m,onChangePhotos:D,onClickPreviewPhoto:g,previewPhoto:x,onClickBtnCloseModalPreviewPhoto:R}),i(G.List,{name:"tasks",children:C=>C.map((P,q)=>A("fieldset",{children:[A("legend",{children:[s.task," ",q+1]}),i(Re,{disabledItem:p,field:P,receiver:l})]},q))})]})})},Ot=()=>{const{search:t}=lt(),{setTitlePage:a,setVisibleFilterBox:n,setVisibleSearchBox:d}=f.useContext(Ye),{idBuilding:l,modalAddRequest:u,modalUpdateRequest:e,modalDuplicateRequest:v}=f.useContext(K),{getQueryParamsTask:h}=oe(),{changeDataTable:y,changeDataDepartment:p,changeDataUnit:m}=ne();return f.useEffect(()=>(a(s.task),d(!0),(async()=>await p())(),()=>{a(""),d(!1),n(!1)}),[]),f.useEffect(()=>{(async()=>{if(l){const{pagination:g,filter:D,status:R,extraData:x}=h();t&&(await m((x==null?void 0:x.unitName)||"",D.apartment||""),await y({filter:{...D,status:R},limit:g.limit,page:g.page}))}})()},[t]),[u,e,v]},Qt=()=>{const[t,a,n]=Ot();return A(ee.Wrapper,{children:[i(Ft,{}),A(ee.Container,{children:[A(ee.Header,{children:[i(Tt,{}),i(Ct,{})]}),i(ee.Content,{children:i(xt,{})})]}),t.isShow?i(Et,{}):null,a.isShow?i(Ut,{}):null,n.isShow?i(Nt,{}):null]})},qs=()=>i(vt,{children:i(Qt,{})});export{qs as default};
