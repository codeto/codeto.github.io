import{j as a,a as _,F as v,c as I}from"./@emotion-63839449.js";import{P as n}from"./prop-types-1172f4d5.js";import{r as p}from"./react-4fd50329.js";import{a as X,m as G,f as H,b as O,u as V,e as z,o as K}from"./lodash-88fe09e6.js";import"./moment-a468e1f9.js";import{l as o,b5 as P,S as J}from"./index-c2ded735.js";import"./file-saver-40cf32a9.js";import{d as $}from"./downloadFileFromUrl-79614833.js";import{T as M,a as Q}from"./index-b17d22e5.js";import{r as W,R as Z,a as ee,b as re}from"./regex-deefadac.js";import{S as te}from"./async-validator-dee29e8b.js";import{v as U}from"./index-687ba9e6.js";import{v as N}from"./uuid-4a60fe23.js";import{a as w,j as R,A as C,B as x,U as le}from"./antd-f9eae174.js";const D=p.createContext(null),L=e=>{const{visible:t,children:i,headers:r,code:s,codeLanguage:l,loading:c,numberSuccess:m,numberFail:g,onClose:b,onOk:f,problemResponseServerDataSource:d,fileNameTemplate:h,templateUrl:u,errorFile:y,onDownloadTemplateFile:F}=e,[S,B]=p.useState([]),[T,j]=p.useState([]),[q,Y]=p.useState(!1),A={visible:t,headers:r,problemClientDataSource:S,problemResponseServerDataSource:d,changeProblemClientDataSource:k=>B(k),code:s,codeLanguage:l,loading:c,numberSuccess:m,numberFail:g,fileList:T,changeFileList:k=>j(k),onClose:b,onUpload:()=>{T.length>0&&(f(T[0]),Y(!0))},onDownloadTemplateFile:()=>{u?$(u,document,h||u):F()},errorFile:y,isUploaded:q};return a(D.Provider,{value:A,children:i})};L.propTypes={visible:n.bool.isRequired,onClose:n.func.isRequired,onOk:n.func.isRequired,children:n.node,headers:n.arrayOf(n.any).isRequired,code:n.number,codeLanguage:n.string,loading:n.bool,numberSuccess:n.number,numberFail:n.number,problemResponseServerDataSource:n.arrayOf(n.any),fileNameTemplate:n.string,templateUrl:n.string,errorFile:n.string,onDownloadTemplateFile:n.func};L.defaultProps={children:null,loading:!1,code:null,codeLanguage:null,numberSuccess:0,numberFail:0,problemResponseServerDataSource:[],fileNameTemplate:"",templateUrl:"",errorFile:null,onDownloadTemplateFile:()=>{}};const oe={...U,enum:o.validate.enum_file,types:{...U.types,email:o.validate.email_file}},ne=(e,t,i,r)=>{const s=Object.keys(t).map(l=>({name:l,errors:t[l].map(c=>{let{message:m}=c;if(m=m.replace(c.field,"").trim(),r[l].type==="enum"){const g=r[l].enum.reduce((b,f,d)=>d===0?`${b}${f}`:`${b}, ${f}`,"");m=m.replace(/{enum}/,g)}return["number","string"].includes(r[l].type)&&(m=m.replace("${min}",r[l].min).replace("${max}",r[l].max)),m})}));return{row:i["#"],columns:s}},ae=async(e,t)=>{const i=new te(t);return i.messages(oe),(await Promise.all(e.map(async s=>{try{return await i.validate(s),null}catch({errors:l,fields:c}){return ne(l,c,s,t)}}))).filter(Boolean)},se=()=>{const{problemClientDataSource:e}=p.useContext(D),t=[{title:o.label.row,dataIndex:"row",key:"row",width:150},{title:o.label.column,dataIndex:"column",key:"column",width:"30%"},{title:o.label.problem,dataIndex:"problem",key:"problem"}],i=p.useMemo(()=>e.map(r=>{const s=r.row||N();return{...r,key:s,columns:r.columns.map(l=>({key:`${s}-${l.name}`,column:l.name,problem:l.errors.map((c,m)=>_("div",{children:[_(w.Text,{children:[m+1,". ",c]}),a("br",{})]},N()))}))}}),[e]);return a(v,{children:e.length>0&&a(M,{bordered:!0,columns:t,dataSource:i,expandable:{childrenColumnName:["columns"]}})})},ie=I(x,{target:"em3f5660"})({name:"plcayk",styles:"padding-left:3px;padding-right:3px"}),ce=[{title:o.label.row,width:150,dataIndex:"row",key:"row"},{title:o.label.problem,dataIndex:"problem",key:"problem"}],me=()=>{const{problemResponseServerDataSource:e,code:t,codeLanguage:i,numberSuccess:r,numberFail:s,errorFile:l}=p.useContext(D),[c,m]=p.useState(""),[g,b]=p.useState(!1),f=p.useMemo(()=>e.map(u=>({key:u.index,row:u.index,problem:P[u.code]||u.message||o.error.data_invalid})),[e]);p.useEffect(()=>{t?(b(!0),J.includes(t)?m(""):m(P[i||"FAIL"])):b(!1)},[t]);function d(u){const y=new ArrayBuffer(u.length),F=new Uint8Array(y);for(let S=0;S!==u.length;S+=1)F[S]=u.charCodeAt(S)&255;return y}const h=()=>{if(l){const u=URL.createObjectURL(new Blob([d(atob(l))]));$(u,document,"file-error.xlsx")}};return a(v,{children:g&&a(v,{children:c?_(v,{children:[a(R,{orientation:"left",children:a(w.Title,{level:4,children:o.label.server_response})}),a(C,{type:"error",message:c})]}):_(v,{children:[a(R,{orientation:"left",children:a(w.Title,{level:4,children:o.label.server_response})}),s===0?a(C,{type:"success",message:o.alert_response_server_import_file1.replace("{numberSuccess}",r)}):_(v,{children:[a(C,{type:"warning",message:o.alert_response_server_import_file.replace("{numberSuccess}",r).replace("{numberFail}",s)}),a(R,{orientation:"left",children:a(w.Title,{level:4,children:o.label.solution})}),_(w.Paragraph,{children:["1.",a(ie,{type:"link",onClick:h,children:o.label.click_here}),o.label.to_download_a_list_not_imported.toLowerCase()]}),_(w.Paragraph,{children:["2. ",o.label.solve_the_problem_table_below_based_on_the_downloaded_file]}),a(M,{columns:ce,dataSource:f,bordered:!0})]})]})})})},{Dragger:ue}=le,pe=I(ue,{target:"ezzr2d0"})({name:"prl6hc",styles:"height:15vh!important"}),de=e=>{const t=e.type==="application/vnd.ms-excel"||e.type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";if(!t)throw"You can only upload XLS/XLSX file!";return t},be=(e,t)=>{const i=X.difference(G(e,r=>r.name),t);if(i.length>0)throw`${o.status.file_missing_or_wrong_column} <strong>${i.join(", ")}</strong>`},ge=(e,t)=>{const i=H(e,r=>{var s;return(s=r==null?void 0:r.rules)==null?void 0:s.unique}).map(r=>r.name);O(i,r=>{if(V(t,r).length!==t.length){let s=z.groupBy(t,r);s=K.pickBy(s,(c,m)=>c.length>1&&m!=="undefined");const l=Object.keys(s);if(l.length)throw`${o.label.column} <strong>${r}</strong>: ${o.status.data_duplicate} 
            <strong>${l.join(", ")}</strong>`}})},fe=e=>{if((e==null?void 0:e.length)>5e3)throw`<b>${o.status.the_file_is_limited_to_a_maximum_of_5000_rows}</b>`},he=(e,t)=>{if(e!=null)switch(t){case"number":return Number(e);case"string":return String(e).trim();case"date":return String(e);default:return Number.isNaN(e)&&typeof e=="string"?String(e).trim():!Number.isNaN(e)&&typeof e=="number"?Number(e):e}},ye=(e,t)=>{let i=[];return i=t.map(r=>{const s={...r};return O(e,l=>{var c;s[l.name]=he(r[l.name],(c=l==null?void 0:l.rules)==null?void 0:c.type)}),s}),i},_e=()=>{const{headers:e,changeProblemClientDataSource:t,fileList:i,changeFileList:r,onDownloadTemplateFile:s,isUploaded:l}=p.useContext(D),[c,m]=p.useState(""),g=p.useMemo(()=>e.reduce((d,h)=>({...d,[h.name]:h.rules}),{}),[e]),b=async d=>{try{if(d.file&&d.file.status!=="removed"){if(de(d.file))if(d.fileList.length>0){const{headers:u,data:y}=await W(d.file);fe(y),be(e,u),ge(e,y);const F=ye(e,y),S=await ae(F,g);t(S),r([d.file])}else t([]),r([]);m("")}else t([]),r([])}catch(h){m(h)}},f=()=>!1;return _(v,{children:[a(x,{type:"link",onClick:s,children:o.label.download_template_file}),_(pe,{accept:".xlsx,.xls",name:"file",onChange:b,beforeUpload:f,fileList:i,disabled:l,children:[a("p",{className:"ant-upload-text",children:o.label.click_or_drag_file_to_this_area_to_upload}),a("p",{className:"ant-upload-hint",children:o.support_file_import_data})]}),c&&a(C,{type:"error",message:a("div",{dangerouslySetInnerHTML:{__html:c}}),style:{marginTop:"12px"}}),a(se,{}),a(me,{})]})},Se=()=>{const{onClose:e,onUpload:t,fileList:i,loading:r,code:s,numberFail:l,problemClientDataSource:c,problemResponseServerDataSource:m,isUploaded:g}=p.useContext(D),b=p.useMemo(()=>i.length===0||c.length||m.length?!0:s&&l===0,[i,s,l,c,m]),f=p.useMemo(()=>g?[a(x,{onClick:e,type:"primary",loading:r,disabled:r,children:o.complete},"complete")]:[a(x,{onClick:e,children:o.cancel},"cancel"),a(x,{type:"primary",loading:r,onClick:t,disabled:b,children:o.import},"submit")],[g,b,r]);return a(Q,{title:o.label.import_data,open:!0,onOk:t,onCancel:!r&&e,okText:o.import,cancelText:o.cancel,okButtonProps:{disabled:b},width:"60%",maskClosable:!1,bodyStyle:{paddingTop:0},confirmLoading:r,footer:f,children:a(_e,{})})},ve={type:"string",pattern:Z,message:`${o.status.date_invalid} (${o.label.valid}: DD/MM/YYYY)`},we={type:"string",pattern:ee,message:`${o.status.date_invalid} (${o.label.valid}: MM/YYYY)`},Fe={type:"string",pattern:re,message:o.label.invalid,max:15},xe={type:"string",max:255},De={dateImportRule:ve,stringImportRule:xe,phoneImportRule:Fe,monthImportRule:we},E=e=>{const{visible:t,onClose:i,onOk:r,headers:s,code:l,codeLanguage:c,loading:m,numberSuccess:g,numberFail:b,problemResponseServerDataSource:f,fileNameTemplate:d,templateUrl:h,errorFile:u,onDownloadTemplateFile:y}=e;return a(L,{visible:t,onClose:i,onOk:r,headers:s,code:l,codeLanguage:c,loading:m,numberSuccess:g,numberFail:b,problemResponseServerDataSource:f,fileNameTemplate:d,templateUrl:h,errorFile:u,onDownloadTemplateFile:y,children:a(Se,{})})};E.propTypes={visible:n.bool.isRequired,onClose:n.func.isRequired,onOk:n.func.isRequired,headers:n.arrayOf(n.any).isRequired,code:n.number,codeLanguage:n.string,loading:n.bool,numberSuccess:n.number,numberFail:n.number,problemResponseServerDataSource:n.arrayOf(n.any),fileNameTemplate:n.string,templateUrl:n.string,errorFile:n.string,onDownloadTemplateFile:n.func};E.defaultProps={loading:!1,code:null,codeLanguage:null,numberSuccess:0,numberFail:0,problemResponseServerDataSource:[],fileNameTemplate:"",templateUrl:"",errorFile:"",onDownloadTemplateFile:()=>{}};E.rules=De;export{E as I};
