import{j as t,u as lt,a as R,F as Ee}from"./@emotion-63839449.js";import{r as O}from"./react-4fd50329.js";import{B as Re}from"./index-881eef42.js";import{a3 as Ke,dq as ct,a5 as Be,I as ce,l as o,dP as dt,Y as ut,a as Qe,c6 as G,bH as mt,E as pt,S as ft,e6 as ve,e7 as Je,e8 as Ae,ch as ht,ci as gt,cj as Tt,ck as yt,cl as _t,s as z,K as we,b0 as xt,av as bt,at as wt,bv as It,e9 as Ct,cd as Xe,a9 as Et,b1 as Pt}from"./index-c2ded735.js";import{l as Ze}from"./lodash-88fe09e6.js";import{h as b}from"./moment-a468e1f9.js";import"./file-saver-40cf32a9.js";import"./react-redux-896b353b.js";import{u as St}from"./useService-37d60dc0.js";import"./@firebase-43527ee1.js";import{a as Ft,i as Nt,d as Ot,g as et,b as kt}from"./contract-2ad66738.js";import{F as Pe,u as tt}from"./index-687ba9e6.js";import{c as nt,E as Dt,L as Mt,S as Rt}from"./exportContract-a49a1d75.js";import{P as e}from"./prop-types-1172f4d5.js";import{P as ot,u as Le,N as it,T as rt,k as Bt,a as Fe,z as Te,D as Ie,l as Ce,p as he,q as ge}from"./index-b17d22e5.js";import{B as Se,T as vt,b as D,R as Ve,n as At,P as Lt,a as q,w as Vt,I as Ut}from"./antd-f9eae174.js";import{S as We,I as jt}from"./index-43183512.js";import{I as Yt}from"./index-0335a746.js";import{d as qt}from"./downloadFileFromUrl-79614833.js";import{e as zt}from"./exportExcel-837be6ed.js";import{u as at}from"./react-router-a4308f7b.js";import"./hoist-non-react-statics-23d96a9a.js";import"./react-is-e8e5dbb3.js";import"./@babel-b64fd0f9.js";import"./stylis-79144faa.js";import"./classnames-4ba1ba1a.js";import"./redux-10bbab4c.js";import"./react-router-dom-2a8f5f6d.js";import"./history-a1882333.js";import"./resolve-pathname-e210f2ac.js";import"./tiny-invariant-dd7d57d2.js";import"./react-dom-40621ea0.js";import"./scheduler-765c72db.js";import"./@redux-saga-8bafe09b.js";import"./redux-logger-e1c9ca90.js";import"./dompurify-8e338605.js";import"./query-string-f5cca1e7.js";import"./decode-uri-component-4138e85d.js";import"./split-on-first-4f1167c8.js";import"./filter-obj-2ed190f4.js";import"./oidc-client-7da0eaf7.js";import"./firebase-878887a2.js";import"./rc-pagination-c1e6a0ac.js";import"./rc-picker-2e3d5fe5.js";import"./rc-util-0bc219f3.js";import"./rc-trigger-570b13ec.js";import"./rc-motion-ae889c42.js";import"./rc-align-e5d7b12e.js";import"./dom-align-ecb06dd6.js";import"./resize-observer-polyfill-0f9f8adb.js";import"./rc-resize-observer-b9ad4e29.js";import"./@ant-design-cba9d434.js";import"./@ctrl-fb5a5473.js";import"./rc-tabs-dfd19a56.js";import"./rc-dropdown-5378dd0a.js";import"./rc-menu-b15ebfe9.js";import"./rc-overflow-6be96612.js";import"./rc-select-564caf01.js";import"./rc-virtual-list-8a7b82a6.js";import"./rc-collapse-11b7d3c4.js";import"./shallowequal-4542d6f7.js";import"./rc-drawer-317f0b4d.js";import"./@rc-component-5a112e55.js";import"./rc-field-form-ef5549aa.js";import"./async-validator-dee29e8b.js";import"./scroll-into-view-if-needed-6b992d05.js";import"./compute-scroll-into-view-183f845a.js";import"./rc-image-e0357917.js";import"./rc-dialog-b1d1f07b.js";import"./rc-input-number-8bc068f7.js";import"./rc-rate-c64cf0d5.js";import"./rc-steps-2d1924c7.js";import"./rc-switch-b4e96de7.js";import"./rc-table-191ecc42.js";import"./rc-checkbox-018e8052.js";import"./rc-tree-67773537.js";import"./rc-tree-select-cb7eccc3.js";import"./copy-to-clipboard-64585c8c.js";import"./toggle-selection-93f4ad84.js";import"./rc-textarea-d01adcbb.js";import"./rc-input-02c2c2ba.js";import"./rc-upload-3ab0f08a.js";import"./rc-notification-d13dc43b.js";import"./rc-progress-4f1a7096.js";import"./rc-tooltip-08fa4217.js";import"./use-sync-external-store-5d1b6592.js";import"./idb-cdd1a92f.js";import"./path-to-regexp-ef8d5544.js";import"./account-86ffff50.js";import"./libphonenumber-js-0d5a9c92.js";import"./react-infinite-scroll-component-e33646cb.js";import"./regex-deefadac.js";import"./xlsx-0fb7ed70.js";import"./uuid-4a60fe23.js";const Ue=({hiddenAction:x,totalItem:f,showFormImportContract:E,showFormExportContract:d,servicePermissionExport:u,servicePermissionWrite:y})=>{const[B]=ut(),k=Ke(),a=()=>{d()},r=()=>{E()},l=[!x.includes("EXPORT")&&u&&t(Se,{style:{marginRight:B.marginSm},type:"primary",ghost:!0,onClick:()=>{k({action:ct,label:Be}),a()},icon:t(ce,{name:"icon-download-outlined"}),children:o.export},"export")||null,!x.includes("IMPORT")&&y&&t(Se,{type:"primary",icon:t(ce,{name:"icon-upload-outlined"}),onClick:()=>{k({action:dt,label:Be}),r()},children:o.import},"import")||null].filter(Boolean);return t(ot.ActionBox,{actions:l,total:f})};Ue.propTypes={hiddenAction:e.arrayOf(e.any),totalItem:e.number,showFormImportContract:e.func,showFormExportContract:e.func,servicePermissionExport:e.bool,servicePermissionWrite:e.bool};Ue.defaultProps={hiddenAction:[],totalItem:0,showFormImportContract:()=>{},showFormExportContract:()=>{},servicePermissionExport:!1,servicePermissionWrite:!1};const je=({editing:x,dataIndex:f,title:E,inputType:d,record:u,index:y,children:B,...k})=>{const a=(u==null?void 0:u.contractTemplates)??[],r=d==="select"?t(We,{size:"small",fluid:"true",children:a.map(h=>t(We.Option,{style:{wordBreak:"break-word"},value:h.id,children:t(vt,{title:h.name,children:t("span",{children:h.name})})},h.id))}):t(Bt,{size:"small",style:{textAlign:"right"},formatter:h=>G(h),min:"0",defaultValue:0}),l=[{required:!0}],p=[];return f==="newIndex"&&(l.push(({getFieldValue:h})=>({validator(v,w){return!w||+h("oldIndex")<=+w?Promise.resolve():Promise.reject(new Error(o.old_index_must_lower_or_equal_than_new_index))}})),p.push("oldIndex")),f==="oldIndex"&&(l.push(({getFieldValue:h})=>({validator(v,w){return!w||+h("newIndex")>=+w?Promise.resolve():Promise.reject(new Error(o.old_index_must_lower_or_equal_than_new_index))}})),p.push("newIndex")),f==="factor"&&(l.splice(0,1),l.push(({getFieldValue:h})=>({validator(v,w){return w==null||w===""?Promise.reject(new Error(o.status.data_require)):+h("factor")<=0?Promise.reject(new Error(o.coefficient_must_be_greater_than_0)):Promise.resolve()}})),p.push("factor")),t("td",{...k,children:x?t(Pe.Item,{name:f,style:{margin:0},rules:l,dependencies:p,children:r}):B})};je.propTypes={editing:e.bool,dataIndex:e.string,title:e.string,inputType:e.string,record:e.objectOf(e.any),index:e.number,children:e.node};je.defaultProps={editing:!1,dataIndex:"",title:"",inputType:"",record:void 0,index:0,children:t("div",{})};const Ye=({hiddenAction:x,loading:f,idBuilding:E,filterObj:d,totalItem:u,apartments:y,tablePage:B,tablePageSize:k,handleTablePageChange:a,reloadContracts:r,showFormDetailContractTemplate:l,totalPayment:p,showFormShowFile:h,servicePermissionWrite:v,serviceActive:w,setEditRowKey:U,editRowKey:A,contractTemplates:P})=>{const i=Ke(),{layoutScrollRef:j}=O.useContext(Qe),g=lt(),{currentBuilding:I}=Le(),[m]=Pe.useForm(),[_,L]=O.useState(!1),[J,W]=O.useState({code:void 0,codeLanguage:void 0});tt(J.code,J.codeLanguage,{message:o.success,description:o.update_data_success},()=>{r()});const oe=c=>{U(c==null?void 0:c.key),m.setFieldsValue({oldIndex:0,newIndex:0,norm:0,deduct:0,...c,contractTemplate:c.contractTemplateId||""})},M=()=>{_?Fe.confirm({cancelText:o.cancel,okText:o.confirm,title:o.confirm,content:`${o.do_you_want_to_cancel_edit}?`,onOk:()=>{L(!1),U("")}}):U("")},ie=c=>{h({...c})},C=async()=>{if(_&&(m.setFieldsValue({...pt(m.getFieldsValue(),{})}),await m.validateFields())){W({code:void 0,codeLanguage:void 0});const T={contractTemplateId:m.getFieldValue("contractTemplate"),createdFor:b(d.closingPeriod).format("YYYYMM"),discountOriginal:m.getFieldValue("deduct"),startDate:b(d.opening).toDate(),endDate:b(d.closing).toDate(),oldIndex:Number(m.getFieldValue("oldIndex")),newIndex:Number(m.getFieldValue("newIndex")),numberPersonQuota:Number(m.getFieldValue("norm")),totalNumberUse:Number(m.getFieldValue("newIndex")-m.getFieldValue("oldIndex")),unitId:m.getFieldValue("key"),factor:m.getFieldValue("factor")};try{const Y=await Ft({idBuilding:E,contracts:[T]});W({code:Y.code}),ft.includes(Y.code)&&(U(""),L(!1))}catch(Y){W({code:Y.code,codeLanguage:Y.codeLanguage})}}},re=(c,T)=>{a(c,T)},te=()=>{_||L(!0)},Z=c=>{l({contractTemplate:c})},ae=[{title:o.unit,key:"apartment",width:150,children:[{title:o.total,key:"apartment",dataIndex:"apartment",fixed:"left",width:150}]},{title:o.tariff,key:"contractTemplate",width:250,ellipsis:!0,children:[{title:"",key:"contractTemplate",dataIndex:"contractTemplate",width:250,ellipsis:!0,editable:!0,render:(c,T)=>c?t(Se,{type:"link",style:{padding:0},onClick:()=>Z(T.contractTemplateObj),children:c}):null}]},{title:o.old_index,key:"oldIndex",align:"right",width:100,children:[{title:"",key:"oldIndex",dataIndex:"oldIndex",width:100,editable:!0,align:"right"}]},{title:o.new_index,key:"newIndex",align:"right",width:100,children:[{title:"",key:"newIndex",dataIndex:"newIndex",width:100,editable:!0,align:"right"}]},{title:o.norm,key:"norm",align:"right",width:100,children:[{title:"",key:"norm",dataIndex:"norm",width:100,editable:!0,align:"right"}]},w!=null&&w.isUsageFactor?{title:o.coefficient,key:"factor",align:"right",width:100,children:[{title:"",key:"factor",dataIndex:"factor",width:100,editable:!0,align:"right"}]}:null,{title:o.usage,key:"usage",align:"right",width:100,children:[{title:G((p==null?void 0:p.totalNumberUse)??0),key:"usage",dataIndex:"usage",align:"right",width:100}]},{title:o.subtotal,key:"subTotal",align:"right",width:150,children:[{title:G(+((p==null?void 0:p.totalPayment)??0)+ +((p==null?void 0:p.totalDiscountOriginal)??0)),key:"subTotal",dataIndex:"subTotal",align:"right",width:150}]},I.usingDiscountOriginal?{title:o.deduct,key:"deduct",align:"right",width:150,children:[{title:G((p==null?void 0:p.totalDiscountOriginal)??0),key:"deduct",dataIndex:"deduct",align:"right",editable:!0,width:150}]}:null,{title:o.total_payment,key:"totalPayment",align:"right",width:150,children:[{title:G((p==null?void 0:p.totalPayment)??0),key:"totalPayment",dataIndex:"totalPayment",align:"right",fixed:"right",width:150}]},{title:o.actions,key:"actions",dataIndex:"actions",align:"center",fixed:"right",width:100,render:(c,T)=>R(Ee,{children:[T.contractFile?t(ce,{onClick:()=>ie(T),name:"icon-image-outlined",style:{padding:0,fontSize:g.iconSize,marginRight:g.margin.xs},title:o.image}):null,v&&T.key===A?R(Ee,{children:[t(Se,{htmlType:"submit",type:"link",style:{marginRight:g.margin.xs,padding:0},disabled:!_,icon:t(ce,{title:o.save,style:{fontSize:g.iconSize},name:"icon-check-outlined"})}),t(ce,{title:o.delete,style:{fontSize:g.iconSize},name:"icon-close-outlined",onClick:M})]}):v&&!x.includes("EDIT")&&t(ce,{title:o.update,style:{fontSize:g.iconSize},name:"icon-edit-outlined",onClick:()=>{i({action:mt,label:Be}),oe(T)},disabled:!!(A&&T.key!==A)})||null]})}].filter(Boolean).map(c=>{if(c.children&&c.children.length>0){const T=c.children[0];return T.editable?{...c,children:[{...T,onCell:Y=>({record:Y,inputType:T.dataIndex==="contractTemplate"?"select":"number",dataIndex:T.dataIndex,title:T.title,editing:Y.key===A})}]}:c}return c.editable?{...c,onCell:T=>({record:T,inputType:c.dataIndex==="contractTemplate"?"select":"number",dataIndex:c.dataIndex,title:c.title,editing:T.key===A})}:c}),de=y.map(c=>{var Y,_e,xe,ee;const T=(Y=c==null?void 0:c.contracts)==null?void 0:Y[0];if(T){const{oldIndex:ue,newIndex:Ne,numberPersonQuota:K,discountOriginal:me,contractTemplateId:Oe,contractTemplate:H,totalNumberUse:$,contractFile:V=null,factor:be}=T,{formula:pe}=H;let se=pe?nt({formula:pe.formula,formulaType:pe.formulaType,norm:K,ratio:1,totalNumberUse:$}):0;se=Math.round(se);const ke=$,De=(se||0)-(me||0);return{key:c.id,apartment:c.name,oldIndex:ue,newIndex:Ne,norm:K||0,contractTemplate:H.name,factor:Ze.isNaN(be)?1:Number(be),usage:ke,subTotal:G(se),deduct:G(me),totalPayment:G(De),contractTemplateId:Oe,contractTemplates:c.contractTemplates,contractTemplateObj:H,contractFile:(V==null?void 0:V.files)??null,contractFileUpdatedAt:V!=null&&V.updatedAt?b(V==null?void 0:V.updatedAt).format(it):"",employeeName:((_e=V==null?void 0:V.employee)==null?void 0:_e.fullName)||"",departments:((ee=(xe=V==null?void 0:V.employee)==null?void 0:xe.departments)==null?void 0:ee.sort((fe,le)=>{var n,s;return((n=le==null?void 0:le.name)==null?void 0:n.length)-((s=fe==null?void 0:fe.name)==null?void 0:s.length)}))||[]}}return{key:c.id,apartment:c.name,oldIndex:0,newIndex:0,norm:0,contractTemplate:"",factor:1,usage:0,subTotal:0,deduct:0,totalPayment:0,contractTemplateId:void 0,contractTemplates:c.contractTemplates,contractTemplateObj:void 0}}),ne={pageSize:k,defaultCurrent:1,current:B,total:u,showQuickJumper:!0,showSizeChanger:!0,hideOnSinglePage:!0,onChange:re},ye={x:ae.reduce((c,T)=>c+ +T.width,0)};return t(Pe,{onFinish:C,onValuesChange:te,form:m,name:"formEditRow",children:t(rt,{components:{body:{cell:je}},loading:f,columns:ae,dataSource:de,pagination:ne,scroll:ye,sticky:{offsetScroll:g.offsetScrollX,getContainer:()=>j.current},bordered:!0})})};Ye.propTypes={hiddenAction:e.arrayOf(e.any),loading:e.bool,idBuilding:e.oneOfType([e.number,e.string]),filterObj:e.objectOf(e.any),totalItem:e.number,apartments:e.arrayOf(e.any),tablePage:e.number,tablePageSize:e.number,handleTablePageChange:e.func,reloadContracts:e.func,showFormDetailContractTemplate:e.func,totalPayment:e.objectOf(e.any),showFormShowFile:e.func,servicePermissionWrite:e.bool,serviceActive:e.objectOf(e.any),editRowKey:e.oneOfType([e.number,e.string]),setEditRowKey:e.func,contractTemplates:e.arrayOf(e.any)};Ye.defaultProps={hiddenAction:[],loading:!1,idBuilding:0,filterObj:void 0,totalItem:0,apartments:[],tablePage:0,tablePageSize:0,handleTablePageChange:()=>{},reloadContracts:()=>{},showFormDetailContractTemplate:()=>{},totalPayment:void 0,showFormShowFile:()=>{},servicePermissionWrite:!1,serviceActive:void 0,editRowKey:"",setEditRowKey:()=>{},contractTemplates:[]};const qe=({handleBtnRefresh:x,handleFilterChange:f,contractTemplates:E,formFilter:d,serviceActive:u})=>{const y=a=>{f({...a})},B=()=>{const a=d.getFieldValue("feeNotificationPeriod"),r=b(a);(u==null?void 0:u.feePeriodType)===Je&&r.add(1,"month"),(u==null?void 0:u.feePeriodType)===Ae&&r.subtract(1,"month");const l=b(r).startOf("month"),p=b(r).endOf("month");d.setFieldsValue({closingPeriod:r,opening:l,closing:p})},k=O.useMemo(()=>[{label:o.fee_notification_period,key:"feeNotificationPeriod",component:t(Ie,{allowClear:!1,fluid:"true",picker:"month",onChange:B,format:Te,placeholder:Te,getPopupContainer:a=>a.parentNode}),visible:!0,fixed:!0},{label:o.closing_period,key:"closingPeriod",component:t(Ie,{allowClear:!1,fluid:"true",picker:"month",disabled:!0,format:Te,placeholder:Te,getPopupContainer:a=>a.parentNode}),visible:!0,fixed:!0},{label:o.opening,key:"opening",component:t(Ie,{disabled:!0,allowClear:!1,fluid:"true",format:Ce,placeholder:Ce,getPopupContainer:a=>a.parentNode}),visible:!0,fixed:!0},{label:o.closing,key:"closing",component:t(Ie,{disabled:!0,allowClear:!1,fluid:"true",format:Ce,placeholder:Ce,getPopupContainer:a=>a.parentNode}),visible:!0,fixed:!0},{label:o.unit,key:"apartment",component:t(jt,{placeholder:o.unit}),visible:!0}],[E]);return t(ot.FilterBox,{formData:d,defaultFilter:{...ve},onSearch:y,layout:"vertical",filters:k,onRefresh:x})};qe.propTypes={handleFilterChange:e.func,contractTemplates:e.arrayOf(e.any),formFilter:e.objectOf(e.any),serviceActive:e.objectOf(e.any),handleBtnRefresh:e.objectOf(e.any)};qe.defaultProps={handleFilterChange:()=>{},contractTemplates:[],formFilter:void 0,serviceActive:void 0,handleBtnRefresh:void 0};const ze=x=>{const{idBuilding:f,onHide:E,refreshContracts:d,closingPeriod:u,opening:y,closing:B,idService:k,serviceType:a,contractTemplates:r,service:l}=x,{currentBuilding:p}=Le(),[h,v]=O.useState({isFetching:!1,code:void 0,codeLanguage:void 0,success:0,failed:0,errors:[],data:void 0});tt(h.code,h.codeLanguage,{message:o.success,description:o.import_data_success});const w=async P=>{var i,j,g,I;v({isFetching:!0,code:void 0,codeLanguage:void 0,success:0,failed:0,errors:[],data:void 0});try{const m=await Nt({idBuilding:f,file:P,dataAttach:{createdFor:b(u).format("YYYYMM"),startDate:b(y),endDate:b(B)}}),_=((j=(i=m==null?void 0:m.data)==null?void 0:i.errors)==null?void 0:j.map(L=>({index:L==null?void 0:L.index,code:(L==null?void 0:L.code)??500,message:L.message})))??[];await d(),v({isFetching:!1,code:m.code,codeLanguage:m.codeLanguage,success:((g=m==null?void 0:m.data)==null?void 0:g.success)??0,failed:_.length,errors:_,data:((I=m==null?void 0:m.data)==null?void 0:I.data)??void 0})}catch(m){v({isFetching:!1,code:m.code,codeLanguage:m.codeLanguage,success:0,failed:0,errors:[],data:void 0})}},U=async()=>{const P=await Ot({idBuilding:f,idService:k,serviceType:a}),i=(P==null?void 0:P.data)??"";qt(i,document,"mau-thong-tin-dich-vu-luu-chi-so-dau-cuoi.xlsx")},A=[{name:"#",rules:{type:"number",required:!0}},{name:"Căn hộ",rules:{type:"string",required:!0,max:255}},{name:"Chỉ số cũ",rules:{type:"number",validator(P,i,j,g,I){return i==null||i===""?new Error(o.status.data_require):Number.isNaN(+i)?new Error(o.index_must_be_number):i<0?new Error(o.index_must_greater_or_equal_than_min.replace("{min}",0)):i>9999999?new Error(o.index_must_lower_or_equal_than_max.replace("{max}",9999999)):i&&Math.ceil(i)>Math.ceil(g["Chỉ số mới"])?new Error(o.old_index_must_lower_or_equal_than_new_index):!0}}},{name:"Chỉ số mới",rules:{type:"number",validator(P,i,j,g,I){return i==null||i===""?new Error(o.status.data_require):Number.isNaN(+i)?new Error(o.index_must_be_number):i<0?new Error(o.index_must_greater_or_equal_than_min.replace("{min}",0)):i>99999999?new Error(o.index_must_lower_or_equal_than_max.replace("{max}",99999999)):i&&Math.ceil(i)<Math.ceil(g["Chỉ số cũ"])?new Error(o.old_index_must_lower_or_equal_than_new_index):!0}}},{name:"Định mức",rules:{type:"number",validator(P,i,j,g,I){return i==null||i===""?new Error(o.status.data_require):Number.isInteger(i)?i<0?new Error(o.index_must_greater_or_equal_than_min.replace("{min}",0)):i>50?new Error(o.index_must_lower_or_equal_than_max.replace("{max}",50)):!0:new Error(o.index_must_be_integer)}}},l!=null&&l.isUsageFactor?{name:"Hệ số nhân",rules:{type:"number",validator(P,i,j,g,I){return i==null||i===""?new Error(o.status.data_require):Number.isNaN(+i)?new Error(o.index_must_be_number):i<=0?new Error(o.index_must_greater_than_min.replace("{min}",0)):i>99999999?new Error(o.index_must_lower_or_equal_than_max.replace("{max}",99999999)):!0}}}:null,{name:"Biểu phí",rules:r&&r.length?{required:!0,type:"enum",enum:r.map(({name:P})=>P)}:{type:"string",required:!0,max:255}}].filter(Boolean);return p.usingDiscountOriginal&&A.push({name:"Khấu trừ",rules:{type:"number",validator(P,i,j,g,I){if(i==null||i==="")return new Error(o.status.data_require);if(!Number.isInteger(i))return new Error(o.index_must_be_integer);const m=g["Chỉ số cũ"],L=g["Chỉ số mới"]-m;return i&&L<=0?new Error(o.apartment_do_not_have_usage_number):!0}}}),t(Yt,{headers:A,onClose:E,onOk:w,visible:!0,code:h.code,codeLanguage:h.codeLanguage,loading:h.isFetching,numberSuccess:h.success,numberFail:h.failed,problemResponseServerDataSource:h.errors,errorFile:h.data,onDownloadTemplateFile:U})};ze.propTypes={idBuilding:e.oneOfType([e.number,e.string]),onHide:e.func,refreshContracts:e.func,closingPeriod:e.objectOf(e.any),opening:e.objectOf(e.any),closing:e.objectOf(e.any),idService:e.oneOfType([e.number,e.string]),serviceType:e.string,contractTemplates:e.arrayOf(e.any),service:e.objectOf(e.any)};ze.defaultProps={idBuilding:0,onHide:()=>{},refreshContracts:()=>{},closingPeriod:void 0,opening:void 0,closing:void 0,idService:0,serviceType:"",contractTemplates:[],service:void 0};const Ge=({contractTemplate:x,hideModal:f})=>{const{formula:E,surcharges:d,promotions:u}=x,y=[],B=[],k=[];if(E){const{formulaType:a,formula:r}=E;if(a===ht)y.push({formula:r.name||o.formula,price:G(r.price)});else if(a===gt)for(let l=0;l<r.length;l+=1)y.push({formula:`${r[l].from}${r[l].to?` - ${r[l].to}`:""}`,price:G(r[l].price)});else if(a===Tt)for(let l=0;l<r.length;l+=1)y.push({formula:r[l].name,price:G(r[l].price)})}if(d&&d.length)for(let a=0;a<d.length;a+=1)B.push({formula:d[a].name,price:`${d[a].price} ${d[a].type===yt?"(%)":""}`});return u&&u.length&&k.push({formula:u[0].name,price:`${u[0].price} (%)`}),t(Fe,{title:o.detail_tariff,footer:!1,onCancel:f,open:!0,children:R(Ve,{gutter:[12,12],children:[R(D,{span:"12",children:[t(he,{children:o.tariff}),t(ge,{children:x.name||"-"})]}),R(D,{span:"12",children:[t(he,{children:o.english_name}),t(ge,{children:x.enName||"-"})]}),R(D,{span:"12",children:[t(he,{children:o.deferred_interest}),t(ge,{children:x.deferredInterest||"-"})]}),R(D,{span:"12",children:[t(he,{children:o.pay_time}),t(ge,{children:x.payTime||"-"})]}),t(D,{span:"24",children:E&&R(Ee,{children:[t(he,{children:o.formula}),R(ge,{children:[E.name," - ",_t[E.formulaType].label]}),t(rt,{bordered:!0,size:"small",pagination:!1,columns:[{title:o.formula,key:"formula",dataIndex:"formula"},{title:o.price,key:"price",dataIndex:"price"}],dataSource:y})]})||null})]})})};Ge.propTypes={hideModal:e.func,contractTemplate:e.objectOf(e.any)};Ge.defaultProps={hideModal:()=>{},contractTemplate:{}};const Gt=({hideModalExportData:x,filter:f,totalItem:E,service:d})=>{const{idBuilding:u}=at(),{currentBuilding:y}=Le(),[B,k]=O.useState(0);return O.useEffect(()=>{(async()=>{var p,h,v,w,U,A,P;const a=[];let r=1;const l=Math.ceil(E/z);for(Dt({idBuilding:u,filter:{...f,onlyLogging:!0,serviceName:d==null?void 0:d.name}});r<=l;){k(Math.ceil(r/l*100));const i=await et({idBuilding:u,filter:{createdFor:b(f.closingPeriod).format("YYYYMM"),from:b(f.opening).startOf("day").toDate(),to:b(f.closing).endOf("day").toDate(),serviceId:f.serviceId,serviceType:f.serviceType,unitName:f.apartment,unitGroupId:u,contractTemplateId:f.contractTemplateId?f.contractTemplateId:void 0},page:r,limit:z});if(i.data.length>0){const j=a.length;for(let g=0;g<i.data.length;g+=1){const I=i.data[g],m=(p=I==null?void 0:I.contracts)==null?void 0:p[0];let _;if(m){const{oldIndex:L,newIndex:J,numberPersonQuota:W,discountOriginal:oe,contractTemplate:M,totalNumberUse:ie,contractFile:C,factor:re}=m,{formula:te}=M;let Z=te?nt({formula:te.formula,formulaType:te.formulaType,norm:W,ratio:1,totalNumberUse:ie}):0;Z=Math.round(Z);const ae=ie,de=Number(Z||0)-Number(oe||0);_=[j+g+1,(I==null?void 0:I.name)??"",(M==null?void 0:M.name)??"",Number(L||0),Number(J||0),Number(W||0),Number(ae||0)],d!=null&&d.isUsageFactor&&_.splice(6,0,Ze.isNaN(re)?1:Number(re)),y.usingDiscountOriginal&&(_.push(Number(Z||0)),_.push(Number(oe||0))),_.push(de),_.push((C==null?void 0:C.files)||""),_.push(C!=null&&C.updatedAt?b(C==null?void 0:C.updatedAt).format(it):""),_.push(((h=C==null?void 0:C.employee)==null?void 0:h.fullName)||""),_.push((w=(v=C==null?void 0:C.employee)==null?void 0:v.departments)!=null&&w.length?(P=(A=(U=C==null?void 0:C.employee)==null?void 0:U.departments)==null?void 0:A.map(ne=>ne==null?void 0:ne.name))==null?void 0:P.join(", "):"")}else _=[j+g+1,(I==null?void 0:I.name)??"","",0,0,0,0],d!=null&&d.isUsageFactor&&_.splice(6,0,1),y.usingDiscountOriginal&&(_.push(0),_.push(0)),_.push(0);a.push(_)}r+=1}else{r=0;break}}a.unshift(["#","Căn hộ","Biểu phí","Chỉ số cũ","Chỉ số mới","Định mức",d!=null&&d.isUsageFactor?"Hệ số nhân":null,"Số sử dụng",y.usingDiscountOriginal?"Tạm tính":null,y.usingDiscountOriginal?"Khấu trừ":null,"Tổng tiền","Ảnh chốt số","Ngày cập nhật ảnh chốt số","Người thực hiện chốt số","Phòng ban"].filter(Boolean)),setTimeout(()=>{zt(a,"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8","thong-tin-dich-vu-luu-chi-so-dau-cuoi",".xlsx"),At.success({description:o.success,message:o.export_data_success}),x()},3e3)})()},[]),[B]},He=({hideModalExportData:x,filter:f,totalItem:E,service:d})=>{const[u]=Gt({hideModalExportData:x,filter:f,totalItem:E,service:d});return t(Fe,{open:!0,closable:!1,footer:!1,children:t(Lt,{strokeColor:{from:"#108ee9",to:"#87d068"},percent:u,status:"active",css:y=>({marginTop:y.margin.xs})})})};He.propTypes={hideModalExportData:e.func,filter:e.objectOf(e.any),totalItem:e.number,service:e.objectOf(e.any)};He.defaultProps={hideModalExportData:()=>{},filter:void 0,totalItem:0,service:void 0};const $e=({contract:x,hideFormShowFile:f,formFilter:E,service:d})=>{const{contractFile:u,contractFileUpdatedAt:y,apartment:B,employeeName:k,departments:a}=x,r=E.getFieldValue("feeNotificationPeriod");return t(Fe,{open:!0,onCancel:f,footer:null,title:o.detail,width:"55%",children:R(Ve,{gutter:[8,16],children:[t(D,{span:8,children:R(q.Text,{strong:!0,children:[o.unit,":"]})}),t(D,{span:16,children:t(q.Text,{children:B})}),t(D,{span:8,children:R(q.Text,{strong:!0,children:[o.service,":"]})}),t(D,{span:16,children:t(q.Text,{children:d.name})}),t(D,{span:8,children:R(q.Text,{strong:!0,children:[o.label.executor,":"]})}),t(D,{span:16,children:t(q.Text,{children:k})}),t(D,{span:8,children:R(q.Text,{strong:!0,children:[o.department,":"]})}),t(D,{span:16,children:t(q.Text,{children:a!=null&&a.length?a==null?void 0:a.map(l=>t("div",{style:{display:"inline-block",marginBottom:"5px",width:"fit-content"},children:t(Vt,{style:{marginRight:"4px"},color:"blue",children:l==null?void 0:l.name})},l==null?void 0:l.id)):""})}),t(D,{span:8,children:R(q.Text,{strong:!0,children:[o.fee_notification_period,":"]})}),t(D,{span:16,children:t(q.Text,{children:b(r).format(Te)})}),t(D,{span:8,children:R(q.Text,{strong:!0,children:[o.updated_date,":"]})}),t(D,{span:16,children:t(q.Text,{children:y})}),t(D,{span:24,style:{textAlign:"center"},children:t(Ut,{src:u,height:450})})]})})};$e.propTypes={contract:e.objectOf(e.any),hideFormShowFile:e.func,formFilter:e.objectOf(e.any),service:e.objectOf(e.any)};$e.defaultProps={contract:void 0,hideFormShowFile:()=>{},formFilter:void 0,service:void 0};const Ro=()=>{const{setVisibleSearchBox:x,setTitlePage:f,setVisibleFilterBox:E}=O.useContext(Qe),d=at(),{idBuilding:u}=d,{serviceInUses:y,getServiceInUses:B}=St(),[k,a]=O.useState(""),[r,l]=O.useState({...ve}),[p,h]=O.useState(),[v,w]=O.useState(1),[U,A]=O.useState(z),[P,i]=O.useState([]),[j,g]=O.useState([]),[I,m]=O.useState(0),[_,L]=O.useState(),[J,W]=O.useState(!1),[oe,M]=O.useState(!1),[ie,C]=O.useState(""),[re,te,Z]=we(),[ae,de,ne]=we(),[ye,c,T]=we(),[Y,_e,xe]=we(),[ee]=Pe.useForm(),ue=({feePeriodType:n=Ae,serviceId:s,serviceType:F})=>{const X=b(),S=b();n===Je&&S.add(1,"month"),n===Ae&&S.subtract(1,"month");const N=b(S).startOf("month"),Q=b(S).endOf("month");return{...ve,feeNotificationPeriod:X,closingPeriod:S,opening:N,closing:Q,serviceId:s,serviceType:F,feePeriodType:n}},{getPermissionByModuleCode:Ne}=xt(),K=Ne(bt),me=(K==null?void 0:K[wt])??!1,Oe=(K==null?void 0:K[It])??!1,H=async n=>{const s={createdFor:b(n.closingPeriod).format("YYYYMM"),from:b(n.opening).startOf("day").toDate(),to:b(n.closing).endOf("day").toDate(),serviceId:n.serviceId,serviceType:n.serviceType,unitName:n.apartment,unitGroupId:u,contractTemplateId:n.contractTemplateId?n.contractTemplateId:void 0},F=await kt({idBuilding:u,filter:s});return L(F==null?void 0:F.data),F},$=async(n,s,F)=>{const X={createdFor:b(n.closingPeriod).format("YYYYMM"),from:b(n.opening).startOf("day").toDate(),to:b(n.closing).endOf("day").toDate(),serviceId:n.serviceId,serviceType:n.serviceType,unitName:n.apartment,unitGroupId:u,contractTemplateId:n.contractTemplateId?n.contractTemplateId:void 0},S=await et({idBuilding:u,filter:X,page:s,limit:F});return g((S==null?void 0:S.data)??[]),m((S==null?void 0:S.totalRecord)??0),S},V=async()=>{var F,X;W(!0);const n=await B({idBuilding:u,filter:{serviceType:Ct}}),s=(n==null?void 0:n.data)??[];if(s.length>0){const S=((X=(F=n==null?void 0:n.data)==null?void 0:F[0])==null?void 0:X.id)??"",N=s.find(st=>st.id===S);h(N),a(S);const Q=ue({feePeriodType:N==null?void 0:N.feePeriodType,serviceId:S,serviceType:N==null?void 0:N.serviceType});l({...Q}),ee.setFieldsValue({feeNotificationPeriod:Q.feeNotificationPeriod,closingPeriod:Q.closingPeriod,opening:Q.opening,closing:Q.closing});const Me=await Xe({idBuilding:u,filter:{serviceId:S}});i(Me==null?void 0:Me.data),await $({...Q,serviceId:S,serviceType:N==null?void 0:N.serviceType,feePeriodType:N==null?void 0:N.feePeriodType},v,U),await H({...Q,serviceId:S,serviceType:N==null?void 0:N.serviceType,feePeriodType:N==null?void 0:N.feePeriodType})}W(!1)};O.useEffect(()=>(x(!0),f(o.save_from_to),(async()=>await V())(),()=>{x(!1),E(!1),f("")}),[]);const be=async n=>{if(n!==k){M(!0);const s=y.find(S=>S.id===n);h(s),a(n);const F=ue({feePeriodType:s==null?void 0:s.feePeriodType,serviceId:n,serviceType:s==null?void 0:s.serviceType});l({...F}),ee.setFieldsValue({feeNotificationPeriod:F.feeNotificationPeriod,closingPeriod:F.closingPeriod,opening:F.opening,closing:F.closing}),w(1),A(z),await $({...F,serviceId:n,serviceType:s==null?void 0:s.serviceType,feePeriodType:s==null?void 0:s.feePeriodType},1,z),await H({...F,serviceId:n,serviceType:s==null?void 0:s.serviceType,feePeriodType:s==null?void 0:s.feePeriodType});const X=await Xe({idBuilding:u,filter:{serviceId:n}});i(X==null?void 0:X.data),M(!1)}},pe=()=>{(async()=>{M(!0);const n=y.find(F=>F.id===k);h(n);const s=ue({feePeriodType:n==null?void 0:n.feePeriodType,serviceId:n==null?void 0:n.id,serviceType:n==null?void 0:n.serviceType});l({...s}),ee.setFieldsValue({feeNotificationPeriod:s.feeNotificationPeriod,closingPeriod:s.closingPeriod,opening:s.opening,closing:s.closing}),w(Et),A(z),await $({...s,serviceId:n==null?void 0:n.id,serviceType:n==null?void 0:n.serviceType,feePeriodType:n==null?void 0:n.feePeriodType},1,z),await H({...s,serviceId:n==null?void 0:n.id,serviceType:n==null?void 0:n.serviceType,feePeriodType:n==null?void 0:n.feePeriodType}),M(!1)})()},se=async n=>{M(!0),w(1),A(z),l({...r,...n}),await $({...r,...n},1,z),await H({...r,...n}),M(!1)},ke=async(n,s)=>{M(!0),n!==v&&w(n),s!==U&&A(s),await $({...r},n,s),M(!1)},De=async()=>{M(!0),w(1),A(z),await $({...r},1,z),await H({...r}),M(!1)},fe=async()=>{M(!0),await $({...r},v,U),await H({...r}),M(!1)},le=P.length===0?["IMPORT","EXPORT","EDIT"]:[];return J?t(Pt,{isLoading:J}):R(Ve,{style:{flex:1,height:"100%"},children:[t(D,{style:{flex:1},span:"4",children:t(Rt,{menuActiveKey:k,handleSelectService:be,services:y,setEditRowKey:C})}),t(D,{style:{flex:1,display:"flex",flexDirection:"column",position:"relative"},span:"20",children:R(Ee,{children:[P.length===0&&!J?t(Mt,{}):null,t(qe,{formFilter:ee,contractTemplates:P,handleFilterChange:se,serviceActive:p,handleBtnRefresh:pe}),R(Re,{style:{flex:1},children:[t(Re.Header,{children:t(Ue,{hiddenAction:le,totalItem:I,showFormImportContract:te,showFormExportContract:de,servicePermissionWrite:me,servicePermissionExport:Oe})}),t(Re.Content,{fluid:!0,children:t(Ye,{hiddenAction:le,totalPayment:_,totalItem:I,idBuilding:u,filterObj:r,reloadContracts:fe,loading:oe,apartments:j,tablePage:v,tablePageSize:U,handleTablePageChange:ke,showFormDetailContractTemplate:_e,showFormShowFile:c,servicePermissionWrite:me,serviceActive:p,setEditRowKey:C,editRowKey:ie,contractTemplates:P})})]}),re.isShow&&t(ze,{idBuilding:u,onHide:Z,refreshContracts:De,closingPeriod:r.closingPeriod,opening:r.opening,closing:r.closing,idService:r.serviceId,serviceType:r.serviceType,contractTemplates:P,service:p}),Y.isShow&&t(Ge,{contractTemplate:Y.data.contractTemplate,hideModal:xe}),ae.isShow?t(He,{filter:r,hideModalExportData:ne,totalItem:I,service:p}):null,ye.isShow?t($e,{hideFormShowFile:T,contract:ye.data,formFilter:ee,service:p}):null]})})]})};export{Ro as default};
