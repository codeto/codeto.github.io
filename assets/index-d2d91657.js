import{j as t,u as G,a as w,b as A}from"./@emotion-63839449.js";import{F as f,u as Y}from"./index-687ba9e6.js";import{B as N}from"./index-881eef42.js";import{r as h}from"./react-4fd50329.js";import{P as H}from"./prop-types-1172f4d5.js";import{K as j,l as i,I as R,e7 as X,ft as $,e8 as W,b1 as z,fv as K,e9 as J,S as Q,c6 as T,w as Z,fw as V}from"./index-c2ded735.js";import"./react-redux-896b353b.js";import"./lodash-88fe09e6.js";import{h as _}from"./moment-a468e1f9.js";import"./file-saver-40cf32a9.js";import{u as ee}from"./useService-37d60dc0.js";import"./@firebase-43527ee1.js";import{b as p,B as D,R as E,S as te}from"./antd-f9eae174.js";import{S,I as re}from"./index-43183512.js";import{D as q,l as B,d as ie,k as M}from"./index-b17d22e5.js";import{u as L}from"./react-router-a4308f7b.js";import{m as ne,n as oe}from"./bill-d9d0423c.js";import{g as k}from"./getListApartment-f9e300ed.js";import{I as U}from"./index-0335a746.js";import{c as ae}from"./calculateClosing-26527bc8.js";import"./hoist-non-react-statics-23d96a9a.js";import"./react-is-e8e5dbb3.js";import"./@babel-b64fd0f9.js";import"./stylis-79144faa.js";import"./classnames-4ba1ba1a.js";import"./redux-10bbab4c.js";import"./react-router-dom-2a8f5f6d.js";import"./history-a1882333.js";import"./resolve-pathname-e210f2ac.js";import"./tiny-invariant-dd7d57d2.js";import"./react-dom-40621ea0.js";import"./scheduler-765c72db.js";import"./@redux-saga-8bafe09b.js";import"./redux-logger-e1c9ca90.js";import"./dompurify-8e338605.js";import"./query-string-f5cca1e7.js";import"./decode-uri-component-4138e85d.js";import"./split-on-first-4f1167c8.js";import"./filter-obj-2ed190f4.js";import"./oidc-client-7da0eaf7.js";import"./firebase-878887a2.js";import"./rc-pagination-c1e6a0ac.js";import"./rc-picker-2e3d5fe5.js";import"./rc-util-0bc219f3.js";import"./rc-trigger-570b13ec.js";import"./rc-motion-ae889c42.js";import"./rc-align-e5d7b12e.js";import"./dom-align-ecb06dd6.js";import"./resize-observer-polyfill-0f9f8adb.js";import"./rc-resize-observer-b9ad4e29.js";import"./@ant-design-cba9d434.js";import"./@ctrl-fb5a5473.js";import"./rc-tabs-dfd19a56.js";import"./rc-dropdown-5378dd0a.js";import"./rc-menu-b15ebfe9.js";import"./rc-overflow-6be96612.js";import"./rc-select-564caf01.js";import"./rc-virtual-list-8a7b82a6.js";import"./rc-collapse-11b7d3c4.js";import"./shallowequal-4542d6f7.js";import"./rc-drawer-317f0b4d.js";import"./@rc-component-5a112e55.js";import"./rc-field-form-ef5549aa.js";import"./async-validator-dee29e8b.js";import"./scroll-into-view-if-needed-6b992d05.js";import"./compute-scroll-into-view-183f845a.js";import"./rc-image-e0357917.js";import"./rc-dialog-b1d1f07b.js";import"./rc-input-number-8bc068f7.js";import"./rc-rate-c64cf0d5.js";import"./rc-steps-2d1924c7.js";import"./rc-switch-b4e96de7.js";import"./rc-table-191ecc42.js";import"./rc-checkbox-018e8052.js";import"./rc-tree-67773537.js";import"./rc-tree-select-cb7eccc3.js";import"./copy-to-clipboard-64585c8c.js";import"./toggle-selection-93f4ad84.js";import"./rc-textarea-d01adcbb.js";import"./rc-input-02c2c2ba.js";import"./rc-upload-3ab0f08a.js";import"./rc-notification-d13dc43b.js";import"./rc-progress-4f1a7096.js";import"./rc-tooltip-08fa4217.js";import"./use-sync-external-store-5d1b6592.js";import"./idb-cdd1a92f.js";import"./path-to-regexp-ef8d5544.js";import"./account-86ffff50.js";import"./libphonenumber-js-0d5a9c92.js";import"./react-infinite-scroll-component-e33646cb.js";import"./downloadFileFromUrl-79614833.js";import"./regex-deefadac.js";import"./xlsx-0fb7ed70.js";import"./uuid-4a60fe23.js";const y=h.createContext({modalImportBillManual:void 0,showModalImportBillManual:()=>{},hideModalImportBillManual:()=>{},formCreateBill:void 0,createBillStatus:{isFetching:!1,code:void 0,codeLanguage:void 0},setCreateBillStatus:()=>{},listService:[],getServiceInUses:()=>{},loadingService:!1,listApartment:[],setListApartment:()=>{},getListApartmentStatus:{isFetching:!1},setGetListApartmentStatus:()=>{},serviceSelected:void 0,setServiceSelected:()=>{}}),P=s=>{const{children:e}=s,[n,l]=h.useState({isFetching:!1,code:void 0,codeLanguage:void 0}),[c,a,r]=j(),[o]=f.useForm(),{serviceInUses:m,getServiceInUses:u,loading:I}=ee(),[g,b]=h.useState([]),[d,x]=h.useState({isFetching:!1}),[v,F]=h.useState(void 0),C={modalImportBillManual:c,showModalImportBillManual:a,hideModalImportBillManual:r,formCreateBill:o,createBillStatus:n,setCreateBillStatus:l,listService:m,getServiceInUses:u,loadingService:I,listApartment:g,setListApartment:b,getListApartmentStatus:d,setGetListApartmentStatus:x,serviceSelected:v,setServiceSelected:F};return t(y.Provider,{value:C,children:e})};P.propTypes={children:H.node};P.defaultProps={children:t("div",{})};const se=P,le=()=>{const{showModalImportBillManual:s}=h.useContext(y);return[()=>{s()}]},de=()=>{const[s]=le(),e=G();return w(E,{css:A({paddingBottom:e.padding.sm},"",""),gutter:[e.margin.sm,0],children:[t(p,{span:"12",children:t("p",{css:A({margin:0,fontWeight:e.fontWeight.bold,fontSize:e.heading.three},"",""),children:i.manual_create_service_fee})}),t(p,{span:"12",style:{textAlign:"right"},children:t(D,{onClick:s,icon:t(R,{name:"icon-upload-outlined"}),type:"primary",children:i.import})})]})},ce=()=>{const s=L(),{idBuilding:e}=s,{loadingService:n,getServiceInUses:l,formCreateBill:c,listService:a,serviceSelected:r}=h.useContext(y);return h.useEffect(()=>{l({idBuilding:e})},[]),h.useEffect(()=>{const o=c.getFieldValue("feeNotificationMonth");let m=_(o),u=_(o);(r==null?void 0:r.feePeriodType)===X?(m=_(o).add(1,"month").startOf("month"),u=_(o).add(1,"month").endOf("month")):(r==null?void 0:r.feePeriodType)===$?(m=_(o).startOf("month"),u=_(o).endOf("month")):(r==null?void 0:r.feePeriodType)===W&&(m=_(o).subtract(1,"month").startOf("month"),u=_(o).subtract(1,"month").endOf("month")),c.setFieldsValue({period:[m,u]})},[r]),{loadingService:n,listService:a}},me=()=>{const{loadingService:s,listService:e}=ce();return w("div",{children:[t(z,{isLoading:s}),w(E,{gutter:[12,0],children:[t(p,{span:"24",children:t(f.Item,{label:i.bill_type,rules:[{required:!0}],name:"billType",children:t(S,{fluid:"true",placeholder:i.bill_type,children:K.map(n=>t(S.Option,{value:n.id,children:n.name},n.id))})})}),t(p,{span:"24",children:t(f.Item,{label:i.fee_notification_month,rules:[{required:!0}],name:"feeNotificationMonth",children:t(q,{allowClear:!1,picker:"month",fluid:"true",format:"MM/YYYY",placeholder:"MM/YYYY"})})}),t(p,{span:"24",children:t(f.Item,{label:i.service,rules:[{required:!0}],name:"service",children:t(S,{placeholder:i.service,fluid:"true",loading:s,children:e.map(n=>t(S.Option,{value:n.id,children:n.name},n.id))})})}),t(p,{span:"24",children:t(f.Item,{label:`${i.opening} - ${i.closing}`,name:"period",rules:[{required:!0},({getFieldValue:n})=>({validator(l,c){if(c&&c.length>1){const a=_(c[0]).startOf("day");if(_(a).add(1,"month").startOf("day").diff(a,"day",!0)<n("amountDate"))return Promise.reject(i.opening_or_closing_invalid)}return Promise.resolve()}})],children:t(q.RangePicker,{allowClear:!1,format:[B,B],placeholder:[B,B],fluid:"true"})})})]})]})},ue=async(s,e)=>{try{const{billType:n,feeNotificationMonth:l,service:c,period:a,unit:r,totalPayment:o,totalNumberUse:m,newIndex:u,oldIndex:I,note:g,servicePrice:b}=e,d=_(l).format("YYYYMM"),x=_(a[0]).format("DD/MM/YYYY"),v=_(a[1]).format("DD/MM/YYYY"),C=await ne(s,{type:n,incurredCreatedFor:d,serviceId:c,oldIndex:I||I===0?I:null,newIndex:u||null,totalPayment:o,unitId:r,totalNumberUse:m,startDate:x,endDate:v,content:g,servicePrice:b||null});return{code:C.code,codeLanguage:C.codeLanguage}}catch(n){return{code:n.code,codeLanguage:n.codeLanguage}}},pe=()=>{const{listApartment:s,getListApartmentStatus:e,setGetListApartmentStatus:n,setListApartment:l,formCreateBill:c,setCreateBillStatus:a,createBillStatus:r,serviceSelected:o}=h.useContext(y),m=L(),{idBuilding:u}=m;Y(r.code,r.codeLanguage,{message:i.success,description:i.create_service_fee_success});const I=async d=>{n({isFetching:!0});const x=await k({filter:{name:d},idBuilding:u});l(x.data),n({isFetching:!1})},g=async()=>{if(await c.validateFields()){a({isFetching:!0,code:void 0,codeLanguage:void 0});const{code:x,codeLanguage:v}=await ue(u,c.getFieldsValue());Q.includes(x)&&c.setFieldsValue({unit:void 0,note:void 0}),a({isFetching:!1,code:x,codeLanguage:v})}},b=h.useMemo(()=>!!(o&&o.serviceType===J),[o]);return{listApartment:s,loadingApartment:e.isFetching,onSearch:I,onClickBtnCreateServiceFee:g,loadingCreateBill:r.isFetching,isChangeIndex:b}},he=()=>{const{loadingApartment:s,onSearch:e,listApartment:n,onClickBtnCreateServiceFee:l,loadingCreateBill:c,isChangeIndex:a}=pe();return w(E,{gutter:[12,0],children:[t(p,{span:"24",children:t(f.Item,{label:i.unit,rules:[{required:!0}],name:"unit",children:t(S,{placeholder:i.unit,loading:s,onSearch:ie(e),showSearch:!0,fluid:"true",filterOption:!1,dropdownRender:r=>s?t("div",{style:{display:"flex",flexDirection:"row",justifyContent:"center",alignItems:"center"},children:t(te,{})}):r,children:n.map(r=>t(S.Option,{value:r.id,children:r.name},r.id))})})}),t(p,{span:"4",children:t(f.Item,{label:i.old_index,name:"oldIndex",rules:[{required:a},({getFieldValue:r})=>({validator(o,m){const u=r("newIndex");return!m||!u||+u>=+m?Promise.resolve():Promise.reject(new Error(i.old_index_must_lower_or_equal_than_new_index))}})],children:t(M,{placeholder:i.old_index,min:0,disabled:!a,max:9999999})})}),t(p,{span:"4",children:t(f.Item,{label:i.new_index,name:"newIndex",rules:[{required:a},({getFieldValue:r})=>({validator(o,m){const u=r("oldIndex");return!m||!u||+u<=+m?Promise.resolve():Promise.reject(new Error(i.old_index_must_lower_or_equal_than_new_index))}})],children:t(M,{placeholder:i.new_index,min:0,disabled:!a,max:9999999})})}),t(p,{span:"4",children:t(f.Item,{noStyle:!0,shouldUpdate:(r,o)=>(r==null?void 0:r.oldIndex)!==(o==null?void 0:o.oldIndex)||(r==null?void 0:r.newIndex)!==(o==null?void 0:o.newIndex),children:({getFieldValue:r})=>{const o=r("oldIndex"),m=r("newIndex");return t(f.Item,{label:i.usage,name:"totalNumberUse",rules:[{required:!0}],children:t(M,{placeholder:i.usage,disabled:o||m,min:1})})}})}),t(p,{span:"6",children:t(f.Item,{label:i.label.price_unit,name:"servicePrice",children:t(M,{formatter:r=>T(r),min:0,placeholder:i.label.price_unit,max:Number.MAX_SAFE_INTEGER})})}),t(p,{span:"6",children:t(f.Item,{noStyle:!0,shouldUpdate:(r,o)=>(r==null?void 0:r.servicePrice)!==(o==null?void 0:o.servicePrice),children:({getFieldValue:r})=>{const o=r("servicePrice");return t(f.Item,{label:i.total_payment,name:"totalPayment",rules:[{required:!0}],children:t(M,{formatter:m=>T(m),min:0,placeholder:i.total_payment,max:Number.MAX_SAFE_INTEGER,disabled:o})})}})}),t(p,{span:"24",children:t(f.Item,{name:"note",label:i.note,children:t(re.TextArea,{maxLength:"3000",placeholder:i.note,rows:"3"})})}),t(p,{span:"24",style:{textAlign:"right"},children:t(D,{disabled:c,onClick:l,icon:t(R,{name:"icon-plus-circle-outlined"}),type:"primary",children:i.create_service_fee})})]})},fe=async(s,e)=>{var n;try{const{code:l,codeLanguage:c,data:a}=await oe(s,e);return{code:l,codeLanguage:c,totalSuccess:(a==null?void 0:a.success)??0,totalFailed:((a==null?void 0:a.errors)??[]).length,errors:((n=a==null?void 0:a.errors)==null?void 0:n.map(r=>({index:r.index,message:r.message,code:r.code})))??[],data:a,errorFile:a==null?void 0:a.errorFile}}catch({code:l,codeLanguage:c}){return{code:l,codeLanguage:c,totalSuccess:0,totalFailed:0,errors:[],data:void 0,errorFile:void 0}}},{rules:_e}=U,{dateImportRule:O,monthImportRule:ge}=_e,xe=[{name:"#",rules:{type:"number",required:!0}},{name:"Căn hộ",rules:{type:"string",required:!0,max:256}},{name:"Loại hóa đơn",rules:{type:"enum",required:!0,enum:["Hóa đơn tròn tháng","Hóa đơn một phần của tháng","Hóa đơn nửa tháng"]}},{name:"Tên dịch vụ",rules:{type:"string",required:!0,max:256}},{name:"Chỉ số cũ",rules:{type:"number",validator(s,e,n,l,c){return e==null||e===""?new Error(i.data_require):Number.isNaN(+e)?new Error(i.index_must_be_number):e<0?new Error(i.index_must_greater_or_equal_than_min.replace("{min}",0)):e>9999999?new Error(i.index_must_lower_or_equal_than_max.replace("{max}",9999999)):e&&Math.ceil(e)>Math.ceil(l["Chỉ số mới"])?new Error(i.old_index_must_lower_or_equal_than_new_index):!0}}},{name:"Chỉ số mới",rules:{type:"number",validator(s,e,n,l,c){return e==null||e===""?new Error(i.data_require):Number.isNaN(+e)?new Error(i.index_must_be_number):e<0?new Error(i.index_must_greater_or_equal_than_min.replace("{min}",0)):e>9999999?new Error(i.index_must_lower_or_equal_than_max.replace("{max}",9999999)):e&&Math.ceil(e)<Math.ceil(l["Chỉ số cũ"])?new Error(i.old_index_must_lower_or_equal_than_new_index):!0}}},{name:"Số sử dụng",rules:{type:"number",max:Number.MAX_SAFE_INTEGER,required:!0}},{name:"Ngày đầu kỳ",rules:{...O,required:!0}},{name:"Ngày cuối kỳ",rules:{...O,required:!0}},{name:"Tháng thông báo phí",rules:{...ge,required:!0}},{name:"Đơn giá",rules:{type:"number",validator(s,e,n,l,c){if(e||e===0){if(Number.isNaN(+e))return new Error(i.index_must_be_number);if(e<0)return new Error(i.index_must_greater_or_equal_than_min.replace("{min}",0));if(e>Number.MAX_SAFE_INTEGER)return new Error(i.index_must_lower_or_equal_than_max.replace("{max}",Number.MAX_SAFE_INTEGER));if(Math.round(Number(l["Số sử dụng"])*Number(e))!==Number(l["Tổng tiền"]))return new Error(i.total_payment_invalid)}return!0}}},{name:"Tổng tiền",rules:{type:"number",max:Number.MAX_SAFE_INTEGER,required:!0}},{name:"Ghi chú",rules:{type:"string",max:3e3}}],Ie=()=>{const{idBuilding:s}=L(),{hideModalImportBillManual:e}=h.useContext(y),[n,l]=h.useState({isFetching:!1,code:void 0,codeLanguage:void 0,totalSuccess:0,totalFailed:0,errors:[],data:[],errorFile:void 0});return Y(n.code,n.codeLanguage,{message:i.success,description:i.import_data_success}),{headers:xe,importBillManualStatus:n,handleImportBillManual:async r=>{l({isFetching:!0,code:void 0,codeLanguage:void 0,totalSuccess:0,totalFailed:0,errors:[],data:[],errorFile:void 0});const{code:o,codeLanguage:m,totalSuccess:u,totalFailed:I,errors:g,data:b,errorFile:d}=await fe(s,r);l({isFetching:!1,code:o,codeLanguage:m,totalSuccess:u,totalFailed:I,errors:g,data:b,errorFile:d})},handleCancelImportBillManual:()=>e()}},be=()=>{const{headers:s,importBillManualStatus:e,handleImportBillManual:n,handleCancelImportBillManual:l}=Ie();return t(U,{headers:s,onClose:l,onOk:n,visible:!0,fileNameTemplate:"mau-thong-tin-phi-dich-vu",templateUrl:Z.document.mau_thong_tin_phi_dich_vu,code:e.code,codeLanguage:e.codeLanguage,loading:e.isFetching,numberSuccess:(e==null?void 0:e.totalSuccess)??0,numberFail:(e==null?void 0:e.totalFailed)??0,problemResponseServerDataSource:(e==null?void 0:e.errors)??[],errorFile:(e==null?void 0:e.errorFile)??null})},ve=()=>{const{formCreateBill:s,setGetListApartmentStatus:e,setListApartment:n,setServiceSelected:l,serviceSelected:c,listService:a,modalImportBillManual:r}=h.useContext(y),o=L(),{idBuilding:m}=o,u=(g,b)=>{const d={...b};if(g.service){const x=a.find(v=>v.id===g.service);l(x),d.totalNumberUse=void 0,d.newIndex=void 0,d.oldIndex=void 0,d.servicePrice=void 0}if(g.feeNotificationMonth){const x=_(g.feeNotificationMonth).startOf("month"),{opening:v,closing:F}=ae(x,c==null?void 0:c.feePeriodType,1,"month");d.period=[v,F]}(d.oldIndex||d.oldIndex===0)&&(d.newIndex||d.newIndex===0)&&d.oldIndex<d.newIndex&&(d.totalNumberUse=Number((+d.newIndex-+d.oldIndex).toFixed(3))),(d.servicePrice||d.servicePrice===0)&&d.totalNumberUse&&(d.totalPayment=Math.round(Number(d.servicePrice)*Number(d.totalNumberUse))),s.setFieldsValue({...d})};h.useEffect(()=>{document.title=i.manual_create_service_fee},[]),h.useEffect(()=>{(async()=>{e({isFetching:!0});const g=await k({idBuilding:m});n(g.data),e({isFetching:!1})})()},[]);const I={billType:V,feeNotificationMonth:_(),service:void 0,period:[],unit:void 0,totalPayment:void 0,totalNumberUse:void 0,newIndex:void 0,oldIndex:void 0,note:void 0,servicePrice:void 0};return{isShowModalImportBillManual:r.isShow,formCreateBill:s,onValuesChange:u,initialValues:I}},Se=()=>{const{isShowModalImportBillManual:s,formCreateBill:e,onValuesChange:n,initialValues:l}=ve();return w(f,{onValuesChange:n,initialValues:l,layout:"vertical",name:"formCreateBill",form:e,style:{flex:1,height:"100%",display:"flex",flexDirection:"column"},children:[t(de,{}),w(E,{style:{flex:1},gutter:[12,12],children:[t(p,{style:{flex:1,display:"flex",flexDirection:"column"},span:"8",children:t(N,{style:{flex:1},children:t(N.Content,{scrollY:!0,children:t(me,{})})})}),t(p,{style:{flex:1,display:"flex",flexDirection:"column"},span:"16",children:t(N,{children:t(N.Content,{children:t(he,{})})})})]}),s?t(be,{}):null]})},dr=()=>t(se,{children:t(Se,{})});export{dr as default};
