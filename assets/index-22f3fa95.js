import{j as a,a as U,u as it,F as st}from"./@emotion-63839449.js";import{r as _}from"./react-4fd50329.js";import{B as Ne}from"./index-881eef42.js";import{a3 as ct,l as t,ed as xt,a8 as Be,ee as Rt,ef as Nt,I as fe,dq as kt,a5 as De,dP as Lt,bG as Ot,Y as Ut,a as dt,cP as Ge,c6 as se,bH as Mt,bI as Vt,cf as Bt,ej as z,ch as Yt,ci as qt,cj as Gt,ck as $t,cl as Ht,dk as zt,E as lt,s as ie,K as Ce,b0 as Kt,av as Xt,at as Wt,bv as Qt,ei as Jt,ek as Zt,eh as jt,cd as ot,b1 as ea}from"./index-c2ded735.js";import"./lodash-88fe09e6.js";import{h as f}from"./moment-a468e1f9.js";import"./file-saver-40cf32a9.js";import{E as ta,c as ut,S as aa,L as oa}from"./exportContract-a49a1d75.js";import"./react-redux-896b353b.js";import{u as ra}from"./useTableCheckbox-753d19b2.js";import{u as na}from"./useService-37d60dc0.js";import"./@firebase-43527ee1.js";import{c as ia,h as sa,f as mt,i as ca,a as da,u as la,g as pt,b as ua}from"./contract-2ad66738.js";import{u as ce,F as X}from"./index-687ba9e6.js";import{P as e}from"./prop-types-1172f4d5.js";import{P as gt,o as Ye,T as ft,a as Pe,n as Oe,l as k,D as be,p as Ie,q as Ee,k as ma,d as pa}from"./index-b17d22e5.js";import{B as Fe,D as ga,g as Re,w as rt,b as B,R as $e,S as fa,n as ha,P as ya}from"./antd-f9eae174.js";import{I as ht,S as K}from"./index-43183512.js";import{I as va}from"./index-0335a746.js";import{c as Ae}from"./convertDateToString-bb9b15fa.js";import{e as yt}from"./exportExcel-837be6ed.js";import{R as nt}from"./regex-deefadac.js";import{u as vt}from"./react-router-a4308f7b.js";import"./hoist-non-react-statics-23d96a9a.js";import"./react-is-e8e5dbb3.js";import"./@babel-b64fd0f9.js";import"./stylis-79144faa.js";import"./classnames-4ba1ba1a.js";import"./redux-10bbab4c.js";import"./react-router-dom-2a8f5f6d.js";import"./history-a1882333.js";import"./resolve-pathname-e210f2ac.js";import"./tiny-invariant-dd7d57d2.js";import"./react-dom-40621ea0.js";import"./scheduler-765c72db.js";import"./@redux-saga-8bafe09b.js";import"./redux-logger-e1c9ca90.js";import"./dompurify-8e338605.js";import"./query-string-f5cca1e7.js";import"./decode-uri-component-4138e85d.js";import"./split-on-first-4f1167c8.js";import"./filter-obj-2ed190f4.js";import"./oidc-client-7da0eaf7.js";import"./firebase-878887a2.js";import"./rc-pagination-c1e6a0ac.js";import"./rc-picker-2e3d5fe5.js";import"./rc-util-0bc219f3.js";import"./rc-trigger-570b13ec.js";import"./rc-motion-ae889c42.js";import"./rc-align-e5d7b12e.js";import"./dom-align-ecb06dd6.js";import"./resize-observer-polyfill-0f9f8adb.js";import"./rc-resize-observer-b9ad4e29.js";import"./@ant-design-cba9d434.js";import"./@ctrl-fb5a5473.js";import"./rc-tabs-dfd19a56.js";import"./rc-dropdown-5378dd0a.js";import"./rc-menu-b15ebfe9.js";import"./rc-overflow-6be96612.js";import"./rc-select-564caf01.js";import"./rc-virtual-list-8a7b82a6.js";import"./rc-collapse-11b7d3c4.js";import"./shallowequal-4542d6f7.js";import"./rc-drawer-317f0b4d.js";import"./@rc-component-5a112e55.js";import"./rc-field-form-ef5549aa.js";import"./async-validator-dee29e8b.js";import"./scroll-into-view-if-needed-6b992d05.js";import"./compute-scroll-into-view-183f845a.js";import"./rc-image-e0357917.js";import"./rc-dialog-b1d1f07b.js";import"./rc-input-number-8bc068f7.js";import"./rc-rate-c64cf0d5.js";import"./rc-steps-2d1924c7.js";import"./rc-switch-b4e96de7.js";import"./rc-table-191ecc42.js";import"./rc-checkbox-018e8052.js";import"./rc-tree-67773537.js";import"./rc-tree-select-cb7eccc3.js";import"./copy-to-clipboard-64585c8c.js";import"./toggle-selection-93f4ad84.js";import"./rc-textarea-d01adcbb.js";import"./rc-input-02c2c2ba.js";import"./rc-upload-3ab0f08a.js";import"./rc-notification-d13dc43b.js";import"./rc-progress-4f1a7096.js";import"./rc-tooltip-08fa4217.js";import"./use-sync-external-store-5d1b6592.js";import"./idb-cdd1a92f.js";import"./path-to-regexp-ef8d5544.js";import"./account-86ffff50.js";import"./libphonenumber-js-0d5a9c92.js";import"./react-infinite-scroll-component-e33646cb.js";import"./downloadFileFromUrl-79614833.js";import"./uuid-4a60fe23.js";import"./xlsx-0fb7ed70.js";const ke="ACTIVE",Le="INACTIVE",qe="DELETE",He=({onSelectAction:y,isDisabledActive:l,isDisabledInactive:p})=>a(Ne,{children:U(Re,{selectable:!1,onClick:y,children:[a(Re.Item,{disabled:l,children:t.activate},ke),a(Re.Item,{disabled:p,children:t.deactivate},Le),a(Re.Item,{children:t.delete},qe)]})});He.propTypes={onSelectAction:e.func,isDisabledActive:e.bool,isDisabledInactive:e.bool};He.defaultProps={onSelectAction:()=>{},isDisabledActive:!1,isDisabledInactive:!1};const ze=({idBuilding:y,service:l,filterObj:p,tableSelection:o,refreshContracts:v,selectAllRowComponent:r,showFormAddContract:S,showFormImportContract:u,showFormExportContract:A,servicePermissionWrite:h,servicePermissionExport:s})=>{const i=_.useMemo(()=>{const{registerDate:n,apartment:m,contractTemplateId:w,status:O,dayStartedUsing:d,dayStoppedUsing:q}=p,[he,ye]=n&&n.length?[f(n[0]).startOf("day").toDate(),f(n[1]).endOf("day").toDate()]:[void 0,void 0],de=d?f(d).toDate():void 0,le=q?f(q).toDate():void 0,te=l==null?void 0:l.id,ve=l==null?void 0:l.serviceType;return{serviceId:te,serviceType:ve,unitName:m,unitGroupId:y,contractTemplateId:w!==""?w:void 0,createFrom:he,createTo:ye,deActiveAt:le,from:de,status:O!==""?O:void 0}},[l,p]),[c,E]=_.useState({isFetching:!1,code:void 0,codeLanguage:void 0}),[C,I]=_.useState({isFetching:!1,code:void 0,codeLanguage:void 0}),[T,F]=_.useState({isFetching:!1,code:void 0,codeLanguage:void 0}),[b]=Ut(),M=ct();ce(c.code,c.codeLanguage,{message:t.success,description:t.activate_register_form_success},()=>{v()}),ce(C.code,C.codeLanguage,{message:t.success,description:t.deactivate_register_form_success},()=>{v()}),ce(T.code,T.codeLanguage,{message:t.success,description:t.delete_data_success},()=>{v()});const W=()=>{A()},ee=()=>{u()},Q=()=>{const{isSelectAllItem:n,selectedRowKeysCache:m,byId:w}=o,O=m.map(d=>w==null?void 0:w[d]).filter(d=>(d==null?void 0:d.typeRow)==="CONTRACT");Ye({isAll:n,totalItem:O.length,questionText:t.do_you_want_to_activate_register_form,onOk:async()=>{E({code:void 0,codeLanguage:void 0});try{const d=await ia({filter:i,idContracts:n?[]:O.map(q=>q.id),idBuilding:y,isAll:n});if(E({code:d.code}),d.code===200)return Promise.resolve()}catch(d){E({code:d.code,codeLanguage:d.codeLanguage})}return Promise.reject()},onCancel:()=>{E({code:void 0,codeLanguage:void 0})}})},H=()=>{const{isSelectAllItem:n,selectedRowKeysCache:m,byId:w}=o,O=m.map(d=>w==null?void 0:w[d]).filter(d=>(d==null?void 0:d.typeRow)==="CONTRACT");Ye({isAll:n,totalItem:O.length,questionText:t.do_you_want_to_deactivate_register_form,onOk:async()=>{I({code:void 0,codeLanguage:void 0});try{const d=await sa({filter:i,idContracts:n?[]:O.map(q=>q.id),idBuilding:y,isAll:n});if(I({code:d.code}),d.code===200)return Promise.resolve()}catch(d){I({code:d.code,codeLanguage:d.codeLanguage})}return Promise.reject()},onCancel:()=>{I({code:void 0,codeLanguage:void 0})}})},L=()=>{const{isSelectAllItem:n,selectedRowKeysCache:m,byId:w}=o,O=m.map(d=>w==null?void 0:w[d]).filter(d=>(d==null?void 0:d.typeRow)==="CONTRACT");Ye({isAll:n,totalItem:O.length,questionText:t.do_you_want_to_delete_register_form,onOk:async()=>{F({code:void 0,codeLanguage:void 0});try{const d=await mt({filter:i,idContracts:n?[]:O.map(q=>q.id),idBuilding:y,idService:l.id,isAll:n});if(F({code:d.code}),d.code===200)return Promise.resolve()}catch(d){F({code:d.code,codeLanguage:d.codeLanguage})}return Promise.reject()},onCancel:()=>{F({code:void 0,codeLanguage:void 0})}})},Z=({key:n})=>{n===ke?Q():n===Le?H():n===qe&&L()},R=()=>{S()},Y=()=>r({totalItemSelected:o.selectedRowKeysCache.map(n=>{var m;return(m=o.byId)==null?void 0:m[n]}).filter(n=>(n==null?void 0:n.typeRow)==="APARTMENT").length,textSelectRow:t.you_selected_rows,textSelectAllRow:t.select_all_rows}),j=!o.isSelectAllItem&&o.selectedRowKeysCache.length===0,N=[h?a(ga,{disabled:j,dropdownRender:()=>a(He,{onSelectAction:({key:n})=>{n===ke?M({action:xt,label:Be}):n===Le?M({action:Rt,label:Be}):n===qe&&M({action:Nt,label:Be}),Z({key:n})},isDisabledActive:p.status===ke,isDisabledInactive:p.status===Le}),children:U(Fe,{style:{marginRight:b.marginSm},loading:c.isFetching||C.isFetching||T.isFetching,disabled:c.isFetching||C.isFetching||T.isFetching,type:"primary",ghost:!0,children:[a("span",{children:t.action}),a(fe,{name:"icon-arrow-down-outlined"})]})},"action"):null,s?a(Fe,{style:{marginRight:b.marginSm},type:"primary",ghost:!0,onClick:()=>{M({action:kt,label:De}),W()},icon:a(fe,{name:"icon-download-outlined"}),children:t.export},"export"):null,h?a(Fe,{style:{marginRight:b.marginSm},type:"primary",icon:a(fe,{name:"icon-upload-outlined"}),onClick:()=>{M({action:Lt,label:De}),ee()},children:t.import},"import"):null,h?a(Fe,{type:"primary",icon:a(fe,{name:"icon-plus-circle-outlined"}),onClick:()=>{M({action:Ot,label:De}),R()},children:t.add},"add"):null].filter(Boolean);return a(gt.ActionBox,{actions:N,total:Y()})};ze.propTypes={idBuilding:e.oneOfType([e.number,e.string]),filterObj:e.objectOf(e.any),service:e.objectOf(e.any),tableSelection:e.objectOf(e.any),refreshContracts:e.func,selectAllRowComponent:e.func,showFormAddContract:e.func,showFormImportContract:e.func,showFormExportContract:e.func,servicePermissionExport:e.bool,servicePermissionWrite:e.bool};ze.defaultProps={idBuilding:0,filterObj:void 0,service:void 0,tableSelection:void 0,refreshContracts:()=>{},selectAllRowComponent:()=>{},showFormAddContract:()=>{},showFormImportContract:()=>{},showFormExportContract:()=>{},servicePermissionExport:!1,servicePermissionWrite:!1};const Ke=({loading:y,idBuilding:l,service:p,totalPayment:o,totalItem:v,tablePage:r,tablePageSize:S,selectedRowKeys:u,dataSource:A,reloadContracts:h,handleTablePageChange:s,onSelectRow:i,onSelectAllRowOfPage:c,showFormUpdateContract:E,showFormDetailContractTemplate:C,servicePermissionWrite:I})=>{const{layoutScrollRef:T}=_.useContext(dt),F=it(),b=ct(),[M,W]=_.useState({code:void 0,codeLanguage:void 0});ce(M.code,M.codeLanguage,{message:t.success,description:t.delete_data_success},()=>{h()});const ee=(N,n)=>{s(N,n)},Q=N=>{C({contractTemplate:N})},H=(N,n)=>{E({contract:N,apartment:n})},L=N=>{Pe.confirm({cancelText:t.cancel,okText:t.confirm,title:t.confirm,content:`${t.do_you_want_to_delete_this_register_form}?`,onOk:async()=>{W({code:void 0,codeLanguage:void 0});try{const n=await mt({idBuilding:l,idContracts:[N.id],idService:p.id,isAll:!1});if(W({code:n.code}),n.code===200)return Promise.resolve()}catch(n){W({code:n.code,codeLanguage:n.codeLanguage})}return Promise.reject()},afterClose:()=>{W({code:void 0,codeLanguage:void 0})}})},Z=_.useMemo(()=>{var N;return[{title:t.unit,key:"apartment",fixed:"left",width:150,children:[{title:t.total,key:"apartment",dataIndex:"apartment",fixed:"left",width:150}]},{title:t.tariff,key:"contractTemplate",width:250,children:[{title:"",key:"contractTemplate",dataIndex:"contractTemplate",width:250,ellipsis:!0,render:(n,m)=>n?a(Fe,{type:"link",style:{padding:0},onClick:()=>{var w;return Q((w=m==null?void 0:m.contract)==null?void 0:w.contractTemplate)},children:n}):""}]},{title:t.status1,key:"status",width:150,children:[{title:"",key:"status",dataIndex:"status",width:150,render:(n,m)=>n&&(m.status===Ge?a(rt,{color:"success",children:t.active}):a(rt,{color:"error",children:t.inactive}))||""}]},{title:t.paid_until_at,key:"paidUntilAt",width:150,children:[{title:"",key:"paidUntilAt",dataIndex:"paidUntilAt",width:150}]},{title:t.register_date,key:"registerDate",width:150,children:[{title:"",key:"registerDate",dataIndex:"registerDate",width:150}]},{title:t.day_of_using,key:"dayOfUsing",width:200,children:[{title:"",key:"dayOfUsing",dataIndex:"dayOfUsing",width:200}]},...((N=p==null?void 0:p.requiredInfo)==null?void 0:N.map(n=>({title:n.name,key:n.key,width:150,children:[{title:"",key:n.key,dataIndex:n.key,width:150}]})))??[],{title:t.amount,key:"amount",width:100,align:"right",fixed:"right",children:[{title:se(o.totalNumberUse),key:"amount",dataIndex:"amount",width:100,align:"right",fixed:"right"}]},{title:t.total_payment,key:"totalPayment",align:"right",fixed:"right",width:150,children:[{title:se(Math.round(o.totalPayment)),key:"totalPayment",dataIndex:"totalPayment",align:"right",fixed:"right",width:150}]},I?{title:t.actions,key:"actions",dataIndex:"actions",align:"center",fixed:"right",width:100,render:(n,m)=>m.contract?U(st,{children:[a(fe,{title:t.update,style:{marginRight:F.margin.xs,fontSize:F.iconSize},name:"icon-edit-outlined",onClick:()=>{b({action:Mt,label:De}),H(m==null?void 0:m.contract,{name:m==null?void 0:m.apartmentName,id:m==null?void 0:m.apartmentId})}}),a(fe,{title:t.delete,style:{fontSize:F.iconSize},name:"icon-minus-circle-outlined",onClick:()=>{b({action:Vt,label:De}),L(m==null?void 0:m.contract,m==null?void 0:m.apartmentId)}})]}):null}:null].filter(Boolean)},[p,o]),R={pageSize:S,defaultCurrent:1,current:r,total:v,showQuickJumper:!0,showSizeChanger:!0,hideOnSinglePage:!0,onChange:ee},Y={x:Z.reduce((N,n)=>N+ +n.width,0)},j={selectedRowKeys:u,onSelect:i,onSelectAll:c,fixed:!0};return a(ft,{loading:y,columns:Z,dataSource:A,pagination:R,scroll:Y,sticky:{offsetScroll:F.offsetScrollX,getContainer:()=>T.current},rowSelection:j,bordered:!0,expandable:{defaultExpandAllRows:!0}})};Ke.propTypes={loading:e.bool,idBuilding:e.oneOfType([e.number,e.string]),service:e.objectOf(e.any),totalPayment:e.objectOf(e.any),totalItem:e.number,tablePage:e.number,tablePageSize:e.number,selectedRowKeys:e.arrayOf(e.any),dataSource:e.arrayOf(e.any),reloadContracts:e.func,handleTablePageChange:e.func,onSelectRow:e.func,onSelectAllRowOfPage:e.func,showFormUpdateContract:e.func,showFormDetailContractTemplate:e.func,servicePermissionWrite:e.bool};Ke.defaultProps={loading:!1,idBuilding:0,service:void 0,totalPayment:void 0,totalItem:0,tablePage:0,tablePageSize:0,selectedRowKeys:[],dataSource:[],reloadContracts:()=>{},handleTablePageChange:()=>{},onSelectRow:()=>{},onSelectAllRowOfPage:()=>{},showFormUpdateContract:()=>{},showFormDetailContractTemplate:()=>{},servicePermissionWrite:!1};const Xe=({handleFilterChange:y,contractTemplates:l,formFilter:p})=>{const o=r=>{y({...r})},v=_.useMemo(()=>[{label:t.unit,key:"apartment",component:a(ht,{placeholder:t.unit}),visible:!0},{label:t.tariff,key:"contractTemplateId",component:U(K,{fluid:"true",placeholder:t.tariff,getPopupContainer:r=>r.parentNode,showSearch:!0,optionFilterProp:"children",filterOption:(r,S)=>Oe(S.children).indexOf(Oe(r))>=0,children:[a(K.Option,{value:"",children:t.all_tariff},"tariff_0"),l.map(r=>a(K.Option,{value:r.value,children:r.name},r.id))]}),visible:!0},{label:t.register_date,key:"registerDate",component:a(be.RangePicker,{fluid:"true",format:[k,k],placeholder:[k,k],getPopupContainer:r=>r.parentNode}),visible:!0},{label:t.day_started_using,key:"dayStartedUsing",component:a(be,{fluid:"true",format:k,placeholder:k,getPopupContainer:r=>r.parentNode}),visible:!0},{label:t.day_stopped_using,key:"dayStoppedUsing",component:a(be,{fluid:"true",format:k,placeholder:k,getPopupContainer:r=>r.parentNode}),visible:!0},{label:t.status1,key:"status",component:U(K,{fluid:"true",getPopupContainer:r=>r.parentNode,children:[a(K.Option,{value:"",children:t.all_status}),a(K.Option,{value:Ge,children:t.active}),a(K.Option,{value:Bt,children:t.inactive})]}),visible:!0}],[l]);return a(gt.FilterBox,{formData:p,defaultFilter:{...z},onSearch:o,layout:"vertical",filters:v})};Xe.propTypes={handleFilterChange:e.func,contractTemplates:e.arrayOf(e.any),formFilter:e.objectOf(e.any)};Xe.defaultProps={handleFilterChange:()=>{},contractTemplates:[],formFilter:void 0};const We=y=>{const{idBuilding:l,onHide:p,refreshContracts:o,service:v,contractTemplates:r}=y,S=[{name:"#",rules:{type:"number",required:!0}},{name:"Căn hộ",rules:{type:"string",required:!0,max:255}},{name:"Biểu phí",rules:r&&r.length?{required:!0,type:"enum",enum:r.map(({name:i})=>i)}:{type:"string",required:!0,max:255}},{name:"Ngày đăng ký",rules:{type:"string",validator(i,c,E,C,I){if(c==null||c==="")return new Error(t.status.data_require);const T=new RegExp(nt);return c&&!T.test(c)?new Error(`${t.status.date_invalid} (${t.label.valid}: DD/MM/YYYY)`):c&&C["Ngày bắt đầu sử dụng"]&&f(c,"DD/MM/YYYY").isAfter(f(C["Ngày bắt đầu sử dụng"],"DD/MM/YYYY"))?new Error(t.register_date_must_lower_or_equal_than_day_started_using):!0}}},{name:"Ngày bắt đầu sử dụng",rules:{type:"string",validator(i,c,E,C,I){if(c==null||c==="")return new Error(t.status.data_require);const T=new RegExp(nt);return c&&!T.test(c)?new Error(`${t.status.date_invalid} (${t.label.valid}: DD/MM/YYYY)`):c&&C["Ngày đăng ký"]&&f(c,"DD/MM/YYYY").isBefore(f(C["Ngày đăng ký"],"DD/MM/YYYY"))?new Error(t.register_date_must_lower_or_equal_than_day_started_using):!0}}},{name:"Trạng thái sử dụng",rules:{required:!0,type:"enum",enum:["Đang hoạt động","Ngừng hoạt động"]}},{name:"Số lượng",rules:{type:"number",required:!0,max:Number.MAX_SAFE_INTEGER}},...v.requiredInfo.map(i=>({name:i.name,rules:{type:"string",max:255}}))],[u,A]=_.useState({isFetching:!1,code:void 0,codeLanguage:void 0,success:0,failed:0,errors:[],data:void 0});ce(u.code,u.codeLanguage,{message:t.success,description:t.import_data_success},()=>{o()});const h=async i=>{var c,E,C,I;A({isFetching:!0,code:void 0,codeLanguage:void 0,success:0,failed:0,errors:[],data:void 0});try{const T=await ca({idBuilding:l,file:i,dataAttach:{createdFor:f().format("YYYYMM")}}),F=((E=(c=T==null?void 0:T.data)==null?void 0:c.errors)==null?void 0:E.map(b=>({index:b==null?void 0:b.index,code:(b==null?void 0:b.code)??500,message:b.message})))??[];A({isFetching:!1,code:T.code,codeLanguage:T.codeLanguage,success:((C=T==null?void 0:T.data)==null?void 0:C.success)??0,failed:F.length,errors:F,data:((I=T==null?void 0:T.data)==null?void 0:I.data)??void 0})}catch(T){A({isFetching:!1,code:T.code,codeLanguage:T.codeLanguage,success:0,failed:0,errors:[],data:void 0})}};function s(){const i=["#","Căn hộ","Biểu phí","Ngày đăng ký","Ngày bắt đầu sử dụng","Trạng thái sử dụng","Số lượng",...v.requiredInfo.map(F=>F.name)],c=r.length>0?r[0].name:"",E=v.requiredInfo.map(F=>F.type==="DATE"?Ae(new Date):F.type==="TEXT"?F.name:F.type==="NUMBER"?0:""),C=[1,101,c,Ae(new Date),Ae(new Date),"Đang hoạt động",1,...E],I=[2,102,c,Ae(new Date),Ae(new Date),"Ngừng hoạt động",1,...E];yt([i,C,I],"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8","mau-thong-tin-dich-vu-dang-ky",".xlsx")}return a(va,{headers:S,onClose:p,onOk:h,visible:!0,code:u.code,codeLanguage:u.codeLanguage,loading:u.isFetching,numberSuccess:u.success,numberFail:u.failed,problemResponseServerDataSource:u.errors,errorFile:u.data,onDownloadTemplateFile:s})};We.propTypes={idBuilding:e.oneOfType([e.number,e.string]),onHide:e.func,refreshContracts:e.func,service:e.objectOf(e.any),contractTemplates:e.arrayOf(e.any)};We.defaultProps={idBuilding:0,onHide:()=>{},refreshContracts:()=>{},service:void 0,contractTemplates:[]};const Qe=({contractTemplate:y,hideModal:l})=>{const p=it(),{formula:o,surcharges:v,promotions:r}=y,S=[],u=[],A=[];if(o){const{formulaType:h,formula:s}=o;if(h===Yt)S.push({key:"numberUse",formula:s.name||t.formula,price:se(s.price)});else if(h===qt)for(let i=0;i<s.length;i+=1)S.push({key:i,formula:`${s[i].from}${s[i].to?` - ${s[i].to}`:""}`,price:se(s[i].price)});else if(h===Gt)for(let i=0;i<s.length;i+=1)S.push({key:i,formula:s[i].name,price:se(s[i].price)})}if(v&&v.length)for(let h=0;h<v.length;h+=1)u.push({key:h,formula:v[h].name,price:`${v[h].price} ${v[h].type===$t?"(%)":""}`});return r&&r.length&&A.push({key:"promotions",formula:r[0].name,price:`${r[0].price} (%)`}),a(Pe,{title:t.detail_tariff,footer:!1,onCancel:l,open:!0,children:U($e,{gutter:[p.margin.sm,p.margin.sm],children:[U(B,{span:"12",children:[a(Ie,{children:t.tariff}),a(Ee,{children:y.name||"-"})]}),U(B,{span:"12",children:[a(Ie,{children:t.english_name}),a(Ee,{children:y.enName||"-"})]}),U(B,{span:"12",children:[a(Ie,{children:t.deferred_interest}),a(Ee,{children:y.deferredInterest||"-"})]}),U(B,{span:"12",children:[a(Ie,{children:t.pay_time}),a(Ee,{children:y.payTime||"-"})]}),o&&U(B,{span:"24",children:[a(Ie,{children:t.formula}),U(Ee,{children:[o.name," - ",Ht[o.formulaType].label]}),a(ft,{bordered:!0,size:"small",pagination:!1,columns:[{title:t.formula,key:"formula",dataIndex:"formula"},{title:t.price,key:"price",dataIndex:"price"}],dataSource:S})]})||null]})})};Qe.propTypes={hideModal:e.func,contractTemplate:e.objectOf(e.any)};Qe.defaultProps={hideModal:()=>{},contractTemplate:{}};const Ue=({contractTemplates:y,requiredInfo:l,idBuilding:p,apartment:o,apartments:v})=>{const[r,S]=_.useState({isFetching:!1}),[u,A]=_.useState([v]),h=async(s,i)=>{i||A([]),S({isFetching:!0});const c=await zt({idBuilding:p,page:1,limit:50,filter:{name:s||void 0}});A((c==null?void 0:c.data)??[]),S({isFetching:!1})};return _.useEffect(()=>{o&&A([{...o}])},[o]),_.useEffect(()=>{(async()=>await h(o==null?void 0:o.name,!0))()},[]),U($e,{gutter:[16,0],children:[a(B,{span:"12",children:a(X.Item,{rules:[{required:!0}],name:"contractTemplate",label:t.tariff,children:a(K,{fluid:!0,placeholder:t.tariff,getPopupContainer:s=>s.parentNode,showSearch:!0,optionFilterProp:"children",filterOption:(s,i)=>Oe(i.children).indexOf(Oe(s))>=0,children:y.map(s=>a(K.Option,{value:s.id,children:s.name},s.id))})})}),a(B,{span:"12",children:a(X.Item,{rules:[{required:!0}],name:"totalNumberUse",label:t.amount,children:a(ma,{min:"0",placeholder:t.amount})})}),a(B,{span:"24",children:a(X.Item,{rules:[{required:!0}],name:"apartment",label:t.unit,children:a(K,{showSearch:!0,filterOption:!1,onSearch:pa(h),loading:r.isFetching,fluid:!0,placeholder:t.unit,notFoundContent:r.isFetching?a(fa,{size:"small"}):null,children:u.map((s,i)=>a(K.Option,{value:s.id,children:s.name},i))})})}),a(B,{span:"12",children:a(X.Item,{dependencies:["dayStartedUsing"],rules:[{required:!0},({getFieldValue:s})=>({validator(i,c){return c&&s("dayStartedUsing")&&f(c).isAfter(s("dayStartedUsing"))?Promise.reject(t.register_date_must_lower_or_equal_than_day_started_using):Promise.resolve()}})],name:"registerDate",label:t.register_date,children:a(be,{fluid:!0,format:k,placeholder:k})})}),a(B,{span:"12",children:a(X.Item,{dependencies:["registerDate"],rules:[{required:!0},({getFieldValue:s})=>({validator(i,c){return c&&s("registerDate")&&f(c).isBefore(s("registerDate"))?Promise.reject(t.register_date_must_lower_or_equal_than_day_started_using):Promise.resolve()}})],name:"dayStartedUsing",label:t.day_started_using,children:a(be,{fluid:!0,format:k,placeholder:k})})}),l.map((s,i)=>a(B,{span:"12",children:a(X.Item,{name:s.key,label:s.name,children:a(ht,{placeholder:s.name})})},i))]})};Ue.propTypes={apartment:e.objectOf(e.any),contractTemplates:e.arrayOf(e.any),requiredInfo:e.arrayOf(e.any),idBuilding:e.oneOfType([e.number,e.string]),apartments:e.arrayOf(e.any)};Ue.defaultProps={apartment:void 0,contractTemplates:[],requiredInfo:[],idBuilding:0,apartments:[]};const Je=({idBuilding:y,contractTemplates:l,requiredInfo:p,refreshContracts:o,onHide:v})=>{const[r]=X.useForm(),[S,u]=_.useState({isFetching:!1,code:void 0,codeLanguage:void 0});ce(S.code,S.codeLanguage,{message:t.success,description:t.add_data_success},()=>{o(),v()});const A=async()=>{if(r.setFieldsValue({...lt(r.getFieldsValue(),{})}),await r.validateFields()){u({isFetching:!0,code:void 0,codeLanguage:void 0});const i=f(r.getFieldValue("registerDate")).startOf("day").toDate(),c=f(r.getFieldValue("dayStartedUsing")).startOf("day").toDate(),E=f(i).format("YYYYMM"),C={contractTemplateId:r.getFieldValue("contractTemplate"),createdAt:i,createdFor:Number(E),numberPersonQuota:1,requiredInfo:p.map(I=>({...I,value:r.getFieldValue(I.key)})),startDate:c,totalNumberUse:Number(r.getFieldValue("totalNumberUse")),unitId:r.getFieldValue("apartment"),contractTemplate:r.getFieldValue("contractTemplate")};try{const I=await da({idBuilding:y,contracts:[C]});u({isFetching:!1,code:I.code})}catch(I){throw u({isFetching:!1,code:I.code,codeLanguage:I.codeLanguage}),I}}},h=()=>{v()};return a(Pe,{confirmLoading:S.isFetching,okButtonProps:{disabled:S.isFetching},okText:t.confirm,cancelText:t.cancel,onOk:A,onCancel:h,open:!0,title:t.add_register_form,children:a(X,{initialValues:{contractTemplate:void 0,apartment:void 0},layout:"vertical",name:"formAdd",form:r,children:a(Ue,{apartments:[],idBuilding:y,contractTemplates:l,requiredInfo:p})})})};Je.propTypes={idBuilding:e.oneOfType([e.number,e.string]),contractTemplates:e.arrayOf(e.any),requiredInfo:e.arrayOf(e.any),refreshContracts:e.func,onHide:e.func};Je.defaultProps={idBuilding:0,contractTemplates:[],requiredInfo:[],refreshContracts:()=>{},onHide:()=>{}};const Ze=({idBuilding:y,apartment:l,contract:p,contractTemplates:o,requiredInfo:v,refreshContracts:r,onHide:S})=>{var c;const[u]=X.useForm(),[A,h]=_.useState({isFetching:!1,code:void 0,codeLanguage:void 0});ce(A.code,A.codeLanguage,{message:t.success,description:t.update_data_success},()=>{r(),S()});const s=async()=>{if(u.setFieldsValue({...lt(u.getFieldsValue(),{})}),await u.validateFields()){h({isFetching:!0,code:void 0,codeLanguage:void 0});const C=f(u.getFieldValue("registerDate")).startOf("day").toDate(),I=f(u.getFieldValue("dayStartedUsing")).startOf("day").toDate(),T=f(C).format("YYYYMM"),F={contractTemplateId:u.getFieldValue("contractTemplate"),createdAt:C,createdFor:Number(T),numberPersonQuota:1,requiredInfo:v.map(b=>({...b,value:u.getFieldValue(b.key)})),startDate:I,totalNumberUse:Number(u.getFieldValue("totalNumberUse")),unitId:u.getFieldValue("apartment"),contractTemplate:u.getFieldValue("contractTemplate")};try{const b=await la({idBuilding:y,idContract:p.id,contract:F});h({isFetching:!1,code:b.code})}catch(b){throw h({isFetching:!1,code:b.code,codeLanguage:b.codeLanguage}),b}}},i=()=>{S()};return a(Pe,{confirmLoading:A.isFetching,okButtonProps:{disabled:A.isFetching},okText:t.confirm,cancelText:t.cancel,onOk:s,onCancel:i,open:!0,title:t.update_register_form,children:a(X,{initialValues:{contractTemplate:p.contractTemplateId,registerDate:f(p.createdAt),numberPersonQuota:p.totalNumberUse,...(c=p==null?void 0:p.requiredInfo)==null?void 0:c.reduce((E,C)=>(E[C.key]=C.value,E),{}),dayStartedUsing:f(p.startDate),totalNumberUse:p.totalNumberUse,apartment:l==null?void 0:l.id},layout:"vertical",name:"formUpdate",form:u,children:a(Ue,{apartments:[{id:l==null?void 0:l.id,name:l==null?void 0:l.name}],idBuilding:y,contractTemplates:o,requiredInfo:v,apartment:l})})})};Ze.propTypes={idBuilding:e.oneOfType([e.number,e.string]),apartment:e.objectOf(e.any),contract:e.objectOf(e.any),contractTemplates:e.arrayOf(e.any),requiredInfo:e.arrayOf(e.any),refreshContracts:e.func,onHide:e.func};Ze.defaultProps={idBuilding:0,apartment:void 0,contract:void 0,contractTemplates:[],requiredInfo:[],refreshContracts:()=>{},onHide:()=>{}};const Ta=({hideModalExportData:y,filter:l,serviceActive:p,totalItem:o})=>{const{requiredInfo:v=[],id:r,serviceType:S,name:u}=p,{idBuilding:A}=vt(),[h,s]=_.useState(0);return _.useEffect(()=>{(async()=>{var R;const{registerDate:i,dayStartedUsing:c,dayStoppedUsing:E,apartment:C,contractTemplateId:I,registrationPlate:T,status:F}=l,[b,M]=i!=null&&i.length?[f(i[0]).startOf("day").toDate(),f(i[1]).endOf("day").toDate()]:[void 0,void 0],W=c?f(c).toDate():void 0,ee=E?f(E).toDate():void 0,Q=[];let H=1,L=0;const Z=Math.ceil(o/ie);for(ta({idBuilding:A,filter:{serviceId:r,serviceType:S,...l,onlyLogging:!0,serviceName:u}});H<=Z;){s(Math.ceil(H/Z*100));const Y=await pt({idBuilding:A,filter:{serviceId:r,serviceType:S,unitName:C,unitGroupId:A,contractTemplateId:I!==""?I:void 0,createFrom:b,createTo:M,deActiveAt:ee,from:W,registrationPlate:T,status:F!==""?F:void 0},page:H,limit:ie});if(Y.data.length>0){for(let j=0;j<Y.data.length;j+=1){const N=Y.data[j];for(let n=0;n<N.contracts.length;n+=1){const m=N.contracts[n],{contractTemplate:w,totalNumberUse:O,status:d,paidUntilAt:q,createdAt:he,startDate:ye,deActiveAt:de}=m,{formula:le}=w,te=ut({formula:le.formula,formulaType:le.formulaType,norm:1,ratio:1,totalNumberUse:O});m.totalPayment=Math.round(te);const ve=[L+=1,N.name,w.name,f(he).format(k),f(ye).format(k),de?f(de).format(k):"",d===Ge?"Đang hoạt động":"Ngừng hoạt động",O,Math.round(te),q||"",...(R=m==null?void 0:m.requiredInfo)==null?void 0:R.map(Te=>(Te==null?void 0:Te.value)??"")];Q.push(ve)}}H+=1}else H=0}Q.unshift(["#","Căn hộ","Biểu phí","Ngày đăng ký","Ngày bắt đầu sử dụng","Ngày ngưng sử dụng","Trạng thái sử dụng","Số lượng","Thành tiền","Đã thanh toán đến",...v.map(Y=>Y.name)]),setTimeout(()=>{yt(Q,"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8","thong-tin-dich-vu-dang-ky",".xlsx"),ha.success({description:t.success,message:t.export_data_success}),y()},3e3)})()},[]),[h]},je=({hideModalExportData:y,filter:l,serviceActive:p,totalItem:o})=>{const[v]=Ta({hideModalExportData:y,filter:l,serviceActive:p,totalItem:o});return a(Pe,{open:!0,closable:!1,footer:!1,children:a(ya,{strokeColor:{from:"#108ee9",to:"#87d068"},percent:v,status:"active",css:r=>({marginTop:r.margin.xs})})})};je.propTypes={hideModalExportData:e.func,filter:e.objectOf(e.any),serviceActive:e.objectOf(e.any),totalItem:e.number};je.defaultProps={hideModalExportData:()=>{},filter:void 0,serviceActive:void 0,totalItem:0};const dr=()=>{const{setVisibleSearchBox:y,setTitlePage:l,setVisibleFilterBox:p}=_.useContext(dt),[o,v]=_.useState(),[r,S]=_.useState({...z}),[u,A]=_.useState(1),[h,s]=_.useState(ie),[i,c]=_.useState([]),[E,C]=_.useState([]),[I,T]=_.useState([]),[F,b]=_.useState([]),[M,W]=_.useState([]),[ee,Q]=_.useState(!1),[H,L]=_.useState(!1),Z=vt(),{idBuilding:R}=Z,{getServiceRegisterInUses:Y}=na(),[j,N,n]=Ce(),[m,w,O]=Ce(),[d,q,he]=Ce(),[ye,de,le]=Ce(),[te,ve,Te]=Ce(),[Me]=X.useForm(),{getPermissionByModuleCode:Tt}=Kt(),ue=Tt(Xt),et=(ue==null?void 0:ue[Wt])??!1,St=(ue==null?void 0:ue[Qt])??!1,tt=_.useMemo(()=>I.map(D=>{var $;let P=0,G=0;const V=[];for(let x=0;x<D.contracts.length;x+=1){const g=D.contracts[x],{contractTemplate:J,totalNumberUse:ae}=g,{formula:oe}=J,_e=ut({formula:oe.formula,formulaType:oe.formulaType,norm:1,ratio:1,totalNumberUse:ae});g.totalPayment=Math.round(_e),(!r.status||r.status===g.status)&&(P+=+g.totalNumberUse,G+=Number(g.totalPayment)),V.push({typeRow:"CONTRACT",id:g.id,key:`${D.id} - ${g.id}`,apartment:"",contractTemplate:g.contractTemplate.name,registrationPlate:g.registrationPlate,status:g.status,amount:g.totalNumberUse,totalPayment:se(g.totalPayment),paidUntilAt:g.paidUntilAt,registerDate:f(g.createdAt).format(k),dayOfUsing:`${f(g.startDate).format(k)}${g.deActiveAt?` - ${f(g.deActiveAt).format(k)}`:""}`,...(($=g==null?void 0:g.requiredInfo)==null?void 0:$.reduce((re,pe)=>(re[pe.key]=pe.value,re),{}))??{},contract:g,apartmentId:D.id,apartmentName:D.name})}return{typeRow:"APARTMENT",id:D.id,key:D.id,apartment:D.name,amount:P,totalPayment:se(G),children:V}}),[I]),[at,we,_t,Ct,It]=ra({dataRows:tt,rowKey:"key",totalRows:F}),{selectedRowKeys:Et}=at,Se=async D=>{const{registerDate:P,serviceId:G,serviceType:V,apartment:$,contractTemplateId:x,registrationPlate:g,status:J,dayStartedUsing:ae,dayStoppedUsing:oe}=D,[_e,re]=P&&P.length?[f(P[0]).startOf("day").toDate(),f(P[1]).endOf("day").toDate()]:[void 0,void 0],pe=ae?f(ae).toDate():void 0,Ve=oe?f(oe).toDate():void 0,ge=await ua({idBuilding:R,filter:{serviceId:G,serviceType:V,unitName:$,unitGroupId:R,contractTemplateId:x!==""?x:void 0,createFrom:_e,createTo:re,deActiveAt:Ve,from:pe,registrationPlate:g,status:J!==""?J:void 0}});return W(ge==null?void 0:ge.data),ge},me=async(D,P,G)=>{const{registerDate:V,dayStartedUsing:$,dayStoppedUsing:x,serviceId:g,serviceType:J,apartment:ae,contractTemplateId:oe,registrationPlate:_e,status:re}=D,[pe,Ve]=V&&V.length?[f(V[0]).startOf("day").toDate(),f(V[1]).endOf("day").toDate()]:[void 0,void 0],ge=$?f($).toDate():void 0,wt=x?f(x).toDate():void 0,ne=await pt({idBuilding:R,filter:{serviceId:g,serviceType:J,unitName:ae,unitGroupId:R,contractTemplateId:oe!==""?oe:void 0,createFrom:pe,createTo:Ve,deActiveAt:wt,from:ge,registrationPlate:_e,status:re!==""?re:void 0},page:P,limit:G});return T((ne==null?void 0:ne.data)??[]),b((ne==null?void 0:ne.totalRecord)??[]),ne},At=async()=>{Q(!0);const D=await Y({idBuilding:R,filter:{serviceType:Jt}}),P=await Y({idBuilding:R,filter:{serviceType:Zt}}),G=(D==null?void 0:D.data)??[],V=(P==null?void 0:P.data)??[],$=G.concat(V).filter(x=>(x==null?void 0:x.systemCode)!==jt).sort((x,g)=>g.name.localeCompare(x.name));if(c($),$.length>0){const x=$[0].id,g=$.find(ae=>ae.id===x);v(g),S({...z,serviceId:x,serviceType:g==null?void 0:g.serviceType});const J=await ot({idBuilding:R,filter:{serviceId:x}});C(J==null?void 0:J.data),await me({...z,serviceId:x,serviceType:g==null?void 0:g.serviceType},u,h),await Se({...z,serviceId:x,serviceType:g==null?void 0:g.serviceType})}Q(!1)};_.useEffect(()=>(y(!0),l(`${t.service} ${t.register.toLowerCase()}`),At(),()=>{y(!1),p(!1),l("")}),[]);const Ft=async D=>{if(D!==o.key){L(!0);const P=i.find(V=>V.id===D);v(P),S({...z}),A(1),s(ie),await me({...z,serviceId:P.id,serviceType:P.serviceType},1,ie),await Se({...z,serviceId:P.id,serviceType:P.serviceType});const G=await ot({idBuilding:R,filter:{serviceId:D}});C(G==null?void 0:G.data),Me.resetFields(),we(),L(!1)}},Dt=async D=>{L(!0),S({...D}),await me({...D,serviceId:o.id,serviceType:o.serviceType},u,h),await Se({...D,serviceId:o.id,serviceType:o.serviceType}),we(),L(!1)},bt=async(D,P)=>{L(!0),D!==u&&A(D),P!==h&&s(P),await me({...r,serviceId:o.id,serviceType:o.serviceType},D,P),L(!1)},xe=async()=>{L(!0),S({...z}),A(1),s(ie),await me({...z,serviceId:o.id,serviceType:o.serviceType},1,ie),await Se({...z,serviceId:o.id,serviceType:o.serviceType}),we(),Me.resetFields(),L(!1)},Pt=async()=>{L(!0),await me({...r,serviceId:o.id,serviceType:o.serviceType},u,h),await Se({...r,serviceId:o.id,serviceType:o.serviceType}),we(),L(!1)};return ee?a(ea,{isLoading:ee}):U($e,{style:{flex:1,height:"100%"},gutter:[0,0],children:[a(B,{style:{flex:1},span:"3",children:i&&i.length?a(aa,{services:i,menuActiveKey:o==null?void 0:o.id,handleSelectService:Ft}):null}),a(B,{style:{flex:1,display:"flex",flexDirection:"column"},span:"21",children:o?a("div",{style:{flex:1,height:"100%",position:"relative"},children:E.length===0?a(oa,{}):U(st,{children:[a(Xe,{formFilter:Me,contractTemplates:E,handleFilterChange:Dt}),U(Ne,{style:{flex:1},children:[a(Ne.Header,{children:a(ze,{idBuilding:R,service:o,filterObj:r,tableSelection:at,refreshContracts:xe,selectAllRowComponent:It,showFormAddContract:de,showFormImportContract:N,showFormExportContract:w,servicePermissionWrite:et,servicePermissionExport:St})}),a(Ne.Content,{fluid:!0,children:a(Ke,{loading:H,idBuilding:R,service:o,totalPayment:M,totalItem:F,tablePage:u,tablePageSize:h,selectedRowKeys:Et,dataSource:tt,reloadContracts:Pt,handleTablePageChange:bt,onSelectRow:_t,onSelectAllRowOfPage:Ct,showFormUpdateContract:ve,showFormDetailContractTemplate:q,servicePermissionWrite:et})})]}),ye.isShow&&a(Je,{idBuilding:R,contractTemplates:E,requiredInfo:o.requiredInfo,refreshContracts:xe,onHide:le}),te.isShow&&a(Ze,{idBuilding:R,apartment:te.data.apartment,contract:te.data.contract,contractTemplates:E,requiredInfo:o.requiredInfo,refreshContracts:xe,onHide:Te}),j.isShow&&a(We,{contractTemplates:E,idBuilding:R,onHide:n,refreshContracts:xe,service:o}),d.isShow&&a(Qe,{contractTemplate:d.data.contractTemplate,hideModal:he}),m.isShow?a(je,{hideModalExportData:O,filter:r,serviceActive:o,totalItem:F}):null]})}):null})]})};export{dr as default};
