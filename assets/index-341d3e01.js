import{j as u,a as V,u as J}from"./@emotion-63839449.js";import{r as g}from"./react-4fd50329.js";import{j as Q,D as W,P as K}from"./index-b17d22e5.js";import{l as n,a9 as x,s as E,b0 as Z,aI as ee,bv as te,i as S,e4 as ae,M as L,X as k,A as H,j as oe,a3 as re,I as ie,dq as ne,a5 as se,a as z}from"./index-c2ded735.js";import{k as de,g as j}from"./lodash-88fe09e6.js";import{h as v}from"./moment-a468e1f9.js";import"./file-saver-40cf32a9.js";import{P as ce}from"./prop-types-1172f4d5.js";import"./react-redux-896b353b.js";import{u as le}from"./useService-37d60dc0.js";import"./@firebase-43527ee1.js";import{F as pe,u as me}from"./index-687ba9e6.js";import{u as ue}from"./react-router-a4308f7b.js";import{I as ge,S as P}from"./index-43183512.js";import{d as fe}from"./downloadFileFromUrl-79614833.js";import{B as Te,a as _}from"./antd-f9eae174.js";import{c as he}from"./convertPeriodTimeToMonths-e9a83362.js";import"./hoist-non-react-statics-23d96a9a.js";import"./react-is-e8e5dbb3.js";import"./@babel-b64fd0f9.js";import"./stylis-79144faa.js";import"./classnames-4ba1ba1a.js";import"./react-router-dom-2a8f5f6d.js";import"./history-a1882333.js";import"./resolve-pathname-e210f2ac.js";import"./tiny-invariant-dd7d57d2.js";import"./account-86ffff50.js";import"./index-881eef42.js";import"./libphonenumber-js-0d5a9c92.js";import"./react-infinite-scroll-component-e33646cb.js";import"./redux-10bbab4c.js";import"./react-dom-40621ea0.js";import"./scheduler-765c72db.js";import"./@redux-saga-8bafe09b.js";import"./redux-logger-e1c9ca90.js";import"./dompurify-8e338605.js";import"./query-string-f5cca1e7.js";import"./decode-uri-component-4138e85d.js";import"./split-on-first-4f1167c8.js";import"./filter-obj-2ed190f4.js";import"./oidc-client-7da0eaf7.js";import"./firebase-878887a2.js";import"./rc-pagination-c1e6a0ac.js";import"./rc-picker-2e3d5fe5.js";import"./rc-util-0bc219f3.js";import"./rc-trigger-570b13ec.js";import"./rc-motion-ae889c42.js";import"./rc-align-e5d7b12e.js";import"./dom-align-ecb06dd6.js";import"./resize-observer-polyfill-0f9f8adb.js";import"./rc-resize-observer-b9ad4e29.js";import"./@ant-design-cba9d434.js";import"./@ctrl-fb5a5473.js";import"./rc-tabs-dfd19a56.js";import"./rc-dropdown-5378dd0a.js";import"./rc-menu-b15ebfe9.js";import"./rc-overflow-6be96612.js";import"./rc-select-564caf01.js";import"./rc-virtual-list-8a7b82a6.js";import"./rc-collapse-11b7d3c4.js";import"./shallowequal-4542d6f7.js";import"./rc-drawer-317f0b4d.js";import"./@rc-component-5a112e55.js";import"./rc-field-form-ef5549aa.js";import"./async-validator-dee29e8b.js";import"./scroll-into-view-if-needed-6b992d05.js";import"./compute-scroll-into-view-183f845a.js";import"./rc-image-e0357917.js";import"./rc-dialog-b1d1f07b.js";import"./rc-input-number-8bc068f7.js";import"./rc-rate-c64cf0d5.js";import"./rc-steps-2d1924c7.js";import"./rc-switch-b4e96de7.js";import"./rc-table-191ecc42.js";import"./rc-checkbox-018e8052.js";import"./rc-tree-67773537.js";import"./rc-tree-select-cb7eccc3.js";import"./copy-to-clipboard-64585c8c.js";import"./toggle-selection-93f4ad84.js";import"./rc-textarea-d01adcbb.js";import"./rc-input-02c2c2ba.js";import"./rc-upload-3ab0f08a.js";import"./rc-notification-d13dc43b.js";import"./rc-progress-4f1a7096.js";import"./rc-tooltip-08fa4217.js";import"./use-sync-external-store-5d1b6592.js";import"./idb-cdd1a92f.js";import"./path-to-regexp-ef8d5544.js";const D="DEBT_MONTH",F="CREATED_MONTH",be=[{id:D,name:n.label.debt_month},{id:F,name:n.label.fee_notification_month}],w={unit:"",service:"",time:[v(),v()],type:D,customerCode:""},R=g.createContext({idBuilding:0,getListAdvancePaymentStatus:{isFetching:!1},setGetListAdvancePaymentStatus:()=>{},serviceInUses:[],getServiceInUses:()=>{},filter:{...w},setFilter:()=>{},tableData:{records:[],totalRecord:0},setTableData:()=>{},tableDataTotalRow:{},setTableDataTotalRow:()=>{},tablePagination:{current:x,limit:E},setTablePagination:()=>{},formFilter:void 0,advancePaymentReportPermissionExport:!1}),B=({children:t})=>{var b;const{idBuilding:d}=ue(),[o,s]=g.useState({isFetching:!1}),[l,r]=g.useState({...w}),[p,e]=g.useState({records:[],totalRecord:0}),[i,a]=g.useState(),[c,h]=g.useState({current:x,limit:E+1}),{serviceInUses:T,getServiceInUses:m}=le(),[f]=pe.useForm(),{getPermissionByModuleCode:y}=Z(),A=((b=y(ee))==null?void 0:b[te])??!1,I={idBuilding:d,getListAdvancePaymentStatus:o,setGetListAdvancePaymentStatus:s,serviceInUses:T,getServiceInUses:m,filter:l,setFilter:r,tableData:p,setTableData:e,tableDataTotalRow:i,setTableDataTotalRow:a,tablePagination:c,setTablePagination:h,formFilter:f,advancePaymentReportPermissionExport:A};return u(R.Provider,{value:I,children:t})};B.propTypes={children:ce.node};B.defaultProps={children:u("div",{})};const ye=B,N=`${oe}/report`,Pe=`${N}/paid-before`,ve=`${N}/paid-before/total`,Ye=`${N}/paid-before/export`;async function Ce({filter:t,idBuilding:d,page:o,limit:s}){return await S({type:H,payload:{apiUrl:Pe,method:L.GET,options:{headers:{[k]:d},params:{...t,page:o,limit:s}}}})}async function _e(t,d){return await S({type:H,payload:{apiUrl:ve,method:L.GET,options:{headers:{[k]:d},params:{...t}}}})}async function Ae(t,d){return await S({type:ae,payload:{apiUrl:Ye,method:L.GET,options:{headers:{[k]:d},params:{...t}}}})}const q=()=>{const{idBuilding:t,setTablePagination:d,setTableData:o,setTableDataTotalRow:s}=g.useContext(R);return[async({filter:r,tablePaginationInp:p,isChangeTotalRow:e})=>{var f;const{time:i,service:a,customerCode:c,unit:h,type:T}=r;d({current:p.current,limit:p.limit});const m=await Ce({filter:{type:T,apartment:h||void 0,serviceId:T===F&&a?a:void 0,labelId:c||void 0,from:i==null?void 0:i[0].format("MM/YYYY"),to:i==null?void 0:i[1].format("MM/YYYY")},idBuilding:t,limit:p.limit-1,page:p.current});if(o({records:(f=m==null?void 0:m.data)==null?void 0:f.units,totalRecord:m.totalRecord}),e){const y=await _e({type:T,apartment:h||void 0,serviceId:T===F&&a?a:void 0,labelId:c||void 0,from:i==null?void 0:i[0].format("MM/YYYY"),to:i==null?void 0:i[1].format("MM/YYYY")},t);s({...y.data})}}]},Ie=()=>{const{setGetListAdvancePaymentStatus:t,setFilter:d,serviceInUses:o,filter:s,formFilter:l}=g.useContext(R),{labelsCustomerCodeData:r}=Q(),[p]=q(),e=async a=>{const c={...a};a.type===D&&(c.service=""),t({isFetching:!0}),d(c),l.setFieldsValue(c),await p({filter:c,isChangeTotalRow:!0,tablePaginationInp:{current:x,limit:E}}),t({isFetching:!1})},i=g.useMemo(()=>[{label:n.unit,key:"unit",component:u(ge,{placeholder:n.unit}),visible:!0},{label:n.month,key:"time",component:u(W.RangePicker,{placeholder:[n.from,n.to],fluid:"true",picker:"month",format:"MM/YYYY",allowClear:!1,getPopupContainer:a=>a.parentNode}),visible:!0,fixed:!0},{label:n.month_type,key:"type",component:u(P,{fluid:"true",placeholder:n.month_type,getPopupContainer:a=>a.parentNode,children:be.map(a=>u(P.Option,{value:a.id,children:a.name},a.id))}),visible:!0,fixed:!0},{label:n.service,key:"service",component:V(P,{disabled:s.type===D,placeholder:n.service,fluid:"true",getPopupContainer:a=>a.parentNode,children:[u(P.Option,{value:"",children:n.all_service},"service_0"),o.map(a=>u(P.Option,{value:a.id,children:a.name},a.id))]}),visible:!0},{label:n.customer_code,key:"customerCode",component:V(P,{fluid:"true",placeholder:n.customer_code,getPopupContainer:a=>a.parentNode,children:[u(P.Option,{value:"",children:n.all_customer_code},"label_0"),r.map(a=>u(P.Option,{value:a.id,children:a.title},a.id))]}),visible:!0}],[r,o,s.type]);return[e,i]},Me=()=>{const t=re(),{tableData:d,filter:o,idBuilding:s,advancePaymentReportPermissionExport:l}=g.useContext(R),[r,p]=g.useState({code:void 0,codeLanguage:void 0,isFetching:!1});me(r.code,r.codeLanguage,{message:n.success,description:n.export_data_success});const e=async()=>{p({code:void 0,codeLanguage:void 0,isFetching:!0});try{const{time:a,service:c,customerCode:h,unit:T,type:m}=o,f=await Ae({type:m,apartment:T||void 0,serviceId:m===F&&c?c:void 0,labelId:h||void 0,from:a==null?void 0:a[0].format("MM/YYYY"),to:a==null?void 0:a[1].format("MM/YYYY")},s);p({code:f.codeLanguage,codeLanguage:f.code,isFetching:!1}),f.data&&fe(f.data,document,"thong-tin-thu-truoc.xlsx")}catch(a){p({code:a.code,codeLanguage:a.codeLanguage,isFetching:!1})}};return[[l?u(Te,{loading:r.isFetching,type:"primary",ghost:!0,icon:u(ie,{name:"icon-download-outlined"}),onClick:()=>{t({action:ne,label:se}),e()},children:n.export},"export"):null].filter(Boolean),d.totalRecord]},O=t=>({...t,openingPaidBefore:(t==null?void 0:t.openingDebt)||0,closingPaidBefore:(t==null?void 0:t.closingDebt)||0,deduct:(t==null?void 0:t.deduct)||0,deposit:(t==null?void 0:t.paidBefore)||0,receivables:(t==null?void 0:t.mustPay)||0,depositRemaining:(t==null?void 0:t.paidRest)||0}),X=t=>de(t,{createdFor:"TOTAL"}),Re=({units:t,total:d})=>{const o=[{key:"collapse",dataIndex:"collapse",title:"",width:30},{title:n.customer_code,dataIndex:"customerCode",key:"customerCode"},{title:n.label.apartment,dataIndex:"apartmentCode",key:"apartmentCode"},{title:n.deposit,align:"right",children:[{title:"1",dataIndex:"deposit",key:"deposit",align:"right",render:r=>u(_.NegativeNumber,{children:r})}]},{title:n.receivables,align:"right",children:[{title:"2",dataIndex:"receivables",key:"receivables",align:"right",render:r=>u(_.NegativeNumber,{children:r})}]},{title:n.deposit_remaining,align:"right",children:[{title:"3=1-2",dataIndex:"depositRemaining",key:"depositRemaining",align:"right",render:r=>u(_.NegativeNumber,{children:r})}]}];return[[{key:"TOTAL",...O(X(d)),apartmentCode:n.label.total1,children:Array.isArray(d)&&d.filter(r=>r.createdFor!=="TOTAL").map(r=>({key:`TOTAL-${r.createdFor}`,...O(r),apartmentCode:v(r.createdFor,"YYYYMM").format("MM/YYYY")}))},...t.map(r=>{var p;return{key:r.id,apartmentCode:r.name,customerCode:((p=r==null?void 0:r.label)==null?void 0:p.title)??"",...O(X(r.rows)),children:Array.isArray(r.rows)&&r.rows.filter(e=>e.createdFor!=="TOTAL").map(e=>({key:`${r.id}-${e.createdFor}`,...O(e),apartmentCode:v(e.createdFor,"YYYYMM").format("MM/YYYY")}))}})],o]},C=(t,d)=>Object.keys(j(t,[d],{})).reduce((o,s)=>o+j(t,[d,s],0),0),M=(t,d,o)=>o.reduce((s,l)=>s+l!=="TOTAL"?C(t==null?void 0:t[l],d):0,0),xe=({units:t,services:d,total:o,months:s})=>{const l=[{key:"collapse",dataIndex:"collapse",title:"",width:60},{title:n.customer_code,dataIndex:"customerCode",key:"customerCode"},{title:n.label.apartment,dataIndex:"apartmentCode",key:"apartmentCode"},{title:n.label.service,dataIndex:"service",key:"service"},{title:n.opening_paid_before,align:"right",children:[{title:"1",dataIndex:"openingPaidBefore",key:"openingPaidBefore",align:"right",render:e=>u(_.NegativeNumber,{children:e})}]},{title:n.deposit_in_period,align:"right",children:[{title:"2",dataIndex:"deposit",key:"deposit",align:"right",render:e=>u(_.NegativeNumber,{children:e})}]},{title:n.deduct_in_period,align:"right",children:[{title:"3",dataIndex:"deduct",key:"deduct",align:"right",render:e=>u(_.NegativeNumber,{children:e})}]},{title:n.closing_paid_before,align:"right",children:[{title:"4=1+2-3",dataIndex:"closingPaidBefore",key:"closingPaidBefore",align:"right",render:(e,i)=>u(_.NegativeNumber,{children:i.openingPaidBefore+i.deposit-i.deduct})}]}];return[[{key:"TOTAL",apartmentCode:n.label.total,children:[...s.map(String)].map(e=>({key:`TOTAL-${e}`,apartmentCode:e==="TOTAL"?n.label.total:v(e,"YYYYMM").format("MM/YYYY"),children:d.map(i=>{var a,c,h,T,m,f;return{key:`TOTAL-${e}-${i.id}`,service:i.name,openingPaidBefore:((c=(a=o==null?void 0:o[e])==null?void 0:a.openingDebt)==null?void 0:c[i.id])??0,deduct:((T=(h=o==null?void 0:o[e])==null?void 0:h.deduct)==null?void 0:T[i.id])??0,deposit:((f=(m=o==null?void 0:o[e])==null?void 0:m.paidBefore)==null?void 0:f[i.id])??0}}),openingPaidBefore:C(o==null?void 0:o[e],"openingDebt"),deduct:C(o==null?void 0:o[e],"deduct"),deposit:C(o==null?void 0:o[e],"paidBefore")})),openingPaidBefore:M(o,"openingDebt",s),deduct:M(o,"deduct",s),deposit:M(o,"paidBefore",s)},...t.map(e=>{var i;return{key:e.id,apartmentCode:e.name,customerCode:((i=e==null?void 0:e.label)==null?void 0:i.title)??"",children:[...s.map(String)].map(a=>{var c,h,T;return{key:`${e.id}-${a}`,apartmentCode:a==="TOTAL"?n.label.total:v(a,"YYYYMM").format("MM/YYYY"),children:d.map(m=>{var f,y,A,I,b,Y,U,$,G;return{key:`${e.id}-${a}-${m.id}`,service:m.name,openingPaidBefore:((A=(y=(f=e==null?void 0:e.rows)==null?void 0:f[a])==null?void 0:y.openingDebt)==null?void 0:A[m.id])??0,deduct:((Y=(b=(I=e==null?void 0:e.rows)==null?void 0:I[a])==null?void 0:b.deduct)==null?void 0:Y[m.id])??0,deposit:((G=($=(U=e==null?void 0:e.rows)==null?void 0:U[a])==null?void 0:$.paidBefore)==null?void 0:G[m.id])??0}}),openingPaidBefore:C((c=e==null?void 0:e.rows)==null?void 0:c[a],"openingDebt"),deduct:C((h=e==null?void 0:e.rows)==null?void 0:h[a],"deduct"),deposit:C((T=e==null?void 0:e.rows)==null?void 0:T[a],"paidBefore")}}),openingPaidBefore:M((e==null?void 0:e.rows)??{},"openingDebt",s),deduct:M((e==null?void 0:e.rows)??{},"deduct",s),deposit:M((e==null?void 0:e.rows)??{},"paidBefore",s)}})],l]},Ee=()=>{const{filter:t,serviceInUses:d,getListAdvancePaymentStatus:o,setGetListAdvancePaymentStatus:s,tableData:l,tablePagination:r,tableDataTotalRow:p}=g.useContext(R),{layoutScrollRef:e}=g.useContext(z),[i]=q(),a=J();g.useEffect(()=>{(async()=>(s({isFetching:!0}),await i({filter:{...w},isChangeTotalRow:!0,tablePaginationInp:{current:x,limit:E}}),s({isFetching:!1})))()},[]);const c=g.useMemo(()=>{let b=[];return t.time&&t.time.length>0&&t.time[0]&&t.time[1]&&(b=he({from:v(t.time[0]),to:v(t.time[1])})),b.unshift("TOTAL"),b},[t]),h=g.useMemo(()=>d.filter(b=>!t.serviceId||t.serviceId&&b.id===t.serviceId),[d,t]),T=async(b,Y)=>{s({isFetching:!0}),r.current!==b?await i({filter:t,isChangeTableDataTotal:!1,tablePaginationInp:{current:b,limit:r.limit}}):r.limit!==Y&&await i({filter:t,isChangeTableDataTotal:!1,tablePaginationInp:{current:r.current,limit:Y}}),s({isFetching:!1})},[m,f]=g.useMemo(()=>{switch(t.type){case D:return Re({units:l.records,total:p});case F:return xe({months:c,units:l.records,total:p,services:h});default:return[]}},[c,h,l,p,t]),y=g.useMemo(()=>({defaultPageSize:E,defaultCurrent:x,pageSize:r.limit,current:r.current,total:l.totalRecord+Math.ceil(l.totalRecord/r.limit),showQuickJumper:!0,showSizeChanger:!0,onChange:T}),[r,l.totalRecord]),A={offsetScroll:a.offsetScrollX,getContainer:()=>e.current},I={x:f.reduce((b,Y)=>Y+b.width,0),scrollToFirstRowOnChange:!0};return[f,m,o.isFetching,y,A,I]},De=()=>{const{setTitlePage:t,setVisibleFilterBox:d,setVisibleSearchBox:o}=g.useContext(z),{getServiceInUses:s,idBuilding:l,formFilter:r}=g.useContext(R),[p,e]=Ie(),[i,a]=Me(),[c,h,T,m,f,y]=Ee();return g.useEffect(()=>(t(n.advance_payment),o(!0),s({idBuilding:l}),()=>{t(""),o(!1),d(!1)}),[]),u(K,{filters:e,onSearch:p,formData:r,defaultFilter:w,total:a,actions:i,columns:c,dataSource:h,loading:T,pagination:m,sticky:f,scroll:y})},ma=()=>u(ye,{children:u(De,{})});export{ma as default};
